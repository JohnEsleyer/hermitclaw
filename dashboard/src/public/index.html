<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HermitShell Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="./calendar-symbols.js"></script>
    <script src="./sites-ui.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;500&display=swap');

        :root {
            --crab-orange: #ff6b35;
            --shell-gray: #1e293b;
            --ocean-dark: #0f172a;
            --term-green: #10b981;
        }

        body {
            background-color: var(--ocean-dark);
            color: #f8fafc;
            font-family: 'Outfit', sans-serif;
            overflow-x: hidden;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .crab-float {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            50% {
                transform: translateY(-10px) rotate(2deg);
            }
        }

        .claw-pinch {
            transform-origin: center;
            transition: transform 0.2s ease;
        }

        .gradient-text {
            background: linear-gradient(135deg, #ff6b35 0%, #f97316 50%, #fbbf24 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 107, 53, 0.1);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            border-color: rgba(255, 107, 53, 0.4);
            box-shadow: 0 10px 30px -10px rgba(255, 107, 53, 0.15);
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(16px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .scanline {
            width: 100%;
            height: 100px;
            z-index: 0;
            background: linear-gradient(0deg, rgba(255, 107, 53, 0) 0%, rgba(255, 107, 53, 0.03) 50%, rgba(255, 107, 53, 0) 100%);
            opacity: 0.1;
            position: fixed;
            bottom: 100%;
            pointer-events: none;
            animation: scanline 8s linear infinite;
        }

        @keyframes scanline {
            0% {
                bottom: 100%;
            }

            100% {
                bottom: -100px;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--ocean-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--crab-orange);
        }

        .terminal-output {
            background-color: #0c0a09;
            background-image: radial-gradient(rgba(30, 41, 59, 0.4) 1px, transparent 0);
            background-size: 20px 20px;
        }

        #xterm-container {
            height: 100%;
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }

        .xterm-viewport::-webkit-scrollbar {
            width: 8px;
        }

        .xterm-viewport::-webkit-scrollbar-track {
            background: #0c0a09;
        }

        .xterm-viewport::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        .agent-avatar {
            width: 42px;
            height: 42px;
            border-radius: 9999px;
            object-fit: cover;
            border: 2px solid rgba(251, 146, 60, .6);
            background: #1e293b;
        }

        .agent-avatar-mini {
            width: 20px;
            height: 20px;
            border-radius: 9999px;
            object-fit: cover;
            border: 1px solid rgba(251, 146, 60, .7);
            background: #1e293b;
        }

        .tele-chat-bg {
            background: radial-gradient(circle at top right, rgba(251, 146, 60, .12), transparent 35%), radial-gradient(circle at bottom left, rgba(14, 165, 233, .08), transparent 35%), #0b1220;
        }

        .chat-bubble-user {
            background: linear-gradient(135deg, rgba(249, 115, 22, .95), rgba(234, 88, 12, .9));
            border-radius: 18px 18px 6px 18px;
        }

        .chat-bubble-agent {
            background: rgba(30, 41, 59, .9);
            border: 1px solid rgba(148, 163, 184, .2);
            border-radius: 18px 18px 18px 6px;
        }


        .dashboard-shell {
            display: grid;
            grid-template-columns: 18rem minmax(0, 1fr);
            width: 100%;
            height: 100%;
            position: relative;
        }

        .dashboard-sidebar {
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .dashboard-main {
            min-width: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .dashboard-topbar {
            border-bottom: 1px solid rgba(148, 163, 184, 0.12);
            background: rgba(15, 23, 42, 0.72);
            backdrop-filter: blur(16px);
        }

        .dashboard-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .dashboard-content-inner {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .mobile-nav {
            display: none;
            gap: .65rem;
            overflow-x: auto;
            padding-bottom: .15rem;
        }

        .mobile-nav .nav-item {
            white-space: nowrap;
            padding: .6rem .95rem;
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 999px;
            font-size: .8rem;
            line-height: 1;
            background: rgba(15, 23, 42, 0.55);
        }

        .desktop-nav .nav-item {
            border: 1px solid transparent;
        }

        @media (max-width: 1100px) {
            .dashboard-shell {
                grid-template-columns: 1fr;
            }

            .dashboard-sidebar {
                display: none;
            }

            .mobile-nav {
                display: flex;
            }

            .dashboard-content {
                padding: 1rem;
            }
        }
    </style>
</head>

<body class="h-screen flex text-slate-200">

    <div class="scanline"></div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900 p-4 overflow-hidden">
        <div
            class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-orange-500/5 rounded-full blur-3xl pointer-events-none">
        </div>

        <div class="glass-card p-8 rounded-2xl w-full max-w-md shadow-2xl relative overflow-hidden">
            <div class="mb-8 text-center">
                <div class="relative w-32 h-32 mx-auto mb-6">
                    <svg id="auth-mascot" viewBox="0 0 100 100"
                        class="w-full h-full drop-shadow-[0_0_20px_rgba(255,107,53,0.5)] crab-float">
                        <defs>
                            <radialGradient id="authCrabBg" cx="50%" cy="50%" r="55%">
                                <stop offset="0%" style="stop-color:#1e293b" />
                                <stop offset="100%" style="stop-color:#0f172a" />
                            </radialGradient>
                        </defs>
                        <circle cx="50" cy="50" r="46" fill="url(#authCrabBg)" stroke="#fb923c" stroke-width="2"
                            opacity="0.95" />
                        <path
                            d="M50 20C30 20 20 35 20 50C20 65 30 80 50 80C70 80 80 65 80 50C80 35 70 20 50 20ZM35 45C37.7 45 40 47.3 40 50C40 52.7 37.7 55 35 55C32.3 55 30 52.7 30 50C30 47.3 32.3 45 35 45ZM65 45C67.7 45 70 47.3 70 50C70 52.7 67.7 55 65 55C62.3 55 60 52.7 60 50C60 47.3 62.3 45 65 45Z"
                            fill="#ff6b35" />
                        <path d="M15 30L25 40M10 50L25 50M15 70L25 60M85 30L75 40M90 50L75 50M85 70L75 60"
                            stroke="#ff6b35" stroke-width="5" stroke-linecap="round" />
                    </svg>
                </div>
                <h1 class="text-3xl font-bold tracking-tight text-white mb-2 gradient-text">HermitShell</h1>
                <p id="auth-title" class="text-orange-500 font-mono text-sm">SECURE_SHELL_ACCESS</p>
            </div>

            <form id="auth-form" class="space-y-4" onsubmit="handleAuth(event)">
                <div id="default-login-hint"
                    class="hidden bg-orange-500/10 border border-orange-500/30 rounded-lg p-3 text-xs text-orange-300 mb-2">
                    <div class="flex items-center gap-2 mb-1">
                        <i data-lucide="info" class="w-4 h-4"></i>
                        <strong>Default Credentials Active</strong>
                    </div>
                    Please login with the default credentials below, then change your password in Settings for security.
                </div>
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">USERNAME</label>
                    <input type="text" id="username"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 focus:border-orange-500 outline-none transition-colors text-white"
                        required autocomplete="off" placeholder="admin">
                </div>
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">PASSWORD</label>
                    <input type="password" id="password"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 focus:border-orange-500 outline-none transition-colors text-white"
                        required placeholder="••••••••">
                </div>

                <div id="auth-error" class="text-red-400 text-xs font-mono hidden text-center"></div>

                <button type="submit" id="auth-btn"
                    class="w-full bg-orange-600 hover:bg-orange-500 text-white py-3 rounded-lg font-bold transition-all shadow-lg shadow-orange-900/20">
                    Authenticate
                </button>

                <div id="default-creds-display"
                    class="hidden text-center mt-4 p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                    <p class="text-xs text-slate-400 mb-2">Default credentials:</p>
                    <div class="flex items-center justify-center gap-2">
                        <span class="font-mono text-orange-400 bg-slate-900 px-2 py-1 rounded text-sm">admin</span>
                        <span class="text-slate-500">/</span>
                        <span class="font-mono text-orange-400 bg-slate-900 px-2 py-1 rounded text-sm">crab123</span>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-ui" class="hidden dashboard-shell">
        <aside class="dashboard-sidebar glass-panel dashboard-sidebar flex-col z-20 hidden xl:flex">
            <div class="p-6 flex items-center space-x-3 border-b border-white/5">
                <svg viewBox="0 0 100 100" class="w-9 h-9 fill-orange-500 shrink-0">
                    <path
                        d="M50 20C30 20 20 35 20 50C20 65 30 80 50 80C70 80 80 65 80 50C80 35 70 20 50 20ZM35 45C37.7 45 40 47.3 40 50C40 52.7 37.7 55 35 55C32.3 55 30 52.7 30 50C30 47.3 32.3 45 35 45ZM65 45C67.7 45 70 47.3 70 50C70 52.7 67.7 55 65 55C62.3 55 60 52.7 60 50C60 47.3 62.3 45 65 45Z" />
                    <path d="M15 30L25 40M10 50L25 50M15 70L25 60M85 30L75 40M90 50L75 50M85 70L75 60" stroke="#ff6b35"
                        stroke-width="5" stroke-linecap="round" />
                </svg>
                <div>
                    <h1 class="font-bold tracking-tight text-lg text-white">HermitShell</h1>
                    <p class="text-[11px] text-slate-400 mono">CONTROL PANEL</p>
                </div>
            </div>

            <nav class="desktop-nav flex-1 p-4 space-y-2">
                <a href="#" data-section="agents" onclick="showSection('agents')"
                    class="nav-item flex items-center space-x-3 px-4 py-3 bg-orange-500/10 text-orange-400 border border-orange-500/20 rounded-xl">
                    <i data-lucide="grid" class="w-5 h-5"></i><span class="font-semibold">Agents</span>
                </a>
                <a href="#" data-section="cubicles" onclick="showSection('cubicles')"
                    class="nav-item flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors"><i
                        data-lucide="box" class="w-5 h-5"></i><span>Cubicles</span></a>
                <a href="#" data-section="sites" onclick="showSection('sites')"
                    class="nav-item flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors"><i
                        data-lucide="globe" class="w-5 h-5"></i><span>Apps</span></a>
                <a href="#" data-section="files" onclick="showSection('files')"
                    class="nav-item flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors"><i
                        data-lucide="folder-open" class="w-5 h-5"></i><span>Files</span></a>
                <a href="#" data-section="calendars" onclick="showSection('calendars')"
                    class="nav-item flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors"><i
                        data-lucide="calendar-days" class="w-5 h-5"></i><span>Calendars</span></a>
                <a href="#" data-section="audit" onclick="showSection('audit')"
                    class="nav-item flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors"><i
                        data-lucide="file-text" class="w-5 h-5"></i><span>Audit Logs</span></a>
                <a href="#" data-section="metrics" onclick="showSection('metrics')"
                    class="nav-item flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors"><i
                        data-lucide="bar-chart-2" class="w-5 h-5"></i><span>Metrics</span></a>
                <a href="#" data-section="allowlist" onclick="showSection('allowlist')"
                    class="nav-item flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors"><i
                        data-lucide="users" class="w-5 h-5"></i><span>Allowlist</span></a>
                <a href="#" data-section="memories" onclick="showSection('memories')"
                    class="nav-item flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors"><i
                        data-lucide="brain" class="w-5 h-5"></i><span>Memories (RAG)</span></a>
                <a href="#" data-section="settings" onclick="showSection('settings')"
                    class="nav-item flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors"><i
                        data-lucide="settings" class="w-5 h-5"></i><span>Settings</span></a>
            </nav>

            <div class="p-6">
                <button onclick="logout()"
                    class="w-full flex items-center justify-center gap-2 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors border border-slate-700/50">
                    <i data-lucide="log-out" class="w-5 h-5"></i><span>Logout</span>
                </button>
            </div>
        </aside>

        <main class="dashboard-main relative z-10 overflow-hidden">
            <div id="default-creds-warning"
                class="hidden bg-red-900/40 border-b border-red-500/50 text-red-200 px-6 py-3 flex justify-between items-center text-sm shadow-md">
                <div class="flex items-center gap-3">
                    <div class="p-1.5 bg-red-500/20 rounded-lg"><i data-lucide="alert-triangle"
                            class="w-4 h-4 text-red-500"></i></div><span><strong>SECURITY WARNING:</strong> You are
                        using default admin credentials. Please change your password in Settings.</span>
                </div>
                <button onclick="showSection('settings')"
                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-1.5 rounded text-xs font-bold transition-all shadow-lg shadow-red-500/20 flex items-center gap-2">Change
                    Password <i data-lucide="arrow-right" class="w-3 h-3"></i></button>
            </div>

            <header class="dashboard-topbar px-4 md:px-8 py-5">
                <div class="dashboard-content-inner flex flex-col gap-4">
                    <div class="flex flex-wrap items-start justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-white" id="page-title">Mission Control</h2>
                            <p class="text-xs text-slate-400 mono mt-1">SYSTEM_STATUS: <span
                                    class="text-green-400">SECURE</span></p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="syncWebhooks(event)"
                                class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold transition-all shadow-lg shadow-blue-900/20 flex items-center gap-2"
                                title="Reconnect bots to Telegram"><i data-lucide="refresh-cw" class="w-4 h-4"></i><span
                                    class="hidden sm:inline">Sync Bots</span></button>
                            <button onclick="openModal()"
                                class="bg-orange-600 hover:bg-orange-500 text-white px-5 py-2 rounded-lg font-bold transition-all shadow-lg shadow-orange-900/20 flex items-center gap-2"><i
                                    data-lucide="plus-circle" class="w-4 h-4"></i><span>Spawn Agent</span></button>
                        </div>
                    </div>
                    <nav class="mobile-nav">
                        <a href="#" data-section="agents" onclick="showSection('agents')"
                            class="nav-item bg-orange-500/10 text-orange-400 border-orange-500/20"><i data-lucide="grid"
                                class="w-4 h-4 inline mr-1"></i>Agents</a>
                        <a href="#" data-section="cubicles" onclick="showSection('cubicles')"
                            class="nav-item text-slate-300"><i data-lucide="box"
                                class="w-4 h-4 inline mr-1"></i>Cubicles</a>
                        <a href="#" data-section="sites" onclick="showSection('sites')"
                            class="nav-item text-slate-300"><i data-lucide="globe"
                                class="w-4 h-4 inline mr-1"></i>Apps</a>
                        <a href="#" data-section="files" onclick="showSection('files')"
                            class="nav-item text-slate-300"><i data-lucide="folder-open"
                                class="w-4 h-4 inline mr-1"></i>Files</a>
                        <a href="#" data-section="calendars" onclick="showSection('calendars')"
                            class="nav-item text-slate-300"><i data-lucide="calendar-days"
                                class="w-4 h-4 inline mr-1"></i>Calendars</a>
                        <a href="#" data-section="audit" onclick="showSection('audit')"
                            class="nav-item text-slate-300"><i data-lucide="file-text"
                                class="w-4 h-4 inline mr-1"></i>Audit</a>
                        <a href="#" data-section="metrics" onclick="showSection('metrics')"
                            class="nav-item text-slate-300"><i data-lucide="bar-chart-2"
                                class="w-4 h-4 inline mr-1"></i>Metrics</a>
                        <a href="#" data-section="allowlist" onclick="showSection('allowlist')"
                            class="nav-item text-slate-300"><i data-lucide="users"
                                class="w-4 h-4 inline mr-1"></i>Allowlist</a>
                        <a href="#" data-section="memories" onclick="showSection('memories')"
                            class="nav-item text-slate-300"><i data-lucide="brain"
                                class="w-4 h-4 inline mr-1"></i>Memories</a>
                        <a href="#" data-section="settings" onclick="showSection('settings')"
                            class="nav-item text-slate-300"><i data-lucide="settings"
                                class="w-4 h-4 inline mr-1"></i>Settings</a>
                    </nav>
                </div>
            </header>

            <div class="dashboard-content">
                <div class="dashboard-content-inner">

                    <!-- Agents Section -->
                    <div id="section-agents">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
                            <div class="glass-card p-5 rounded-2xl">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="p-2 bg-orange-500/10 rounded-lg text-orange-500"><i data-lucide="cpu"
                                            class="w-5 h-5"></i></div>
                                    <span class="text-xs font-mono text-slate-500">DOCKER</span>
                                </div>
                                <div class="text-2xl font-bold text-white" id="stat-containers">0</div>
                                <div class="text-xs text-slate-400 mt-1">Active Cubicles</div>
                            </div>

                            <div class="glass-card p-5 rounded-2xl">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="p-2 bg-blue-500/10 rounded-lg text-blue-500"><i data-lucide="bot"
                                            class="w-5 h-5"></i></div>
                                    <span class="text-xs font-mono text-slate-500">AGENTS</span>
                                </div>
                                <div class="text-2xl font-bold text-white" id="stat-agents">0</div>
                                <div class="text-xs text-slate-400 mt-1">Registered Identities</div>
                            </div>

                            <div class="glass-card p-5 rounded-2xl">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="p-2 bg-green-500/10 rounded-lg text-green-500"><i
                                            data-lucide="dollar-sign" class="w-5 h-5"></i></div>
                                    <span class="text-xs font-mono text-slate-500">SPEND (24H)</span>
                                </div>
                                <div class="text-2xl font-bold text-white" id="stat-spend">$0.00</div>
                                <div class="text-xs text-slate-400 mt-1">Total Compute Cost</div>
                            </div>

                            <div class="glass-card p-5 rounded-2xl">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="p-2 bg-purple-500/10 rounded-lg text-purple-500"><i data-lucide="shield"
                                            class="w-5 h-5"></i></div>
                                    <span class="text-xs font-mono text-slate-500">SECURITY</span>
                                </div>
                                <div class="text-xl font-bold text-white">Secure</div>
                                <div class="text-xs text-slate-400 mt-1">Containers Isolated</div>
                            </div>
                        </div>

                        <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <i data-lucide="grid" class="w-5 h-5 text-orange-500"></i>
                            Deployed Agents
                        </h3>

                        <div id="agent-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>


                        <div class="glass-card p-5 rounded-2xl mt-8">
                            <div class="flex items-center justify-between gap-3 mb-3">
                                <h4 class="text-white font-bold">Agent Logs</h4>
                                <span class="text-xs text-slate-400">Runtime log stream across all agents.</span>
                            </div>
                            <button onclick="loadRuntimeLogs()"
                                class="bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg text-sm">Refresh
                                Agent Logs</button>
                            <div id="chat-output"
                                class="mt-3 text-sm text-slate-300 whitespace-pre-wrap bg-slate-900/60 border border-slate-700 rounded-lg p-3 min-h-[72px]">
                                No runtime logs yet.</div>
                        </div>
                    </div>

                    <!-- Cubicles Section -->
                    <div id="section-cubicles" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                <i data-lucide="box" class="w-5 h-5 text-orange-500"></i>
                                Running Cubicles
                            </h3>
                            <button onclick="loadCubicles()"
                                class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg font-medium transition-all text-sm flex items-center gap-2 border border-slate-700">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                Refresh
                            </button>
                        </div>

                        <div class="glass-card rounded-2xl overflow-hidden">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-800/50 text-slate-400">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-mono">CONTAINER ID</th>
                                        <th class="px-4 py-3 text-left font-mono">IMAGE</th>
                                        <th class="px-4 py-3 text-left font-mono">STATUS</th>
                                        <th class="px-4 py-3 text-left font-mono">CREATED</th>
                                        <th class="px-4 py-3 text-left font-mono">ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody id="cubicles-tbody" class="divide-y divide-slate-800">
                                </tbody>
                            </table>
                            <div id="cubicles-empty" class="p-8 text-center text-slate-500 hidden">
                                <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 text-slate-600"></i>
                                <p>No running cubicles. Spawn an agent to create a cubicle.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Apps Section -->
                    <div id="section-sites" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                <i data-lucide="globe" class="w-5 h-5 text-orange-500"></i>
                                Apps (Workspace Web Apps)
                            </h3>
                            <div class="flex items-center gap-2">
                                <button onclick="loadSites()"
                                    class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg font-medium transition-all text-sm flex items-center gap-2 border border-slate-700">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    Scan
                                </button>
                            </div>
                        </div>
                        <div class="glass-card p-5 rounded-2xl mb-5 text-sm text-slate-300">
                            <p class="mb-2">HermitShell scans each workspace <span
                                    class="mono text-orange-300">www/</span> folder and lists detected web apps. Each subfolder in www/ is treated as a separate web app.</p>
                            <p class="text-xs text-slate-400">Web apps are created with vanilla HTML/CSS/JS. Click "View" to open a modal with the site, or "Share" to generate a temporary tunnel link for Telegram.</p>
                        </div>
                        <div id="sites-grid" class="glass-card p-4 rounded-2xl"></div>
                    </div>

                    <!-- Site Preview Modal -->
                    <div id="site-preview-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
                        <div class="bg-slate-900 border border-slate-700 w-full max-w-6xl h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
                            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                                <div class="flex items-center gap-3">
                                    <h3 id="site-preview-title" class="text-lg font-bold text-white">Site Preview</h3>
                                    <span id="site-preview-badge" class="text-xs px-2 py-1 rounded bg-slate-700 text-slate-300">Inactive</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="shareSiteTunnel()"
                                        class="bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded-lg text-sm flex items-center gap-2">
                                        <i data-lucide="share-2" class="w-4 h-4"></i>
                                        Share Link
                                    </button>
                                    <button onclick="closeSitePreview()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                                </div>
                            </div>
                            <div class="flex-1 flex overflow-hidden">
                                <div class="w-64 border-r border-slate-700 bg-slate-800/30 p-4 overflow-y-auto">
                                    <h4 class="text-sm font-bold text-slate-300 mb-3">Web Apps</h4>
                                    <div id="site-apps-list" class="space-y-2"></div>
                                </div>
                                <div class="flex-1 bg-white">
                                    <iframe id="site-preview-frame" class="w-full h-full" src=""></iframe>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Files Section -->
                    <div id="section-files" class="hidden">
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <i data-lucide="folder-open" class="w-5 h-5 text-orange-500"></i>
                            Files & Workspace Browser
                        </h3>
                        <div class="glass-card p-5 rounded-2xl mb-5">
                            <div class="grid md:grid-cols-5 gap-3">
                                <select id="files-agent"
                                    class="bg-slate-800 border border-slate-700 rounded-lg p-3 text-white"></select>
                                <select id="files-user"
                                    class="bg-slate-800 border border-slate-700 rounded-lg p-3 text-white"></select>
                                <button onclick="loadWorkspaceFiles()"
                                    class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-lg font-semibold">Load
                                    Workspace</button>
                                <button onclick="downloadWorkspaceArchive()"
                                    class="bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg">Download
                                    .tar.gz</button>
                                <input type="file" id="workspace-upload"
                                    class="text-xs text-slate-300 bg-slate-900/50 border border-slate-700 rounded-lg p-2"
                                    onchange="uploadWorkspaceFile(event)">
                            </div>
                            <p class="text-xs text-slate-400 mt-3">This makes it easier to review what an agent created
                                before forwarding outputs in Telegram.</p>
                        </div>
                        <div id="files-browser" class="glass-card rounded-2xl p-5 text-sm text-slate-300">
                            Select an agent and user, then click <strong>Load Workspace</strong>.
                        </div>
                    </div>

                    <!-- Calendars Section -->
                    <div id="section-calendars" class="hidden">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                <i data-lucide="calendar-days" class="w-5 h-5 text-orange-500"></i>
                                Agent Calendars
                            </h3>
                            <div class="flex items-center gap-2">
                                <button onclick="shiftCalendarMonth(-1)"
                                    class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-2 rounded-lg border border-slate-700 text-sm">
                                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                                </button>
                                <div id="calendar-month-label" class="text-sm text-slate-300 min-w-[150px] text-center">
                                    Month</div>
                                <button onclick="shiftCalendarMonth(1)"
                                    class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-2 rounded-lg border border-slate-700 text-sm">
                                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                </button>
                                <button onclick="loadCalendarsSection()"
                                    class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg font-medium transition-all text-sm flex items-center gap-2 border border-slate-700"><i
                                        data-lucide="refresh-cw" class="w-4 h-4"></i>Refresh</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 xl:grid-cols-3 gap-5 mb-5">
                            <div class="xl:col-span-2 glass-card p-4 rounded-2xl">
                                <div class="grid grid-cols-7 gap-2 text-xs text-slate-400 mb-2 font-mono text-center">
                                    <div>SUN</div>
                                    <div>MON</div>
                                    <div>TUE</div>
                                    <div>WED</div>
                                    <div>THU</div>
                                    <div>FRI</div>
                                    <div>SAT</div>
                                </div>
                                <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
                            </div>

                            <div class="glass-card p-4 rounded-2xl">
                                <h4 class="text-sm font-bold text-white mb-3">Create Event</h4>
                                <div class="space-y-3">
                                    <select id="calendar-agent"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white"
                                        onchange="loadCalendarEvents()"></select>
                                    <select id="calendar-user"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white"></select>
                                    <input id="calendar-title"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white"
                                        placeholder="Event title">
                                    <div class="grid grid-cols-2 gap-2">
                                        <input id="calendar-color" type="color"
                                            class="w-full h-11 bg-slate-800 border border-slate-700 rounded-lg p-1">
                                        <select id="calendar-symbol"
                                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white"></select>
                                    </div>
                                    <input id="calendar-start" type="datetime-local"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white">
                                    <input id="calendar-end" type="datetime-local"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white">
                                    <textarea id="calendar-prompt" rows="4"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white"
                                        placeholder="Prompt/event instructions for the agent..."></textarea>
                                    <button onclick="createCalendarEvent()"
                                        class="w-full bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-lg font-semibold">Add
                                        Event</button>
                                </div>
                                <p class="text-xs text-slate-400 mt-3">Events run automatically and notify Telegram on
                                    start + completion.</p>
                            </div>
                        </div>

                        <div>
                            <h4 id="calendar-selected-date" class="text-sm font-bold text-white mb-3">Selected day
                                events</h4>
                            <div id="calendar-events" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
                            </div>
                        </div>
                    </div>

                    <!-- Audit Logs Section -->
                    <div id="section-audit" class="hidden">
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <i data-lucide="file-text" class="w-5 h-5 text-orange-500"></i>
                            Audit Logs
                        </h3>

                        <div class="glass-card p-4 rounded-2xl mb-4">
                            <div class="flex flex-wrap gap-3">
                                <select id="audit-agent-filter" onchange="loadAuditLogs()" class="bg-slate-800 border border-slate-700 rounded-lg p-2 text-white text-sm">
                                    <option value="">All Agents</option>
                                </select>
                                <select id="audit-status-filter" onchange="loadAuditLogs()" class="bg-slate-800 border border-slate-700 rounded-lg p-2 text-white text-sm">
                                    <option value="">All Status</option>
                                    <option value="approved">Approved</option>
                                    <option value="pending">Pending</option>
                                    <option value="denied">Denied</option>
                                    <option value="error">Error</option>
                                </select>
                                <input type="text" id="audit-search" oninput="loadAuditLogs()" placeholder="Search commands..." class="bg-slate-800 border border-slate-700 rounded-lg p-2 text-white text-sm flex-1">
                            </div>
                        </div>

                        <div class="glass-card rounded-2xl overflow-hidden">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-800/50 text-slate-400">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-mono">TIMESTAMP</th>
                                        <th class="px-4 py-3 text-left font-mono">AGENT</th>
                                        <th class="px-4 py-3 text-left font-mono">ACTION TYPE</th>
                                        <th class="px-4 py-3 text-left font-mono">COMMAND</th>
                                        <th class="px-4 py-3 text-left font-mono">STATUS</th>
                                        <th class="px-4 py-3 text-left font-mono">RESPONSE</th>
                                        <th class="px-4 py-3 text-left font-mono">ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody id="audit-tbody" class="divide-y divide-slate-800">
                                </tbody>
                            </table>
                            <div id="audit-empty" class="p-8 text-center text-slate-500 hidden">
                                No audit logs yet. Commands requiring approval will appear here.
                            </div>
                        </div>
                    </div>

                    <!-- Metrics Section -->
                    <div id="section-metrics" class="hidden">
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <i data-lucide="bar-chart-2" class="w-5 h-5 text-orange-500"></i>
                            System Metrics
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="glass-card p-5 rounded-2xl">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="p-2 bg-green-500/10 rounded-lg text-green-500"><i data-lucide="server"
                                            class="w-5 h-5"></i></div>
                                    <span class="text-xs font-mono text-slate-500">DOCKER</span>
                                </div>
                                <div class="text-2xl font-bold text-white" id="metric-containers">0</div>
                                <div class="text-xs text-slate-400 mt-1">Running Containers</div>
                            </div>

                            <div class="glass-card p-5 rounded-2xl">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="p-2 bg-blue-500/10 rounded-lg text-blue-500"><i data-lucide="bot"
                                            class="w-5 h-5"></i></div>
                                    <span class="text-xs font-mono text-slate-500">AGENTS</span>
                                </div>
                                <div class="text-2xl font-bold text-white" id="metric-agents">0</div>
                                <div class="text-xs text-slate-400 mt-1">Total Agents</div>
                            </div>

                            <div class="glass-card p-5 rounded-2xl">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="p-2 bg-orange-500/10 rounded-lg text-orange-500"><i
                                            data-lucide="dollar-sign" class="w-5 h-5"></i></div>
                                    <span class="text-xs font-mono text-slate-500">SPEND</span>
                                </div>
                                <div class="text-2xl font-bold text-white" id="metric-spend">$0.00</div>
                                <div class="text-xs text-slate-400 mt-1">Today's Spend</div>
                            </div>

                            <div class="glass-card p-5 rounded-2xl">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="p-2 bg-purple-500/10 rounded-lg text-purple-500"><i data-lucide="shield"
                                            class="w-5 h-5"></i></div>
                                    <span class="text-xs font-mono text-slate-500">ALLOWLIST</span>
                                </div>
                                <div class="text-2xl font-bold text-white" id="metric-allowlist">0</div>
                                <div class="text-xs text-slate-400 mt-1">Allowed Users</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="glass-card p-4 rounded-xl">
                                <div class="text-xs text-slate-400">Audit Approved</div>
                                <div id="metric-audit-approved" class="text-xl font-bold text-green-400">0</div>
                            </div>
                            <div class="glass-card p-4 rounded-xl">
                                <div class="text-xs text-slate-400">Audit Pending</div>
                                <div id="metric-audit-pending" class="text-xl font-bold text-yellow-400">0</div>
                            </div>
                            <div class="glass-card p-4 rounded-xl">
                                <div class="text-xs text-slate-400">Runtime Errors</div>
                                <div id="metric-runtime-errors" class="text-xl font-bold text-red-400">0</div>
                            </div>
                        </div>

                        <div class="glass-card p-6 rounded-2xl">
                            <h4 class="text-white font-bold mb-4">API Keys Status</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="flex items-center justify-between bg-slate-800 p-4 rounded-lg">
                                    <span class="text-slate-300">OpenAI API Key</span>
                                    <span id="metric-openai"
                                        class="text-xs font-mono px-2 py-1 rounded bg-red-500/20 text-red-400">Not
                                        Set</span>
                                </div>
                                <div class="flex items-center justify-between bg-slate-800 p-4 rounded-lg">
                                    <span class="text-slate-300">OpenRouter API Key</span>
                                    <span id="metric-openrouter"
                                        class="text-xs font-mono px-2 py-1 rounded bg-red-500/20 text-red-400">Not
                                        Set</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Allowlist Section -->
                    <div id="section-allowlist" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                <i data-lucide="users" class="w-5 h-5 text-orange-500"></i>
                                User Allowlist
                            </h3>
                            <button onclick="openAllowlistModal()"
                                class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-lg font-bold transition-all text-sm flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Add User
                            </button>
                        </div>

                        <div class="glass-card rounded-2xl overflow-hidden">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-800/50 text-slate-400">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-mono">USER ID</th>
                                        <th class="px-4 py-3 text-left font-mono">USERNAME</th>
                                        <th class="px-4 py-3 text-left font-mono">FIRST NAME</th>
                                        <th class="px-4 py-3 text-left font-mono">ADDED</th>
                                        <th class="px-4 py-3 text-left font-mono">ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody id="allowlist-tbody" class="divide-y divide-slate-800">
                                </tbody>
                            </table>
                            <div id="allowlist-empty" class="p-8 text-center text-slate-500 hidden">
                                No users in allowlist yet. Add users to control who can access your agents.
                            </div>
                        </div>
                    </div>

                    <!-- Memories Section -->
                    <div id="section-memories" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                <i data-lucide="brain" class="w-5 h-5 text-orange-500"></i>
                                Agent Memories
                            </h3>
                        </div>
                        <div class="glass-card p-5 rounded-2xl mb-5 text-sm text-slate-300">
                            <p>Store persistent facts, rules, and preferences for your agents here. When a user
                                interacts
                                with an agent, relevant memories will be automatically injected into the system prompt.
                            </p>
                        </div>

                        <div class="glass-card p-6 rounded-2xl mb-6">
                            <div class="flex items-center gap-3 w-full mb-4">
                                <label class="text-sm font-bold text-slate-300">Select Agent:</label>
                                <select id="memory-agent-select"
                                    class="flex-1 bg-slate-800 border border-slate-700 rounded-lg p-2 text-white"
                                    onchange="loadAgentMemories()">
                                    <option value="">Select an agent...</option>
                                </select>
                                <label class="text-sm font-bold text-slate-300">User:</label>
                                <select id="memory-user-select"
                                    class="w-40 bg-slate-800 border border-slate-700 rounded-lg p-2 text-white"
                                    onchange="loadAgentMemories()">
                                    <option value="0">User 0</option>
                                </select>
                            </div>

                            <div class="w-full flex flex-wrap gap-3 mb-6">
                                <input type="text" id="new-memory-input"
                                    class="flex-1 bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 outline-none min-w-[300px]"
                                    placeholder="Enter a new fact or rule...">
                                <div class="flex gap-2">
                                    <button onclick="addAgentMemory()"
                                        class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 whitespace-nowrap">
                                        <i data-lucide="plus" class="w-4 h-4"></i> Add Memory
                                    </button>
                                    <button onclick="clearAgentMemories()"
                                        class="bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/30 px-4 py-2 rounded-lg font-bold flex items-center gap-2 whitespace-nowrap">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i> Clear All
                                    </button>
                                </div>
                            </div>

                            <div class="rounded-xl overflow-hidden border border-slate-700">
                                <table class="w-full text-sm">
                                    <thead class="bg-slate-800/80 text-slate-400">
                                        <tr>
                                            <th class="px-4 py-3 text-left font-mono">MEMORY THOUGHT (FACT/RULE)</th>
                                            <th class="px-4 py-3 text-right font-mono">ACTIONS</th>
                                        </tr>
                                    </thead>
                                    <tbody id="memories-tbody" class="divide-y divide-slate-800/80">
                                    </tbody>
                                </table>
                                <div id="memories-empty" class="p-8 text-center text-slate-500 hidden">
                                    <i data-lucide="brain" class="w-8 h-8 mx-auto mb-2 opacity-30"></i>
                                    No memories stored for this agent yet.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Section -->
                    <div id="section-settings" class="hidden">
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <i data-lucide="settings" class="w-5 h-5 text-orange-500"></i>
                            Settings
                        </h3>

                        <!-- Admin Credentials Settings -->
                        <div class="glass-card p-6 rounded-2xl mb-6" id="admin-creds-card">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="p-2 bg-red-500/10 rounded-lg text-red-500"><i data-lucide="shield-alert"
                                        class="w-5 h-5"></i></div>
                                <h4 class="text-lg font-bold text-white">Admin Credentials</h4>
                            </div>
                            <div id="settings-creds-warning"
                                class="hidden bg-red-500/10 border border-red-500/20 rounded-lg p-3 mb-4">
                                <p class="text-sm text-red-300 flex items-center gap-2">
                                    <i data-lucide="alert-circle" class="w-4 h-4"></i>
                                    <strong>Action Required:</strong> You are using default credentials. Please change
                                    your
                                    username and password immediately.
                                </p>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-mono text-slate-400 mb-2">NEW USERNAME</label>
                                    <input type="text" id="setting-admin-username"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                                        placeholder="Enter new username">
                                </div>
                                <div>
                                    <label class="block text-xs font-mono text-slate-400 mb-2">NEW PASSWORD</label>
                                    <input type="password" id="setting-admin-password"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                                        placeholder="Enter new password">
                                </div>
                                <button onclick="changeAdminCredentials()"
                                    class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg font-bold transition-all text-sm flex items-center gap-2 shadow-lg shadow-red-900/20">
                                    <i data-lucide="save" class="w-4 h-4"></i> Update Credentials
                                </button>
                            </div>
                        </div>

                        <!-- Operator Settings -->
                        <div class="glass-card p-6 rounded-2xl mb-6">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="p-2 bg-orange-500/10 rounded-lg text-orange-500"><i data-lucide="shield"
                                        class="w-5 h-5"></i></div>
                                <h4 class="text-lg font-bold text-white">Operator (Primary Admin)</h4>
                            </div>
                            <div class="bg-orange-500/10 border border-orange-500/20 rounded-lg p-3 mb-4">
                                <p class="text-xs text-orange-300">The Operator receives all verification codes, HITL
                                    approval requests, and delegation requests. Set this to your Telegram User ID.</p>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <label class="text-xs font-mono text-slate-400">OPERATOR TELEGRAM ID</label>
                                        <button
                                            onclick="alert('Send /start to @userinfobot on Telegram to get your User ID')"
                                            class="text-slate-400 hover:text-orange-500 transition-colors"
                                            title="How to find my ID?">
                                            <i data-lucide="help-circle" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                    <input type="text" id="setting-operator_telegram_id"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                                        placeholder="e.g., 123456789">
                                    <p class="text-xs text-slate-500 mt-1">Required for agent verification and HITL
                                        approvals</p>
                                </div>
                            </div>
                        </div>

                        <!-- General Settings -->
                        <div class="glass-card p-6 rounded-2xl mb-6">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="p-2 bg-blue-500/10 rounded-lg text-blue-500"><i data-lucide="globe"
                                        class="w-5 h-5"></i></div>
                                <h4 class="text-lg font-bold text-white">General</h4>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <label class="text-xs font-mono text-slate-400">PUBLIC_URL</label>
                                        <button onclick="openPublicUrlGuide()"
                                            class="text-slate-400 hover:text-orange-500 transition-colors"
                                            title="Why do I need this?">
                                            <i data-lucide="help-circle" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                    <input type="url" id="setting-public_url"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                                        placeholder="https://your-domain.com">
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="setting-hitl_enabled"
                                        class="w-4 h-4 rounded border-slate-600 bg-slate-800 text-orange-500 focus:ring-orange-500">
                                    <label for="setting-hitl_enabled" class="text-sm text-slate-300">Enable
                                        Human-in-the-Loop (HITL) by default</label>
                                </div>
                                <div>
                                    <label class="block text-xs font-mono text-slate-400 mb-2">DEFAULT_DAILY_LIMIT
                                        (USD)</label>
                                    <input type="number" step="0.01" id="setting-default_daily_limit"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                                        placeholder="1.00">
                                </div>
                            </div>
                        </div>

                        <!-- LLM Provider Settings -->
                        <div class="glass-card p-6 rounded-2xl mb-6">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="p-2 bg-purple-500/10 rounded-lg text-purple-500"><i data-lucide="cpu"
                                        class="w-5 h-5"></i></div>
                                <h4 class="text-lg font-bold text-white">LLM Provider</h4>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-mono text-slate-400 mb-2">PROVIDER</label>
                                    <select id="setting-default_provider" onchange="updateModelOptions()"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors">
                                        <option value="openrouter">OpenRouter (Multi-provider)</option>
                                        <option value="openai">OpenAI</option>
                                        <option value="anthropic">Anthropic (Claude)</option>
                                        <option value="google">Google (Gemini)</option>
                                        <option value="groq">Groq (Fast Inference)</option>
                                        <option value="mistral">Mistral AI</option>
                                        <option value="deepseek">DeepSeek</option>
                                        <option value="xai">xAI (Grok)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-mono text-slate-400 mb-2">MODEL</label>
                                    <select id="setting-default_model"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors">
                                    </select>
                                    <input type="text" id="setting-custom_model"
                                        class="hidden w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors mt-2"
                                        placeholder="Enter custom model name...">
                                </div>
                            </div>
                        </div>

                        <!-- API Keys -->
                        <div class="glass-card p-6 rounded-2xl mb-6">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="p-2 bg-green-500/10 rounded-lg text-green-500"><i data-lucide="key"
                                        class="w-5 h-5"></i></div>
                                <h4 class="text-lg font-bold text-white">API Keys</h4>
                            </div>
                            <p class="text-slate-400 text-sm mb-4">Keys are stored in the database. Environment
                                variables
                                take precedence if set.</p>
                            <div class="space-y-4">
                                <div class="provider-key" data-provider="openrouter">
                                    <label
                                        class="block text-xs font-mono text-slate-400 mb-2">OPENROUTER_API_KEY</label>
                                    <input type="password" id="setting-openrouter_api_key"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                                        placeholder="sk-or-...">
                                </div>
                                <div class="provider-key" data-provider="openai">
                                    <label class="block text-xs font-mono text-slate-400 mb-2">OPENAI_API_KEY</label>
                                    <input type="password" id="setting-openai_api_key"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                                        placeholder="sk-...">
                                </div>
                                <div class="provider-key" data-provider="anthropic">
                                    <label class="block text-xs font-mono text-slate-400 mb-2">ANTHROPIC_API_KEY</label>
                                    <input type="password" id="setting-anthropic_api_key"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                                        placeholder="sk-ant-...">
                                </div>
                                <div class="provider-key" data-provider="google">
                                    <label class="block text-xs font-mono text-slate-400 mb-2">GOOGLE_API_KEY</label>
                                    <input type="password" id="setting-google_api_key"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                                        placeholder="AIza...">
                                </div>
                                <div class="provider-key" data-provider="groq">
                                    <label class="block text-xs font-mono text-slate-400 mb-2">GROQ_API_KEY</label>
                                    <input type="password" id="setting-groq_api_key"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                                        placeholder="gsk_...">
                                </div>
                                <div class="provider-key" data-provider="mistral">
                                    <label class="block text-xs font-mono text-slate-400 mb-2">MISTRAL_API_KEY</label>
                                    <input type="password" id="setting-mistral_api_key"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                                        placeholder="...">
                                </div>
                                <div class="provider-key" data-provider="deepseek">
                                    <label class="block text-xs font-mono text-slate-400 mb-2">DEEPSEEK_API_KEY</label>
                                    <input type="password" id="setting-deepseek_api_key"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                                        placeholder="sk-...">
                                </div>
                                <div class="provider-key" data-provider="xai">
                                    <label class="block text-xs font-mono text-slate-400 mb-2">XAI_API_KEY</label>
                                    <input type="password" id="setting-xai_api_key"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                                        placeholder="xai-...">
                                </div>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="flex justify-end">
                            <button onclick="saveSettings()"
                                class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-3 rounded-lg font-bold transition-all flex items-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i>
                                Save All Settings
                            </button>
                        </div>
                    </div>
                </div>
        </main>
    </div>

    <!-- Create Agent Modal (3-Step Verification Wizard) -->
    <div id="create-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-slate-900 border border-slate-700 w-full max-w-lg max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-slate-800/50">
                <div>
                    <h3 class="text-lg font-bold text-white">Initialize New Agent</h3>
                    <p id="wizard-step-label" class="text-xs text-orange-400 font-mono mt-1">STEP 1 OF 3: CONFIGURATION
                    </p>
                </div>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>

            <!-- Step Progress -->
            <div class="px-6 pt-4">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div id="step1-indicator"
                            class="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-white font-bold text-sm">
                            1</div>
                        <div id="step1-line" class="w-16 h-1 bg-slate-700 mx-2"></div>
                    </div>
                    <div class="flex items-center">
                        <div id="step2-indicator"
                            class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-slate-400 font-bold text-sm">
                            2</div>
                        <div id="step2-line" class="w-16 h-1 bg-slate-700 mx-2"></div>
                    </div>
                    <div class="flex items-center">
                        <div id="step3-indicator"
                            class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-slate-400 font-bold text-sm">
                            3</div>
                    </div>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="overflow-y-auto flex-1 px-6 pb-4" style="max-height: calc(90vh - 200px);">
                <!-- Step 1: Configuration -->
                <div id="wizard-step1" class="p-6 space-y-4">
                    <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-3 mb-4">
                        <p class="text-xs text-blue-300"><strong>Step 1:</strong> Enter your agent's details. You'll
                            verify the Telegram token in the next step.</p>
                    </div>
                    <div>
                        <label class="block text-xs font-mono text-slate-400 mb-1">DESIGNATION (NAME) *</label>
                        <input type="text" id="new-name"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                            placeholder="e.g., Sherlock">
                    </div>
                    <div>
                        <label class="block text-xs font-mono text-slate-400 mb-1">ROLE DESCRIPTION</label>
                        <input type="text" id="new-role"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                            placeholder="e.g., Security Researcher">
                    </div>
                    <div>
                        <label class="block text-xs font-mono text-slate-400 mb-1">PERSONALITY PROMPT</label>
                        <textarea id="new-personality" rows="3"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                            placeholder="e.g., Speak like a pirate, or impersonate Sherlock Holmes. Be creative!"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-mono text-slate-400 mb-1">TELEGRAM TOKEN *</label>
                        <input type="password" id="new-token"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                            placeholder="From @BotFather">
                        <p class="text-xs text-slate-500 mt-1">Get a token by creating a bot with <a
                                href="https://t.me/BotFather" target="_blank"
                                class="text-orange-400 hover:underline">@BotFather</a></p>
                    </div>
                    <div>
                        <label class="block text-xs font-mono text-slate-400 mb-1">DOCKER IMAGE</label>
                        <select id="new-image"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors">
                            <option value="hermit/base:latest">hermit/base (General Tools)</option>
                            <option value="hermit/python:latest">hermit/python (Data Analysis)</option>
                            <option value="hermit/netsec:latest">hermit/netsec (Security Tools)</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-mono text-slate-400 mb-1">LLM PROVIDER</label>
                            <select id="new-llm-provider"
                                class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white"
                                onchange="updateAgentModelOptions()">
                                <option value="default">System Default</option>
                                <option value="openrouter">OpenRouter</option>
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic</option>
                                <option value="google">Google</option>
                                <option value="groq">Groq</option>
                                <option value="mistral">Mistral</option>
                                <option value="deepseek">DeepSeek</option>
                                <option value="xai">xAI</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-mono text-slate-400 mb-1">LLM MODEL</label>
                            <select id="new-llm-model"
                                class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white">
                                <option value="">Use System Default</option>
                            </select>
                            <input type="text" id="new-llm-model-custom"
                                class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white hidden"
                                placeholder="Enter custom model name">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-mono text-slate-400 mb-1">PROFILE PICTURE URL</label>
                        <input type="text" id="new-profile-picture"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white"
                            placeholder="https://...">
                        <div class="mt-2 flex items-center gap-3">
                            <input type="file" id="new-profile-picture-file" accept="image/*" class="hidden"
                                onchange="uploadProfilePicture(event)">
                            <button type="button" onclick="document.getElementById('new-profile-picture-file').click()"
                                class="bg-slate-800 border border-slate-700 text-white px-3 py-2 rounded-lg text-xs">Upload
                                image</button>
                            <img id="new-profile-picture-preview" class="agent-avatar hidden" alt="Profile preview">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-mono text-slate-400 mb-1">PROFILE BIO</label>
                        <input type="text" id="new-profile-bio"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white"
                            placeholder="Short intro">
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="new-require-approval"
                            class="w-4 h-4 rounded border-slate-600 bg-slate-800 text-orange-500 focus:ring-orange-500">
                        <label for="new-require-approval" class="text-sm text-slate-300">Require approval for dangerous
                            commands (HITL)</label>
                    </div>
                </div>

                <!-- Step 2: Handshake -->
                <div id="wizard-step2" class="p-6 space-y-4 hidden">
                    <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-3 mb-4">
                        <p class="text-xs text-yellow-300"><strong>Step 2:</strong> Verify your bot token works. We'll
                            send a verification code to your Telegram.</p>
                    </div>

                    <div class="bg-slate-800 rounded-lg p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="p-2 bg-orange-500/10 rounded-lg text-orange-500"><i data-lucide="shield-check"
                                    class="w-5 h-5"></i></div>
                            <div>
                                <p class="text-white font-semibold">Verification Required</p>
                                <p class="text-xs text-slate-400">Before creating an agent, verify the bot token</p>
                            </div>
                        </div>

                        <div class="text-sm text-slate-300 space-y-2 mb-4">
                            <p><strong>Important:</strong></p>
                            <ol class="list-decimal list-inside text-slate-400 space-y-1">
                                <li>Click <strong>"Send Verification Code"</strong> below.</li>
                                <li>Check your Operator Telegram account for the 6-digit code.</li>
                                <li>Enter the code in the next step to validate the agent.</li>
                                <li><em>After</em> validation, go to your bot on Telegram and send <code
                                        class="bg-slate-700 px-1 rounded">/start</code></li>
                            </ol>
                        </div>

                        <div id="send-code-status" class="hidden mb-4">
                            <div id="send-code-loading" class="flex items-center gap-2 text-blue-400">
                                <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                <span>Sending verification code...</span>
                            </div>
                            <div id="send-code-success" class="hidden text-green-400 flex items-center gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                                <span>Code sent! Check your Telegram.</span>
                            </div>
                            <div id="send-code-error" class="hidden text-red-400 flex items-center gap-2">
                                <i data-lucide="alert-circle" class="w-4 h-4"></i>
                                <span id="send-code-error-msg">Failed to send code.</span>
                            </div>
                        </div>

                        <button id="send-code-btn" onclick="sendVerificationCode()"
                            class="w-full bg-orange-600 hover:bg-orange-500 text-white py-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2">
                            <i data-lucide="send" class="w-4 h-4"></i>
                            <span>Send Verification Code</span>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Verification -->
                <div id="wizard-step3" class="p-6 space-y-4 hidden">
                    <div class="bg-green-500/10 border border-green-500/20 rounded-lg p-3 mb-4">
                        <p class="text-xs text-green-300"><strong>Step 3:</strong> Enter the 6-digit code sent to your
                            Telegram to complete verification.</p>
                    </div>

                    <div class="bg-slate-800 rounded-lg p-4">
                        <label class="block text-xs font-mono text-slate-400 mb-3">VERIFICATION CODE</label>
                        <div class="flex gap-2 justify-center mb-4">
                            <input type="text" maxlength="1"
                                class="verification-digit w-12 h-14 text-center text-2xl font-bold bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-orange-500 focus:outline-none transition-colors"
                                oninput="handleDigitInput(this, 0)">
                            <input type="text" maxlength="1"
                                class="verification-digit w-12 h-14 text-center text-2xl font-bold bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-orange-500 focus:outline-none transition-colors"
                                oninput="handleDigitInput(this, 1)">
                            <input type="text" maxlength="1"
                                class="verification-digit w-12 h-14 text-center text-2xl font-bold bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-orange-500 focus:outline-none transition-colors"
                                oninput="handleDigitInput(this, 2)">
                            <input type="text" maxlength="1"
                                class="verification-digit w-12 h-14 text-center text-2xl font-bold bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-orange-500 focus:outline-none transition-colors"
                                oninput="handleDigitInput(this, 3)">
                            <input type="text" maxlength="1"
                                class="verification-digit w-12 h-14 text-center text-2xl font-bold bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-orange-500 focus:outline-none transition-colors"
                                oninput="handleDigitInput(this, 4)">
                            <input type="text" maxlength="1"
                                class="verification-digit w-12 h-14 text-center text-2xl font-bold bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-orange-500 focus:outline-none transition-colors"
                                oninput="handleDigitInput(this, 5)">
                        </div>

                        <div id="verify-status" class="hidden mb-4 text-center">
                            <div id="verify-loading" class="flex items-center justify-center gap-2 text-blue-400">
                                <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                <span>Verifying...</span>
                            </div>
                            <div id="verify-success"
                                class="hidden text-green-400 flex items-center justify-center gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                                <span>Verified! Creating agent...</span>
                            </div>
                            <div id="verify-error" class="hidden text-red-400 flex items-center justify-center gap-2">
                                <i data-lucide="alert-circle" class="w-4 h-4"></i>
                                <span id="verify-error-msg">Invalid code.</span>
                            </div>
                        </div>

                        <p class="text-xs text-slate-500 text-center">Didn't receive the code? <button
                                onclick="goToStep(2)" class="text-orange-400 hover:underline">Resend</button></p>
                    </div>
                </div>
            </div>

            <div class="p-6 pt-0 flex flex-col sm:flex-row justify-between gap-3">
                <button id="wizard-back-btn" onclick="wizardBack()"
                    class="hidden px-4 py-2 text-slate-400 hover:text-white flex items-center gap-2 order-2 sm:order-1">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    <span>Back</span>
                </button>
                <div class="flex-1 order-1 sm:order-2"></div>
                <button id="wizard-next-btn" onclick="wizardNext()"
                    class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-2.5 rounded-lg font-bold transition-all flex items-center gap-2 order-3">
                    <span>Continue</span>
                    <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
                <button id="wizard-create-btn" onclick="createAgentWithVerification()"
                    class="hidden bg-green-600 hover:bg-green-500 text-white px-6 py-2.5 rounded-lg font-bold transition-all flex items-center justify-center gap-2 w-full sm:w-auto order-3">
                    <i data-lucide="check" class="w-4 h-4"></i>
                    <span>Create Agent</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Test Agent Modal -->
    <div id="test-modal"
        class="fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-4">
        <div
            class="w-full max-w-3xl bg-slate-900 border border-slate-700 rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div class="bg-slate-800 px-6 py-4 flex justify-between items-center border-b border-slate-700">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i data-lucide="play-circle" class="w-5 h-5 text-green-500"></i>
                    Agent Test Result
                </h3>
                <button onclick="closeTestModal()" class="text-slate-400 hover:text-white"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <div id="test-loading" class="hidden flex flex-col items-center justify-center py-10 space-y-4">
                    <i data-lucide="loader-2" class="w-8 h-8 text-orange-500 animate-spin"></i>
                    <p class="text-slate-400">Agent is processing your request...</p>
                </div>
                <div id="test-content" class="hidden">
                    <div class="bg-[#0c0a09] border border-slate-800 rounded-lg p-4 relative group">
                        <button onclick="copyTestOutput()"
                            class="absolute top-2 right-2 p-2 bg-slate-800 rounded-md text-slate-400 hover:text-white opacity-0 group-hover:opacity-100 transition-opacity"
                            title="Copy to clipboard">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                        <pre id="test-output"
                            class="text-green-400 font-mono text-sm whitespace-pre-wrap break-words"></pre>
                    </div>
                </div>
            </div>
            <div class="bg-slate-800/50 px-6 py-4 border-t border-slate-700 flex justify-end">
                <button onclick="closeTestModal()"
                    class="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Terminal Modal with xterm.js -->
    <div id="terminal-modal"
        class="fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-4">
        <div
            class="w-full max-w-4xl h-[80vh] bg-[#0c0a09] border border-slate-700 rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div class="bg-slate-800 px-4 py-2 flex justify-between items-center border-b border-slate-700">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                    <span id="term-title" class="ml-2 text-slate-400">root@hermitshell:~</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="attachTerminal()" class="text-orange-500 hover:text-white text-sm"
                        title="Attach to container">
                        <i data-lucide="link" class="w-4 h-4"></i>
                    </button>
                    <button onclick="closeTerminal()" class="text-slate-400 hover:text-white"><i data-lucide="x"
                            class="w-4 h-4"></i></button>
                </div>
            </div>
            <div id="xterm-container"></div>
        </div>
    </div>

    <!-- Webhook Guide Modal -->
    <div id="webhook-guide-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-slate-900 border border-slate-700 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden relative max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-slate-800/50 sticky top-0">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i data-lucide="webhook" class="w-5 h-5 text-blue-500"></i>
                    Telegram Webhook Setup Guide
                </h3>
                <button onclick="closeWebhookGuide()" class="text-slate-400 hover:text-white"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-6 text-slate-300">
                <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-4">
                    <p class="text-sm text-blue-300"><strong>What is a Webhook?</strong> A webhook tells Telegram to
                        send messages to your HermitShell server instead of your bot polling for updates. It's the
                        standard way to receive messages in production.</p>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-2 flex items-center gap-2"><span
                            class="bg-orange-600 text-xs px-2 py-0.5 rounded">1</span> Get Your Public URL</h4>
                    <p class="text-sm text-slate-400 mb-3">Your server must be accessible from the internet. If running
                        locally, use a tunnel service:</p>
                    <div class="bg-slate-800 p-3 rounded-lg font-mono text-sm text-green-400">
                        # Using Cloudflare Tunnel (recommended)<br>
                        curl -sL https://run.cloudflare.com/ | sh<br>
                        cloudflared tunnel create hermitshell<br>
                        cloudflared tunnel url hermitshell
                    </div>
                    <p class="text-xs text-slate-500 mt-2">Or use <a href="https://ngrok.com" target="_blank"
                            class="text-orange-400 hover:underline">ngrok</a>: <code
                            class="bg-slate-800 px-1 rounded">ngrok http 3000</code></p>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-2 flex items-center gap-2"><span
                            class="bg-orange-600 text-xs px-2 py-0.5 rounded">2</span> Set Your Public URL in Dashboard
                    </h4>
                    <p class="text-sm text-slate-400 mb-3">Go to Settings and update the <code
                            class="bg-slate-800 px-1 rounded">public_url</code> setting with your public URL (e.g.,
                        <code class="bg-slate-800 px-1 rounded">https://your-tunnel-url.cloudflare.net</code>)
                    </p>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-2 flex items-center gap-2"><span
                            class="bg-orange-600 text-xs px-2 py-0.5 rounded">3</span> Set the Webhook via API</h4>
                    <p class="text-sm text-slate-400 mb-3">Run this command in your terminal:</p>
                    <div class="bg-slate-800 p-3 rounded-lg font-mono text-sm">
                        <span class="text-blue-400">curl</span> -X POST \<br>
                        &nbsp;&nbsp;"https://api.telegram.org/bot<span
                            class="text-orange-400">&lt;YOUR_BOT_TOKEN&gt;</span>/setWebhook" \<br>
                        &nbsp;&nbsp;-d "url=<span class="text-green-400">&lt;YOUR_PUBLIC_URL&gt;</span>/webhook/<span
                            class="text-orange-400">&lt;YOUR_BOT_TOKEN&gt;</span>"
                    </div>
                    <p class="text-xs text-slate-500 mt-2">Replace <code
                            class="bg-slate-800 px-1 rounded">&lt;YOUR_BOT_TOKEN&gt;</code> with your Telegram bot token
                        and <code class="bg-slate-800 px-1 rounded">&lt;YOUR_PUBLIC_URL&gt;</code> with your public URL.
                    </p>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-2 flex items-center gap-2"><span
                            class="bg-orange-600 text-xs px-2 py-0.5 rounded">4</span> Verify It Works</h4>
                    <p class="text-sm text-slate-400 mb-3">Check your webhook info:</p>
                    <div class="bg-slate-800 p-3 rounded-lg font-mono text-sm">
                        <span class="text-blue-400">curl</span> "https://api.telegram.org/bot<span
                            class="text-orange-400">&lt;BOT_TOKEN&gt;</span>/getWebhookInfo"
                    </div>
                    <p class="text-xs text-green-400 mt-2">✅ You should see <code
                            class="bg-slate-800 px-1 rounded">"ok":true</code> and your webhook URL listed.</p>
                </div>

                <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-4">
                    <p class="text-sm text-yellow-300"><strong>⚠️ Important:</strong> Your public URL must be HTTPS
                        (Telegram requires it). If using a tunnel service, it provides HTTPS automatically.</p>
                </div>

                <div class="text-center pt-4">
                    <button onclick="closeWebhookGuide()"
                        class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-2 rounded-lg font-bold transition-all">
                        Got It!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Public URL Guide Modal -->
    <div id="public-url-guide-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-slate-900 border border-slate-700 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden relative max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-slate-800/50 sticky top-0">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i data-lucide="globe" class="w-5 h-5 text-blue-500"></i>
                    Why Do I Need a Public URL?
                </h3>
                <button onclick="closePublicUrlGuide()" class="text-slate-400 hover:text-white"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-6 text-slate-300">
                <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-4">
                    <p class="text-sm text-blue-300"><strong>Short Answer:</strong> Telegram needs to send messages to
                        your HermitShell server. Without a public URL, Telegram can't reach your server.</p>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-3">What is a Public URL?</h4>
                    <p class="text-sm text-slate-400">A public URL is an internet address (like <code
                            class="bg-slate-800 px-1 rounded">https://your-server.com</code>) that can be accessed from
                        anywhere on the internet. It allows external services like Telegram to send data to your server.
                    </p>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-3">Why Does HermitShell Need It?</h4>
                    <ul class="text-sm text-slate-400 space-y-2">
                        <li class="flex items-start gap-2">
                            <i data-lucide="check-circle" class="w-4 h-4 text-green-500 mt-0.5 shrink-0"></i>
                            <span><strong>Telegram Webhooks:</strong> When someone messages your bot, Telegram sends the
                                message to your public URL</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i data-lucide="check-circle" class="w-4 h-4 text-green-500 mt-0.5 shrink-0"></i>
                            <span><strong>HITL Approvals:</strong> Approval requests from your agents are delivered via
                                this URL</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i data-lucide="check-circle" class="w-4 h-4 text-green-500 mt-0.5 shrink-0"></i>
                            <span><strong>Remote Access:</strong> Access your dashboard from anywhere</span>
                        </li>
                    </ul>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-3">How to Get a Public URL</h4>

                    <div class="space-y-4">
                        <div class="bg-slate-800/50 p-4 rounded-xl">
                            <h5 class="text-orange-400 font-semibold mb-2 flex items-center gap-2">
                                <span class="bg-orange-600 text-xs px-2 py-0.5 rounded">EASIEST</span>
                                Option 1: Tunnel Service (Free)
                            </h5>
                            <p class="text-sm text-slate-400 mb-3">Best for development and testing. Creates a secure
                                tunnel to your local machine.</p>
                            <div class="bg-slate-900 p-3 rounded-lg font-mono text-xs space-y-2">
                                <p class="text-slate-500"># Using Cloudflare Tunnel (recommended)</p>
                                <p class="text-green-400">cloudflared tunnel --url http://localhost:3000</p>
                                <p class="text-slate-500 mt-2"># Or using ngrok</p>
                                <p class="text-green-400">ngrok http 3000</p>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">Copy the generated URL (e.g., <code
                                    class="bg-slate-800 px-1 rounded">https://random-name.trycloudflare.com</code>)</p>
                        </div>

                        <div class="bg-slate-800/50 p-4 rounded-xl">
                            <h5 class="text-blue-400 font-semibold mb-2 flex items-center gap-2">
                                <span class="bg-blue-600 text-xs px-2 py-0.5 rounded">PRODUCTION</span>
                                Option 2: Cloud Server
                            </h5>
                            <p class="text-sm text-slate-400 mb-3">For production deployments on VPS/cloud providers.
                            </p>
                            <ul class="text-sm text-slate-500 space-y-1">
                                <li>• Rent a VPS (DigitalOcean, Linode, AWS, etc.)</li>
                                <li>• Point a domain to your server's IP</li>
                                <li>• Set up SSL with Let's Encrypt/Caddy</li>
                                <li>• Use your domain: <code
                                        class="bg-slate-800 px-1 rounded">https://hermitshell.yourdomain.com</code></li>
                            </ul>
                        </div>

                        <div class="bg-slate-800/50 p-4 rounded-xl">
                            <h5 class="text-purple-400 font-semibold mb-2 flex items-center gap-2">
                                <span class="bg-purple-600 text-xs px-2 py-0.5 rounded">LOCAL</span>
                                Option 3: Local Network Only
                            </h5>
                            <p class="text-sm text-slate-400 mb-3">If you only need local access (no Telegram webhooks).
                            </p>
                            <p class="text-sm text-slate-500">Leave this field empty. You can still use the dashboard at
                                <code class="bg-slate-800 px-1 rounded">http://localhost:3000</code>
                            </p>
                            <p class="text-xs text-yellow-400 mt-2">⚠️ Telegram bots will NOT work without a public URL
                            </p>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-3">What You Need to Do</h4>
                    <ol class="text-sm text-slate-400 space-y-3">
                        <li class="flex gap-3">
                            <span
                                class="bg-orange-600 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center shrink-0">1</span>
                            <span>Run a tunnel service OR deploy to a cloud server with a domain</span>
                        </li>
                        <li class="flex gap-3">
                            <span
                                class="bg-orange-600 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center shrink-0">2</span>
                            <span>Copy your public HTTPS URL</span>
                        </li>
                        <li class="flex gap-3">
                            <span
                                class="bg-orange-600 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center shrink-0">3</span>
                            <span>Paste it in the PUBLIC_URL field and click "Save All Settings"</span>
                        </li>
                        <li class="flex gap-3">
                            <span
                                class="bg-orange-600 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center shrink-0">4</span>
                            <span>Set up your Telegram webhook (see Webhook Guide in Settings)</span>
                        </li>
                    </ol>
                </div>

                <div class="bg-green-500/10 border border-green-500/20 rounded-xl p-4">
                    <p class="text-sm text-green-300"><strong>✅ Requirements:</strong> The URL must be HTTPS (not HTTP).
                        Telegram requires secure connections.</p>
                </div>

                <div class="text-center pt-4">
                    <button onclick="closePublicUrlGuide()"
                        class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-2 rounded-lg font-bold transition-all">
                        Got It!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User to Allowlist Modal -->
    <div id="allowlist-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-slate-900 border border-slate-700 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-slate-800/50">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i data-lucide="user-plus" class="w-5 h-5 text-orange-500"></i>
                    Add User to Allowlist
                </h3>
                <button onclick="closeAllowlistModal()" class="text-slate-400 hover:text-white"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">TELEGRAM USER ID *</label>
                    <input type="number" id="allowlist-user-id"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                        placeholder="e.g., 123456789">
                    <p class="text-xs text-slate-500 mt-1">Ask the user to send /start to @userinfobot on Telegram to
                        get their ID</p>
                </div>
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">USERNAME (optional)</label>
                    <input type="text" id="allowlist-username"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                        placeholder="@username">
                </div>
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">FIRST NAME (optional)</label>
                    <input type="text" id="allowlist-first-name"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors"
                        placeholder="John">
                </div>
            </div>
            <div class="p-6 pt-0 flex justify-end gap-3">
                <button onclick="closeAllowlistModal()"
                    class="px-4 py-2 text-slate-400 hover:text-white">Cancel</button>
                <button onclick="addAllowlistUser()"
                    class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-2 rounded-lg font-bold transition-all">
                    Add User
                </button>
            </div>
        </div>
    </div>


    <!-- Agent Chat Modal -->
    <div id="agent-chat-modal"
        class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div
            class="tele-chat-bg border border-slate-700 w-full max-w-2xl h-[80vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
            <div class="p-4 border-b border-slate-700/80 bg-slate-900/70 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img id="agent-chat-avatar" class="agent-avatar" alt="Agent avatar">
                    <div>
                        <h3 id="agent-chat-title" class="text-lg font-bold text-white">Agent Chat</h3>
                        <p class="text-xs text-slate-400">HermitShell secure line</p>
                    </div>
                </div>
                <div class="flex items-center gap-2"><button onclick="clearAgentChatHistory()"
                        class="text-xs bg-slate-800 border border-slate-700 px-3 py-1.5 rounded text-slate-200 hover:bg-slate-700">Clear</button><button
                        onclick="closeAgentChatModal()" class="text-slate-400 hover:text-white"><i data-lucide="x"
                            class="w-5 h-5"></i></button></div>
            </div>
            <div id="agent-chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
            <div class="p-4 border-t border-slate-700/80 bg-slate-900/60">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
                    <input id="agent-chat-user-id" type="number" onchange="loadAgentChatHistory()"
                        class="md:col-span-1 bg-slate-800 border border-slate-700 rounded-lg p-3 text-white"
                        placeholder="User ID">
                    <input id="agent-chat-input"
                        class="md:col-span-3 bg-slate-800 border border-slate-700 rounded-lg p-3 text-white"
                        placeholder="Message...">
                    <button onclick="sendAgentChatMessage()"
                        class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-lg text-sm">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let authState = 'loading';
        let currentAgentId = null;
        let currentContainerId = null;
        let term = null;
        let fitAddon = null;
        let ws = null;
        let termDataDisposable = null;
        let reconnectAttempts = 0;
        const MAX_TERMINAL_RECONNECT_ATTEMPTS = 2;
        let cachedAgents = [];
        let wizardStep = 1;
        let editingAgentId = null;
        let pendingVerificationToken = null;
        let activeChatAgentId = null;
        window.usingDefaultCreds = false;

        const AUTH_TOKEN_KEY = 'hermitshell_session_token';
        const nativeFetch = window.fetch.bind(window);

        function getStoredSessionToken() {
            return localStorage.getItem(AUTH_TOKEN_KEY);
        }

        function setStoredSessionToken(token) {
            if (token) {
                localStorage.setItem(AUTH_TOKEN_KEY, token);
            } else {
                localStorage.removeItem(AUTH_TOKEN_KEY);
            }
        }

        window.fetch = (input, init = {}) => {
            const token = getStoredSessionToken();
            if (!token) return nativeFetch(input, init);

            const headers = new Headers(init.headers || {});
            if (!headers.has('Authorization')) {
                headers.set('Authorization', `Bearer ${token}`);
            }

            return nativeFetch(input, { ...init, headers });
        };

        function openWebhookGuide() {
            document.getElementById('webhook-guide-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeWebhookGuide() {
            document.getElementById('webhook-guide-modal').classList.add('hidden');
        }

        function openPublicUrlGuide() {
            document.getElementById('public-url-guide-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closePublicUrlGuide() {
            document.getElementById('public-url-guide-modal').classList.add('hidden');
        }

        async function init() {
            try {
                const res = await fetch('/api/auth/status');
                const data = await res.json();

                if (data.status === 'authenticated') {
                    window.usingDefaultCreds = data.usingDefault;
                    showDashboard();
                } else {
                    showAuthScreen('SYSTEM LOCKED', 'Authenticate', data.usingDefault);
                    authState = 'login_required';
                }
            } catch (e) {
                console.error("Auth check failed", e);
                showAuthScreen('SYSTEM ERROR', 'Retry', false);
            }
        }

        function showAuthScreen(title, btnText, usingDefault = false) {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('dashboard-ui').classList.add('hidden');
            document.getElementById('auth-title').innerText = title;
            document.getElementById('auth-btn').innerText = btnText;

            if (usingDefault) {
                document.getElementById('default-login-hint').classList.remove('hidden');
                document.getElementById('default-creds-display').classList.remove('hidden');
            } else {
                document.getElementById('default-login-hint').classList.add('hidden');
                document.getElementById('default-creds-display').classList.add('hidden');
            }
        }

        function showDashboard() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('dashboard-ui').classList.remove('hidden');

            if (window.usingDefaultCreds) {
                document.getElementById('default-creds-warning').classList.remove('hidden');
                document.getElementById('settings-creds-warning').classList.remove('hidden');
                document.getElementById('admin-creds-card').classList.add('border-red-500/50');
                document.getElementById('admin-creds-card').classList.remove('border-slate-700/50');
            } else {
                document.getElementById('default-creds-warning').classList.add('hidden');
                document.getElementById('settings-creds-warning').classList.add('hidden');
                document.getElementById('admin-creds-card').classList.remove('border-red-500/50');
                document.getElementById('admin-creds-card').classList.add('border-slate-700/50');
            }

            loadStats();
            loadAgents();
            loadAuditLogs();
            setInterval(() => {
                loadStats();
                loadAgents();
            }, 10000);
        }

        function showSection(section) {
            if (typeof event !== 'undefined' && event && typeof event.preventDefault === 'function') {
                event.preventDefault();
            }

            document.querySelectorAll('.nav-item').forEach(el => {
                const isActive = el.dataset.section === section;
                el.classList.toggle('bg-orange-500/10', isActive);
                el.classList.toggle('text-orange-400', isActive);
                el.classList.toggle('border-orange-500/20', isActive);
                el.classList.toggle('text-slate-300', !isActive);
                el.classList.toggle('text-slate-400', !isActive);
                el.classList.toggle('hover:text-white', !isActive);
                el.classList.toggle('hover:bg-white/5', !isActive);
            });

            document.getElementById('section-agents').classList.add('hidden');
            document.getElementById('section-audit').classList.add('hidden');
            document.getElementById('section-settings').classList.add('hidden');
            document.getElementById('section-metrics').classList.add('hidden');
            document.getElementById('section-allowlist').classList.add('hidden');
            document.getElementById('section-cubicles').classList.add('hidden');
            document.getElementById('section-sites').classList.add('hidden');
            document.getElementById('section-files').classList.add('hidden');
            document.getElementById('section-calendars').classList.add('hidden');
            document.getElementById('section-memories').classList.add('hidden');
            document.getElementById('section-' + section).classList.remove('hidden');

            const titles = {
                'agents': 'Mission Control',
                'cubicles': 'Running Cubicles',
                'audit': 'Audit Logs',
                'settings': 'Settings',
                'metrics': 'System Metrics',
                'allowlist': 'User Allowlist',
                'sites': 'Apps',
                'files': 'Files',
                'calendars': 'Calendars',
                'memories': 'Agent Memories'
            };
            document.getElementById('page-title').innerText = titles[section] || 'Mission Control';

            if (section === 'audit') loadAuditLogs();
            if (section === 'metrics') loadMetrics();
            if (section === 'allowlist') loadAllowlist();
            if (section === 'settings') loadSettings();
            if (section === 'cubicles') loadCubicles();
            if (section === 'sites') loadSites();
            if (section === 'files') loadFilesSection();
            if (section === 'calendars') loadCalendarsSection();
            if (section === 'memories') loadMemoriesSection();
        }

        const PROVIDER_MODELS = {
            openrouter: [
                { value: 'openrouter/free', label: 'Free Model (Reasoning)' },
                { value: 'anthropic/claude-3.5-sonnet', label: 'Claude 3.5 Sonnet (via OpenRouter)' },
                { value: 'anthropic/claude-3-opus', label: 'Claude 3 Opus (via OpenRouter)' },
                { value: 'openai/gpt-4o', label: 'GPT-4o (via OpenRouter)' },
                { value: 'openai/gpt-4-turbo', label: 'GPT-4 Turbo (via OpenRouter)' },
                { value: 'google/gemini-pro-1.5', label: 'Gemini 1.5 Pro (via OpenRouter)' },
                { value: 'meta-llama/llama-3.3-70b-instruct', label: 'Llama 3.3 70B (via OpenRouter)' },
                { value: 'mistralai/mistral-large', label: 'Mistral Large (via OpenRouter)' },
                { value: 'deepseek/deepseek-chat', label: 'DeepSeek Chat (via OpenRouter)' },
                { value: 'auto', label: 'Auto (Best Free)' },
                { value: '__custom__', label: 'Custom Model...' }
            ],
            openai: [
                { value: 'gpt-4o', label: 'GPT-4o' },
                { value: 'gpt-4o-mini', label: 'GPT-4o Mini' },
                { value: 'gpt-4-turbo', label: 'GPT-4 Turbo' },
                { value: 'gpt-4', label: 'GPT-4' },
                { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo' },
                { value: 'o1-preview', label: 'o1 Preview' },
                { value: 'o1-mini', label: 'o1 Mini' },
                { value: '__custom__', label: 'Custom Model...' }
            ],
            anthropic: [
                { value: 'claude-3-5-sonnet-20241022', label: 'Claude 3.5 Sonnet' },
                { value: 'claude-3-opus-20240229', label: 'Claude 3 Opus' },
                { value: 'claude-3-haiku-20240307', label: 'Claude 3 Haiku' },
                { value: '__custom__', label: 'Custom Model...' }
            ],
            google: [
                { value: 'gemini-2.5-pro', label: 'Gemini 2.5 Pro (Thinking)' },
                { value: 'gemini-2.5-flash', label: 'Gemini 2.5 Flash (Thinking)' },
                { value: 'gemini-3-pro-preview', label: 'Gemini 3 Pro (Thinking)' },
                { value: 'gemini-3-flash-preview', label: 'Gemini 3 Flash (Thinking)' },
                { value: 'gemini-2.0-flash', label: 'Gemini 2.0 Flash' },
                { value: 'gemini-2.0-flash-lite', label: 'Gemini 2.0 Flash Lite' },
                { value: 'gemini-1.5-pro', label: 'Gemini 1.5 Pro' },
                { value: 'gemini-1.5-flash', label: 'Gemini 1.5 Flash' },
                { value: '__custom__', label: 'Custom Model...' }
            ],
            groq: [
                { value: 'llama-3.3-70b-versatile', label: 'Llama 3.3 70B Versatile' },
                { value: 'llama-3.1-70b-versatile', label: 'Llama 3.1 70B Versatile' },
                { value: 'llama-3.1-8b-instant', label: 'Llama 3.1 8B Instant' },
                { value: 'mixtral-8x7b-32768', label: 'Mixtral 8x7B' },
                { value: 'gemma2-9b-it', label: 'Gemma 2 9B' },
                { value: '__custom__', label: 'Custom Model...' }
            ],
            mistral: [
                { value: 'mistral-large-latest', label: 'Mistral Large' },
                { value: 'mistral-medium-latest', label: 'Mistral Medium' },
                { value: 'mistral-small-latest', label: 'Mistral Small' },
                { value: 'codestral-latest', label: 'Codestral (Code)' },
                { value: '__custom__', label: 'Custom Model...' }
            ],
            deepseek: [
                { value: 'deepseek-chat', label: 'DeepSeek Chat' },
                { value: 'deepseek-coder', label: 'DeepSeek Coder' },
                { value: '__custom__', label: 'Custom Model...' }
            ],
            xai: [
                { value: 'grok-beta', label: 'Grok Beta' },
                { value: '__custom__', label: 'Custom Model...' }
            ]
        };

        function updateModelOptions() {
            const provider = document.getElementById('setting-default_provider').value;
            const modelSelect = document.getElementById('setting-default_model');
            const customInput = document.getElementById('setting-custom_model');

            modelSelect.innerHTML = '';
            const models = PROVIDER_MODELS[provider] || [];

            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.label;
                modelSelect.appendChild(option);
            });

            modelSelect.onchange = () => {
                if (modelSelect.value === '__custom__') {
                    customInput.classList.remove('hidden');
                    customInput.focus();
                } else {
                    customInput.classList.add('hidden');
                }
            };

            customInput.classList.add('hidden');
        }

        function updateAgentModelOptions() {
            const provider = document.getElementById('new-llm-provider').value;
            const modelSelect = document.getElementById('new-llm-model');
            const customInput = document.getElementById('new-llm-model-custom');

            if (provider === 'default') {
                modelSelect.innerHTML = '<option value="">Use System Default</option>';
                modelSelect.classList.remove('hidden');
                customInput.classList.add('hidden');
                return;
            }

            modelSelect.innerHTML = '';
            const models = PROVIDER_MODELS[provider] || [];

            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.label;
                modelSelect.appendChild(option);
            });

            modelSelect.onchange = () => {
                if (modelSelect.value === '__custom__') {
                    modelSelect.classList.add('hidden');
                    customInput.classList.remove('hidden');
                    customInput.focus();
                } else {
                    modelSelect.classList.remove('hidden');
                    customInput.classList.add('hidden');
                }
            };

            customInput.classList.add('hidden');
            modelSelect.classList.remove('hidden');
        }

        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                if (res.status === 401) return logout();
                const settings = await res.json();

                // Operator settings
                document.getElementById('setting-operator_telegram_id').value = settings.operator_telegram_id || '';

                // General settings
                document.getElementById('setting-public_url').value = settings.public_url || '';
                document.getElementById('setting-hitl_enabled').checked = settings.hitl_enabled === 'true';
                document.getElementById('setting-default_daily_limit').value = settings.default_daily_limit || '1.00';

                // Provider and model
                document.getElementById('setting-default_provider').value = settings.default_provider || 'openrouter';
                updateModelOptions();

                const modelSelect = document.getElementById('setting-default_model');
                const savedModel = settings.default_model || 'auto';
                const models = PROVIDER_MODELS[settings.default_provider] || [];
                const modelExists = models.some(m => m.value === savedModel);

                if (modelExists) {
                    modelSelect.value = savedModel;
                } else if (savedModel) {
                    modelSelect.value = '__custom__';
                    document.getElementById('setting-custom_model').classList.remove('hidden');
                    document.getElementById('setting-custom_model').value = savedModel;
                }

                // API Keys
                document.getElementById('setting-openrouter_api_key').value = settings.openrouter_api_key || '';
                document.getElementById('setting-openai_api_key').value = settings.openai_api_key || '';
                document.getElementById('setting-anthropic_api_key').value = settings.anthropic_api_key || '';
                document.getElementById('setting-google_api_key').value = settings.google_api_key || '';
                document.getElementById('setting-groq_api_key').value = settings.groq_api_key || '';
                document.getElementById('setting-mistral_api_key').value = settings.mistral_api_key || '';
                document.getElementById('setting-deepseek_api_key').value = settings.deepseek_api_key || '';
                document.getElementById('setting-xai_api_key').value = settings.xai_api_key || '';
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        async function saveSettings() {
            const settings = {
                operator_telegram_id: document.getElementById('setting-operator_telegram_id').value,
                public_url: document.getElementById('setting-public_url').value,
                hitl_enabled: document.getElementById('setting-hitl_enabled').checked ? 'true' : 'false',
                default_daily_limit: document.getElementById('setting-default_daily_limit').value,
                default_provider: document.getElementById('setting-default_provider').value,
                default_model: document.getElementById('setting-default_model').value === '__custom__'
                    ? document.getElementById('setting-custom_model').value
                    : document.getElementById('setting-default_model').value,
                openrouter_api_key: document.getElementById('setting-openrouter_api_key').value,
                openai_api_key: document.getElementById('setting-openai_api_key').value,
                anthropic_api_key: document.getElementById('setting-anthropic_api_key').value,
                google_api_key: document.getElementById('setting-google_api_key').value,
                groq_api_key: document.getElementById('setting-groq_api_key').value,
                mistral_api_key: document.getElementById('setting-mistral_api_key').value,
                deepseek_api_key: document.getElementById('setting-deepseek_api_key').value,
                xai_api_key: document.getElementById('setting-xai_api_key').value,
            };

            try {
                const res = await fetch('/api/settings/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (res.ok) {
                    alert('Settings saved successfully!');
                } else {
                    alert('Failed to save settings');
                }
            } catch (e) {
                alert('Error saving settings: ' + e.message);
            }
        }

        async function changeAdminCredentials() {
            const username = document.getElementById('setting-admin-username').value;
            const password = document.getElementById('setting-admin-password').value;

            if (!username || !password) {
                return alert('Both username and password are required');
            }

            if (username === 'admin' && password === 'crab123') {
                return alert('Please enter a secure password different from the default.');
            }

            try {
                const res = await fetch('/api/auth/change', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (res.ok) {
                    alert('Credentials updated successfully! Please log in again.');
                    window.location.reload();
                } else {
                    const data = await res.json();
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Network error: ' + e.message);
            }
        }

        async function handleAuth(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('auth-error');
            const btn = document.getElementById('auth-btn');

            errorDiv.classList.add('hidden');
            btn.disabled = true;
            btn.innerText = 'Authenticating...';

            try {
                console.log('Attempting login for:', username);
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();
                console.log('Login response:', res.status, data);

                if (!res.ok) {
                    throw new Error(data.error || `Login failed (${res.status})`);
                }

                if (data.token) {
                    setStoredSessionToken(data.token);
                }

                alert('Login successful! Redirecting...');
                window.location.reload();
            } catch (err) {
                console.error('Login error:', err);
                errorDiv.innerText = err.message;
                errorDiv.classList.remove('hidden');
                btn.disabled = false;
                btn.innerText = 'Authenticate';
            }
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            setStoredSessionToken(null);
            window.location.reload();
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                if (res.status === 401) return logout();
                const data = await res.json();
                document.getElementById('stat-containers').innerText = data.activeContainers;
                document.getElementById('stat-agents').innerText = data.totalAgents;
                document.getElementById('stat-spend').innerText = '$' + data.totalSpendToday.toFixed(4);
            } catch (e) { }
        }

        async function loadCubicles() {
            try {
                const res = await fetch('/api/containers');
                if (res.status === 401) return logout();
                const containers = await res.json();
                const tbody = document.getElementById('cubicles-tbody');
                const empty = document.getElementById('cubicles-empty');

                const hermitContainers = containers;

                if (hermitContainers.length === 0) {
                    tbody.innerHTML = '';
                    empty.classList.remove('hidden');
                    lucide.createIcons();
                    return;
                }

                empty.classList.add('hidden');
                tbody.innerHTML = hermitContainers.map(c => {
                    const statusColor = c.State === 'running' ? 'text-green-400' : c.State === 'exited' ? 'text-red-400' : 'text-yellow-400';
                    const statusIcon = c.State === 'running' ? '●' : '○';

                    const name = c.Names && c.Names[0] ? c.Names[0].replace('/', '') : 'cubicle';

                    return `
                        <tr class="hover:bg-white/5">
                            <td class="px-4 py-3 font-mono text-slate-400">
                                <div>${c.Id.substring(0, 12)}</div>
                                <div class="text-[10px] text-slate-500">${name}</div>
                            </td>
                            <td class="px-4 py-3">${c.Image}</td>
                            <td class="px-4 py-3 ${statusColor} font-mono">${statusIcon} ${c.State.toUpperCase()}</td>
                            <td class="px-4 py-3 text-slate-400">${c.Status}</td>
                            <td class="px-4 py-3 flex gap-2">
                                <button onclick="viewContainer('${c.Id}')" class="text-orange-500 hover:text-white text-xs">Terminal</button>
                                ${c.State === 'running'
                            ? `<button onclick="stopContainer('${c.Id}')" class="text-yellow-400 hover:text-white text-xs">Stop</button>`
                            : `<button onclick="startContainer('${c.Id}')" class="text-green-400 hover:text-white text-xs">Start</button>`}
                                <button onclick="deleteContainer('${c.Id}')" class="text-red-400 hover:text-white text-xs">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                lucide.createIcons();
            } catch (e) {
                console.error('Failed to load cubicles:', e);
            }
        }

        async function startContainer(containerId) {
            try {
                const res = await fetch(`/api/containers/${containerId}/start`, { method: 'POST' });
                if (res.ok) {
                    loadCubicles();
                    loadStats();
                } else {
                    alert('Failed to start container');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function stopContainer(containerId) {
            if (!confirm('Stop this container?')) return;
            try {
                const res = await fetch(`/api/containers/${containerId}/stop`, { method: 'POST' });
                if (res.ok) {
                    loadCubicles();
                    loadStats();
                } else {
                    alert('Failed to stop container');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function deleteContainer(containerId) {
            if (!confirm('Delete this container? This cannot be undone.')) return;
            try {
                const res = await fetch(`/api/containers/${containerId}/remove`, { method: 'POST' });
                if (res.ok) {
                    loadCubicles();
                    loadStats();
                } else {
                    const data = await res.json();
                    alert('Failed to delete container: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function loadMetrics() {
            try {
                const [statsRes, settingsRes] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/settings')
                ]);
                const stats = await statsRes.json();
                const settings = await settingsRes.json();

                document.getElementById('metric-containers').innerText = stats.activeContainers || 0;
                document.getElementById('metric-agents').innerText = stats.totalAgents || 0;
                document.getElementById('metric-spend').innerText = '$' + (stats.totalSpendToday || 0).toFixed(4);
                document.getElementById('metric-allowlist').innerText = stats.allowlistCount || 0;
                document.getElementById('metric-audit-approved').innerText = stats.metrics?.auditApprovals || 0;
                document.getElementById('metric-audit-pending').innerText = stats.metrics?.auditPending || 0;
                document.getElementById('metric-runtime-errors').innerText = stats.metrics?.runtimeErrors || 0;

                const openaiStatus = document.getElementById('metric-openai');
                const openrouterStatus = document.getElementById('metric-openrouter');
                const openaiSet = !!(settings.openai_api_key || settings.openai_key_set);
                const openrouterSet = !!(settings.openrouter_api_key || settings.openrouter_key_set);
                openaiStatus.className = `text-xs font-mono px-2 py-1 rounded ${openaiSet ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`;
                openaiStatus.innerText = openaiSet ? 'Set' : 'Not Set';
                openrouterStatus.className = `text-xs font-mono px-2 py-1 rounded ${openrouterSet ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`;
                openrouterStatus.innerText = openrouterSet ? 'Set' : 'Not Set';
            } catch (e) { }
        }

        async function loadAllowlist() {
            try {
                const res = await fetch('/api/allowlist');
                if (res.status === 401) return logout();
                const users = await res.json();
                const tbody = document.getElementById('allowlist-tbody');
                const empty = document.getElementById('allowlist-empty');

                if (users.length === 0) {
                    tbody.innerHTML = '';
                    empty.classList.remove('hidden');
                    return;
                }

                empty.classList.add('hidden');
                tbody.innerHTML = users.map(user => `
                    <tr class="hover:bg-white/5">
                        <td class="px-4 py-3 font-mono text-slate-400">${user.user_id}</td>
                        <td class="px-4 py-3">${user.username || '-'}</td>
                        <td class="px-4 py-3">${user.first_name || '-'}</td>
                        <td class="px-4 py-3 text-slate-400">${new Date(user.created_at).toLocaleDateString()}</td>
                        <td class="px-4 py-3">
                            <button onclick="removeFromAllowlist(${user.user_id})" class="text-red-400 hover:text-white text-xs">Remove</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load allowlist:', e);
            }
        }

        async function removeFromAllowlist(userId) {
            if (!confirm('Remove this user from allowlist?')) return;
            try {
                await fetch('/api/allowlist/' + userId, { method: 'DELETE' });
                loadAllowlist();
            } catch (e) {
                alert('Failed to remove user');
            }
        }

        function openAllowlistModal() {
            document.getElementById('allowlist-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeAllowlistModal() {
            document.getElementById('allowlist-modal').classList.add('hidden');
        }

        async function addAllowlistUser() {
            const userId = document.getElementById('allowlist-user-id').value;
            const username = document.getElementById('allowlist-username').value;
            const firstName = document.getElementById('allowlist-first-name').value;

            if (!userId) return alert('User ID is required');

            try {
                await fetch('/api/allowlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: Number(userId), username, first_name: firstName })
                });
                closeAllowlistModal();
                document.getElementById('allowlist-user-id').value = '';
                document.getElementById('allowlist-username').value = '';
                document.getElementById('allowlist-first-name').value = '';
                loadAllowlist();
            } catch (e) {
                alert('Failed to add user');
            }
        }

        function getAgentAvatar(agent) {
            const fallback = `https://api.dicebear.com/9.x/bottts/svg?seed=${encodeURIComponent(agent.name || 'agent')}`;
            return agent.profile_picture_url || fallback;
        }

        function avatarImg(agent, mini = false) {
            return `<img src="${getAgentAvatar(agent)}" class="${mini ? 'agent-avatar-mini' : 'agent-avatar'}" alt="${agent.name}"/>`;
        }

        async function loadRuntimeLogs() {
            const out = document.getElementById('chat-output');
            try {
                const logs = await fetch('/api/runtime-logs?limit=20').then(r => r.json());
                if (!Array.isArray(logs) || !logs.length) {
                    out.innerText = 'No runtime logs yet.';
                    return;
                }
                out.innerText = logs.slice(0, 10).map(l => `[${l.level}] agent#${l.agent_id} ${l.source}: ${l.message}`).join('\n');
            } catch (e) {
                out.innerText = 'Failed to load runtime logs.';
            }
        }


        async function uploadProfilePicture(event) {
            const file = event.target.files?.[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                alert('Only image files are allowed.');
                return;
            }

            const reader = new FileReader();
            reader.onload = () => {
                const dataUrl = String(reader.result || '');
                if (!dataUrl) return;
                document.getElementById('new-profile-picture').value = dataUrl;
                const preview = document.getElementById('new-profile-picture-preview');
                preview.src = dataUrl;
                preview.classList.remove('hidden');
            };
            reader.onerror = () => alert('Failed to read the selected file.');
            reader.readAsDataURL(file);
        }

        async function openAgentChat(agentId, agentName) {
            const agent = cachedAgents.find(a => a.id === agentId) || { id: agentId, name: agentName };
            activeChatAgentId = agentId;
            document.getElementById('agent-chat-title').innerText = `${agent.name} · Chat`;
            document.getElementById('agent-chat-avatar').src = getAgentAvatar(agent);
            document.getElementById('agent-chat-input').value = '';
            document.getElementById('agent-chat-modal').classList.remove('hidden');
            document.getElementById('agent-chat-modal').classList.add('flex');
            await loadAgentChatHistory();
            lucide.createIcons();
        }

        function closeAgentChatModal() {
            document.getElementById('agent-chat-modal').classList.add('hidden');
            document.getElementById('agent-chat-modal').classList.remove('flex');
            activeChatAgentId = null;
        }

        function appendAgentChatMessage(role, text) {
            const wrap = document.getElementById('agent-chat-messages');
            const row = document.createElement('div');
            row.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            const bubble = document.createElement('div');
            bubble.className = `${role === 'user' ? 'chat-bubble-user text-white' : 'chat-bubble-agent text-slate-100'} max-w-[80%] px-4 py-2 text-sm whitespace-pre-wrap`;
            bubble.innerText = text;
            row.appendChild(bubble);
            wrap.appendChild(row);
            wrap.scrollTop = wrap.scrollHeight;
        }

        async function loadAgentChatHistory() {
            const wrap = document.getElementById('agent-chat-messages');
            const userId = Number(document.getElementById('agent-chat-user-id').value || 0);
            wrap.innerHTML = '';
            if (!activeChatAgentId) return;
            try {
                const res = await fetch(`/api/chat/${activeChatAgentId}/history/${userId}`);
                const data = await res.json();
                const history = data.history || [];
                if (!history.length) {
                    appendAgentChatMessage('agent', '🦀 New chat session started.');
                    return;
                }
                history.forEach(msg => appendAgentChatMessage(msg.role === 'assistant' ? 'agent' : 'user', msg.content));
            } catch (e) {
                appendAgentChatMessage('agent', 'Failed to load chat history.');
            }
        }

        async function clearAgentChatHistory() {
            if (!activeChatAgentId) return;
            const userId = Number(document.getElementById('agent-chat-user-id').value || 0);
            await fetch(`/api/chat/${activeChatAgentId}/clear`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId })
            });
            await loadAgentChatHistory();
        }

        async function sendAgentChatMessage() {
            const input = document.getElementById('agent-chat-input');
            const userId = document.getElementById('agent-chat-user-id').value || 0;
            const message = input.value.trim();
            if (!activeChatAgentId || !message) return;

            appendAgentChatMessage('user', message);
            input.value = '';
            appendAgentChatMessage('agent', 'Typing…');

            try {
                const res = await fetch(`/api/chat/${activeChatAgentId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, userId: Number(userId) })
                });
                const data = await res.json();
                const messages = document.getElementById('agent-chat-messages');
                messages.removeChild(messages.lastElementChild);
                appendAgentChatMessage('agent', data.output || data.error || 'No response');
            } catch (e) {
                const messages = document.getElementById('agent-chat-messages');
                messages.removeChild(messages.lastElementChild);
                appendAgentChatMessage('agent', 'Failed to send message: ' + e.message);
            }
        }

        async function loadAgents() {
            const grid = document.getElementById('agent-grid');

            if (!cachedAgents || cachedAgents.length === 0) {
                grid.innerHTML = `
                <div class="skeleton-card w-full">
                    <div class="glass-card rounded-2xl p-5 space-y-4 animate-pulse">
                        <div class="flex items-start gap-3">
                            <div class="w-12 h-12 bg-slate-700 rounded-full"></div>
                            <div class="flex-1 space-y-2">
                                <div class="h-5 bg-slate-700 rounded w-1/2"></div>
                                <div class="h-3 bg-slate-700 rounded w-3/4"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="h-10 bg-slate-700 rounded-lg"></div>
                            <div class="h-10 bg-slate-700 rounded-lg"></div>
                        </div>
                        <div class="h-4 bg-slate-700 rounded w-3/4"></div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            <div class="h-8 bg-slate-700 rounded-lg"></div>
                            <div class="h-8 bg-slate-700 rounded-lg"></div>
                            <div class="h-8 bg-slate-700 rounded-lg"></div>
                        </div>
                    </div>
                </div>
                <div class="skeleton-card w-full">
                    <div class="glass-card rounded-2xl p-5 space-y-4 animate-pulse">
                        <div class="flex items-start gap-3">
                            <div class="w-12 h-12 bg-slate-700 rounded-full"></div>
                            <div class="flex-1 space-y-2">
                                <div class="h-5 bg-slate-700 rounded w-1/2"></div>
                                <div class="h-3 bg-slate-700 rounded w-3/4"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="h-10 bg-slate-700 rounded-lg"></div>
                            <div class="h-10 bg-slate-700 rounded-lg"></div>
                        </div>
                        <div class="h-4 bg-slate-700 rounded w-3/4"></div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            <div class="h-8 bg-slate-700 rounded-lg"></div>
                            <div class="h-8 bg-slate-700 rounded-lg"></div>
                            <div class="h-8 bg-slate-700 rounded-lg"></div>
                        </div>
                    </div>
                </div>
                <div class="skeleton-card w-full">
                    <div class="glass-card rounded-2xl p-5 space-y-4 animate-pulse">
                        <div class="flex items-start gap-3">
                            <div class="w-12 h-12 bg-slate-700 rounded-full"></div>
                            <div class="flex-1 space-y-2">
                                <div class="h-5 bg-slate-700 rounded w-1/2"></div>
                                <div class="h-3 bg-slate-700 rounded w-3/4"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="h-10 bg-slate-700 rounded-lg"></div>
                            <div class="h-10 bg-slate-700 rounded-lg"></div>
                        </div>
                        <div class="h-4 bg-slate-700 rounded w-3/4"></div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            <div class="h-8 bg-slate-700 rounded-lg"></div>
                            <div class="h-8 bg-slate-700 rounded-lg"></div>
                            <div class="h-8 bg-slate-700 rounded-lg"></div>
                        </div>
                    </div>
                </div>`;
            }

            try {
                const res = await fetch('/api/agents');
                if (res.status === 401) return logout();
                const agents = await res.json();

                let newHTML = '';

                agents.forEach(agent => {
                    const percent = (agent.budget.current_spend_usd / agent.budget.daily_limit_usd) * 100;
                    const color = percent > 90 ? 'bg-red-500' : 'bg-green-500';
                    const hitlBadge = agent.require_approval ? '<span class="ml-2 text-xs bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded">HITL</span>' : '';
                    
                    const status = agent.status || 'idle';
                    const statusDot = {
                        'active': '<span class="w-2.5 h-2.5 rounded-full bg-green-400 shadow-[0_0_10px_#4ade80]" title="Active"></span>',
                        'idle': '<span class="w-2.5 h-2.5 rounded-full bg-amber-400 shadow-[0_0_10px_#fbbf24]" title="Idle"></span>'
                    }[status] || statusDot.idle;

                    const card = `
                        <div class="glass-card rounded-2xl p-5 relative group overflow-hidden space-y-4">
                            <div class="absolute top-4 right-4 flex items-center gap-2">
                                ${statusDot}
                            </div>

                            <div class="flex items-start gap-3 pr-6">
                                ${avatarImg(agent)}
                                <div class="min-w-0">
                                    <h3 class="text-lg font-bold text-white truncate">${agent.name} ${hitlBadge}</h3>
                                    <p class="text-xs text-orange-400 font-mono truncate">${agent.role || 'No role configured'}</p>
                                    <p class="text-xs text-slate-400 mt-1 max-h-9 overflow-hidden">${agent.profile_bio || ''}</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div class="bg-slate-900/50 border border-slate-800 rounded-lg p-2"><div class="text-slate-500 mono">IMAGE</div><div class="text-slate-300 truncate">${agent.docker_image.split(':')[0]}</div></div>
                                <div class="bg-slate-900/50 border border-slate-800 rounded-lg p-2"><div class="text-slate-500 mono">LLM</div><div class="text-slate-300 truncate">${agent.llm_provider && agent.llm_provider !== 'default' ? agent.llm_provider : 'default'}</div></div>
                            </div>

                            <div>
                                <div class="flex justify-between text-xs text-slate-400 font-mono mb-1"><span>BUDGET</span><span>$${agent.budget.current_spend_usd.toFixed(4)} / $${agent.budget.daily_limit_usd} <button onclick="resetBudget(${agent.id}, '${agent.name}')" class="ml-1 text-amber-400 hover:text-amber-300" title="Reset Budget"><i data-lucide="rotate-ccw" class="w-3 h-3 inline"></i></button></span></div>
                                <div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden"><div class="${color} h-full" style="width: ${Math.min(percent, 100)}%"></div></div>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs">
                                <button onclick="testAgent(${agent.id}, '${agent.name}')" class="flex items-center justify-center gap-1 bg-green-600/20 hover:bg-green-600/30 text-green-400 py-2 rounded-lg border border-green-600/30"> <i data-lucide="play" class="w-3 h-3"></i><span>Test Agent</span></button>
                                <button onclick="openTerminal(${agent.id}, '${agent.name}')" class="flex items-center justify-center gap-1 bg-slate-800 hover:bg-slate-700 text-white py-2 rounded-lg border border-slate-700"> <i data-lucide="terminal" class="w-3 h-3"></i><span>Terminal</span></button>
                                <button onclick="viewRuntimeLogs(${agent.id}, '${agent.name}')" class="flex items-center justify-center gap-1 bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 py-2 rounded-lg border border-blue-600/30"> <i data-lucide="file-text" class="w-3 h-3"></i><span>Logs</span></button>
                                <button onclick="openAgentChat(${agent.id}, '${agent.name}')" class="flex items-center justify-center gap-1 bg-cyan-600/20 hover:bg-cyan-600/30 text-cyan-300 py-2 rounded-lg border border-cyan-600/30"> <i data-lucide="message-circle" class="w-3 h-3"></i><span>Chat</span></button>
                                <button onclick="editAgent(${agent.id}, this)" class="flex items-center justify-center gap-1 bg-slate-800 hover:bg-slate-700 text-white py-2 rounded-lg border border-slate-700"> <i data-lucide="settings" class="w-3 h-3"></i><span>Edit</span></button>
                                <button onclick="deleteAgent(${agent.id}, '${agent.name}')" class="flex items-center justify-center gap-1 bg-red-600/20 hover:bg-red-600/30 text-red-400 py-2 rounded-lg border border-red-600/30"> <i data-lucide="trash-2" class="w-3 h-3"></i><span>Delete</span></button>
                            </div>
                        </div>
                    `;
                    newHTML += card;
                });

                if (grid.innerHTML !== newHTML) {
                    grid.innerHTML = newHTML;
                    lucide.createIcons();
                }
                cachedAgents = agents;
                if (!document.getElementById('section-sites').classList.contains('hidden')) loadSites();
                if (!document.getElementById('section-files').classList.contains('hidden')) loadFilesSection();
            } catch (e) { }
        }

        function flattenWorkspace(items = [], depth = 0) {
            const rows = [];
            items.forEach(item => {
                rows.push({ ...item, depth });
                if (item.type === 'directory' && Array.isArray(item.children)) {
                    rows.push(...flattenWorkspace(item.children, depth + 1));
                }
            });
            return rows;
        }

        async function loadSites() {
            const grid = document.getElementById('sites-grid');
            if (!grid) return;
            try {
                grid.innerHTML = '<div class="text-slate-400 text-sm">Scanning workspaces and apps...</div>';
                const data = await fetch('/api/sites').then(r => r.json());
                const sites = data.sites || [];
                for (const site of sites) {
                    for (const app of (site.webApps || [])) {
                        try {
                            await fetch(`/api/sites/${site.agentId}/${site.userId}/${app.siteName}/screenshot`, { method: 'POST' });
                            const shotRes = await fetch(`/api/sites/${site.agentId}/${site.userId}/${app.siteName}/screenshot`);
                            const shotData = await shotRes.json();
                            const shotPath = shotData?.screenshot?.screenshot_path || '';
                            if (shotPath) {
                                const filename = String(shotPath).split('/').pop();
                                app.screenshotUrl = filename ? `/api/screenshots/${filename}` : '';
                            }
                        } catch {}
                    }
                }
                grid.innerHTML = SitesUI.renderSitesTable(sites);

                grid.querySelectorAll('.js-copy-site-url').forEach(button => {
                    button.addEventListener('click', () => {
                        const target = button.getAttribute('data-copy-url') || '';
                        navigator.clipboard.writeText(target);
                    });
                });

                grid.querySelectorAll('.js-regenerate-password').forEach(button => {
                    button.addEventListener('click', async () => {
                        const agentId = button.getAttribute('data-agent-id');
                        const port = button.getAttribute('data-port');
                        const res = await fetch(`/api/sites/${agentId}/${port}/password/regenerate`, { method: 'POST' });
                        const body = await res.json();
                        if (!res.ok) {
                            alert(body.error || 'Failed to regenerate password');
                            return;
                        }
                        const holder = document.getElementById(`site-password-${agentId}-${port}`);
                        if (holder) holder.textContent = body.password;
                    });
                });

                grid.querySelectorAll('.js-reveal-password').forEach(button => {
                    button.addEventListener('click', async () => {
                        const agentId = button.getAttribute('data-agent-id');
                        const data = await fetch('/api/sites').then(r => r.json());
                        const site = (data.sites || []).find(s => String(s.agentId) === String(agentId));
                        const holder = document.getElementById(`site-password-${agentId}-8080`);
                        if (holder) holder.textContent = site?.password || (site?.hasPassword ? '••••••••' : 'Not set');
                    });
                });

                grid.querySelectorAll('.js-delete-site').forEach(button => {
                    button.addEventListener('click', async () => {
                        const agentId = button.getAttribute('data-agent-id');
                        const userId = button.getAttribute('data-user-id');
                        if (!confirm(`Delete published site for agent ${agentId} user ${userId}?`)) return;
                        const res = await fetch(`/api/sites/${agentId}/${userId}`, { method: 'DELETE' });
                        const body = await res.json();
                        if (!res.ok) {
                            alert(body.error || 'Failed to delete site');
                            return;
                        }
                        await loadSites();
                    });
                });

                grid.querySelectorAll('.js-delete-app').forEach(button => {
                    button.addEventListener('click', async () => {
                        const agentId = button.getAttribute('data-agent-id');
                        const userId = button.getAttribute('data-user-id');
                        const siteName = button.getAttribute('data-site-name');
                        if (!confirm(`Delete app ${siteName}?`)) return;
                        const res = await fetch(`/api/sites/${agentId}/${userId}/${siteName}`, { method: 'DELETE' });
                        const body = await res.json();
                        if (!res.ok) {
                            alert(body.error || 'Failed to delete app');
                            return;
                        }
                        await loadSites();
                    });
                });

                lucide.createIcons();
            } catch (e) {
                grid.innerHTML = '<div class="text-red-400">Failed to load sites.</div>';
            }
        }

        let currentSitePreview = null;
        
        async function openSitePreview(agentId, userId, siteName, previewUrl) {
            const modal = document.getElementById('site-preview-modal');
            const titleEl = document.getElementById('site-preview-title');
            const frameEl = document.getElementById('site-preview-frame');
            const appsListEl = document.getElementById('site-apps-list');
            const badgeEl = document.getElementById('site-preview-badge');
            
            currentSitePreview = { agentId, userId, siteName, previewUrl };
            
            titleEl.textContent = siteName || 'Site Preview';
            badgeEl.textContent = 'Inactive';
            badgeEl.className = 'text-xs px-2 py-1 rounded bg-slate-700 text-slate-300';
            
            modal.classList.remove('hidden');
            
            const data = await fetch('/api/sites').then(r => r.json());
            const site = (data.sites || []).find(s => String(s.agentId) === String(agentId) && String(s.userId) === String(userId));
            
            if (site && site.webApps && site.webApps.length > 0) {
                appsListEl.innerHTML = site.webApps.map(app => `
                    <button onclick="selectWebApp('${app.siteName}', '${app.previewUrl}')" 
                        class="w-full text-left px-3 py-2 rounded-lg text-sm ${app.siteName === siteName ? 'bg-orange-600 text-white' : 'text-slate-300 hover:bg-slate-700'}">
                        ${app.siteName}
                        <div class="text-xs ${app.siteName === siteName ? 'text-orange-200' : 'text-slate-500'}">
                            ${app.hasIndexHtml ? 'index.html' : 'No index'}
                        </div>
                    </button>
                `).join('');
            } else {
                appsListEl.innerHTML = '<p class="text-xs text-slate-500">No web apps found</p>';
            }
            
            frameEl.src = previewUrl;
            frameEl.onload = () => {
                badgeEl.textContent = 'Active';
                badgeEl.className = 'text-xs px-2 py-1 rounded bg-green-600 text-white';
            };
        }
        
        function selectWebApp(siteName, previewUrl) {
            const titleEl = document.getElementById('site-preview-title');
            const frameEl = document.getElementById('site-preview-frame');
            const appsListEl = document.getElementById('site-apps-list');
            
            titleEl.textContent = siteName;
            frameEl.src = previewUrl;
            
            appsListEl.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('bg-orange-600', 'text-white');
                btn.classList.add('text-slate-300', 'hover:bg-slate-700');
            });
            event.target.closest('button').classList.add('bg-orange-600', 'text-white');
            event.target.closest('button').classList.remove('text-slate-300', 'hover:bg-slate-700');
        }
        
        function closeSitePreview() {
            const modal = document.getElementById('site-preview-modal');
            const frameEl = document.getElementById('site-preview-frame');
            frameEl.src = '';
            modal.classList.add('hidden');
            currentSitePreview = null;
        }
        
        async function shareSiteTunnel() {
            if (!currentSitePreview) return;
            
            try {
                const res = await fetch(`/api/sites/${currentSitePreview.agentId}/${currentSitePreview.userId}/${currentSitePreview.siteName}/tunnel`, { 
                    method: 'POST' 
                });
                const data = await res.json();
                
                if (!res.ok) {
                    alert(data.error || 'Failed to create tunnel');
                    return;
                }
                
                await navigator.clipboard.writeText(data.tunnelUrl);
                alert(`Tunnel link copied to clipboard!\n\nLink: ${data.tunnelUrl}\nExpires: ${new Date(data.expiresAt).toLocaleString()}`);
            } catch (e) {
                alert('Failed to share site: ' + e.message);
            }
        }
        
        async function captureSiteScreenshotFor(agentId, userId, siteName) {
            try {
                const res = await fetch(`/api/sites/${agentId}/${userId}/${siteName}/screenshot`, { 
                    method: 'POST' 
                });
                const data = await res.json();
                
                if (!res.ok) {
                    alert(data.error || 'Failed to capture screenshot');
                    return;
                }
                
                alert('Screenshot captured.');
                await loadSites();
            } catch (e) {
                alert('Failed to capture screenshot: ' + e.message);
            }
        }

        async function loadFilesSection() {
            const agentSelect = document.getElementById('files-agent');
            const userSelect = document.getElementById('files-user');
            if (!agentSelect || !userSelect) return;
            try {
                const [agentsRes, usersRes] = await Promise.all([fetch('/api/agents'), fetch('/api/allowlist')]);
                const agents = await agentsRes.json();
                const users = await usersRes.json();
                cachedAgents = agents;
                agentSelect.innerHTML = agents.map(a => `<option value="${a.id}">${a.name} (#${a.id})</option>`).join('') || '<option value="">No agents</option>';
                userSelect.innerHTML = users.map(u => `<option value="${u.user_id}">${u.first_name || u.username || u.user_id} (${u.user_id})</option>`).join('') || '<option value="">No users</option>';
            } catch (e) {
                document.getElementById('files-browser').innerHTML = '<span class="text-red-400">Failed to prepare file browser.</span>';
            }
        }

        async function loadWorkspaceFiles() {
            const agentId = document.getElementById('files-agent').value;
            const userId = document.getElementById('files-user').value;
            const browser = document.getElementById('files-browser');
            if (!agentId || !userId) {
                browser.innerHTML = '<span class="text-yellow-400">Select both agent and user.</span>';
                return;
            }
            browser.innerHTML = '<span class="text-slate-400">Loading workspace...</span>';
            try {
                const res = await fetch(`/api/files/${agentId}/${userId}`);
                if (!res.ok) {
                    const err = await res.json();
                    browser.innerHTML = `<span class="text-yellow-400">${err.error || 'Workspace not found yet.'}</span>`;
                    return;
                }
                const data = await res.json();
                const rows = flattenWorkspace(data.files || []);
                if (!rows.length) {
                    browser.innerHTML = '<span class="text-slate-400">Workspace is empty.</span>';
                    return;
                }
                const selectedAgent = (cachedAgents || []).find(a => String(a.id) === String(agentId)) || { name: 'Agent' };
                const listHtml = rows.map(item => {
                    const indent = '&nbsp;'.repeat(item.depth * 4);
                    const icon = item.type === 'directory' ? '📁' : '📄';
                    const download = item.type === 'file'
                        ? `<a href="/api/files/${agentId}/${userId}/download/${item.path}?token=${getStoredSessionToken()}" class="text-orange-400 hover:text-orange-300 text-xs ml-2">download</a>`
                        : '';
                    return `<div class="py-1 border-b border-slate-800/70 last:border-b-0 mono text-xs">${indent}${icon} ${item.path}${download}</div>`;
                }).join('');
                browser.innerHTML = `<div class="flex items-center gap-2 mb-3 text-xs text-slate-400">${avatarImg(selectedAgent, true)}<span>${selectedAgent.name} workspace</span></div>${listHtml}`;
            } catch (e) {
                browser.innerHTML = '<span class="text-red-400">Failed to load workspace files.</span>';
            }
        }

        let calendarEventsCache = [];
        let calendarCurrentMonth = new Date();
        let calendarSelectedDate = new Date().toISOString().slice(0, 10);

        function formatDateKey(value) {
            return new Date(value).toISOString().slice(0, 10);
        }

        function initCalendarSymbolPicker(selected = '•') {
            const select = document.getElementById('calendar-symbol');
            if (!select || !window.CalendarSymbols) return;
            const options = window.CalendarSymbols.CALENDAR_SYMBOL_OPTIONS || ['•'];
            const current = window.CalendarSymbols.normalizeCalendarSymbol(selected);
            select.innerHTML = options.map(symbol => `<option value="${symbol}">${symbol}</option>`).join('');
            select.value = current;
        }

        function renderCalendarGrid() {
            const grid = document.getElementById('calendar-grid');
            const monthLabel = document.getElementById('calendar-month-label');
            if (!grid || !monthLabel) return;

            const year = calendarCurrentMonth.getFullYear();
            const month = calendarCurrentMonth.getMonth();
            monthLabel.innerText = calendarCurrentMonth.toLocaleString(undefined, { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1);
            const startOffset = firstDay.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const countByDay = {};
            calendarEventsCache.forEach(ev => {
                const key = formatDateKey(ev.start_time);
                countByDay[key] = (countByDay[key] || 0) + 1;
            });

            const cells = [];
            for (let i = 0; i < startOffset; i++) {
                cells.push('<div class="h-24 rounded-lg border border-slate-800 bg-slate-900/30"></div>');
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const key = date.toISOString().slice(0, 10);
                const isSelected = key === calendarSelectedDate;
                const isToday = key === new Date().toISOString().slice(0, 10);
                const dayEvents = calendarEventsCache.filter(ev => formatDateKey(ev.start_time) === key);
                const count = dayEvents.length;

                cells.push(`
                    <button onclick="selectCalendarDate('${key}')" class="h-24 rounded-lg border p-2 text-left transition ${isSelected ? 'border-orange-500 bg-orange-500/10' : 'border-slate-700 bg-slate-900/50 hover:bg-slate-800/60'}">
                        <div class="flex items-center justify-between">
                            <span class="text-sm ${isToday ? 'text-orange-400 font-bold' : 'text-slate-200'}">${day}</span>
                            ${count ? `<span class="text-[10px] px-1.5 py-0.5 rounded-full bg-blue-500/20 text-blue-300">${count}</span>` : ''}
                        </div>
                        <div class="mt-2 space-y-1 max-h-14 overflow-hidden">
                            ${dayEvents.slice(0, 3).map(ev => { 
                                const color = ev.color || '#f97316'; 
                                return `<div class="text-[10px] truncate text-slate-300 flex items-center gap-1"><span class="w-2 h-2 rounded-full" style="background:${color}"></span><span class="truncate">${ev.title}</span></div>`; 
                            }).join('')}
                            ${count > 3 ? `<div class="text-[10px] text-slate-500">+${count - 3} more</div>` : ''}
                        </div>
                    </button>
                `);
            }

            grid.innerHTML = cells.join('');
            renderSelectedDateEvents();
            lucide.createIcons();
        }

        function selectCalendarDate(dateKey) {
            calendarSelectedDate = dateKey;
            renderCalendarGrid();
        }

        function shiftCalendarMonth(delta) {
            calendarCurrentMonth = new Date(calendarCurrentMonth.getFullYear(), calendarCurrentMonth.getMonth() + delta, 1);
            renderCalendarGrid();
        }

        function renderSelectedDateEvents() {
            const panel = document.getElementById('calendar-events');
            const title = document.getElementById('calendar-selected-date');
            if (!panel || !title) return;

            title.innerText = `Events • ${new Date(calendarSelectedDate + 'T00:00:00').toLocaleDateString()}`;
            const events = calendarEventsCache.filter(ev => formatDateKey(ev.start_time) === calendarSelectedDate);

            if (!events.length) {
                panel.innerHTML = '<div class="glass-card p-4 rounded-xl text-slate-400 text-sm">No events scheduled for this day.</div>';
                return;
            }

            panel.innerHTML = events.map(ev => {
                const eventColor = ev.color || '#f97316';
                const statusColors = {
                    'scheduled': 'bg-blue-500/20 text-blue-300 border-blue-500/30',
                    'running': 'bg-green-500/20 text-green-300 border-green-500/30',
                    'completed': 'bg-slate-500/20 text-slate-300 border-slate-500/30',
                    'failed': 'bg-red-500/20 text-red-300 border-red-500/30',
                    'cancelled': 'bg-slate-500/20 text-slate-400 border-slate-500/30'
                };
                const statusClass = statusColors[ev.status] || 'bg-slate-500/20 text-slate-300';
                const timeStr = new Date(ev.start_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                return `
                <div class="glass-card p-4 rounded-xl" style="border-left: 4px solid ${eventColor}">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="font-semibold text-white flex items-center gap-2"><span style="color:${eventColor}">${ev.symbol || '•'}</span><span>${ev.title}</span></h5>
                        <span class="text-xs px-2 py-1 rounded border ${statusClass}">${ev.status}</span>
                    </div>
                    <div class="flex items-center gap-3 text-xs text-slate-400 mb-2">
                        <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${timeStr}</span>
                        <span class="flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> ${new Date(ev.start_time).toLocaleDateString()}</span>
                    </div>
                    <div class="text-sm text-slate-300 whitespace-pre-wrap mb-3 bg-slate-800/50 p-2 rounded-lg">${ev.prompt}</div>
                    <div class="flex gap-2">
                        <button onclick="editCalendarEventPrompt(${ev.agent_id}, ${ev.id})" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs px-3 py-1 rounded">Edit</button>
                        <button onclick="markCalendarCancelled(${ev.agent_id}, ${ev.id})" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs px-3 py-1 rounded">Cancel</button>
                        <button onclick="deleteCalendarEvent(${ev.agent_id}, ${ev.id})" class="bg-red-600/20 hover:bg-red-600/30 border border-red-500/30 text-red-300 text-xs px-3 py-1 rounded">Delete</button>
                    </div>
                </div>`;
            }).join('');
        }

        async function loadCalendarsSection() {
            const agentSelect = document.getElementById('calendar-agent');
            const userSelect = document.getElementById('calendar-user');
            if (!agentSelect || !userSelect) return;
            try {
                const [agentsRes, usersRes] = await Promise.all([fetch('/api/agents'), fetch('/api/allowlist')]);
                const agents = await agentsRes.json();
                const users = await usersRes.json();
                cachedAgents = agents;
                agentSelect.innerHTML = agents.map(a => `<option value="${a.id}">${a.name} (#${a.id})</option>`).join('') || '<option value="">No agents</option>';
                userSelect.innerHTML = users.map(u => `<option value="${u.user_id}">${u.first_name || u.username || u.user_id} (${u.user_id})</option>`).join('') || '<option value="">No users</option>';

                if (users.length) userSelect.value = String(users[0].user_id);

                await loadCalendarEvents();
            } catch (e) {
                document.getElementById('calendar-events').innerHTML = '<div class="glass-card p-4 rounded-xl text-red-400">Failed to load calendar section.</div>';
            }
        }

        async function loadCalendarEvents() {
            const agentId = document.getElementById('calendar-agent').value;
            const userId = document.getElementById('calendar-user')?.value || 0;
            if (!agentId) {
                calendarEventsCache = [];
                renderCalendarGrid();
                return;
            }

            try {
                const res = await fetch(`/api/agents/${agentId}/calendars?userId=${userId}`);
                const data = await res.json();
                calendarEventsCache = data.events || [];

                const startInput = document.getElementById('calendar-start');
                const colorInput = document.getElementById('calendar-color');
                const symbolInput = document.getElementById('calendar-symbol');
                if (colorInput && !colorInput.value) colorInput.value = '#3b82f6';
                if (symbolInput) initCalendarSymbolPicker(symbolInput.value || '•');
                if (startInput && !startInput.value) {
                    const d = new Date();
                    d.setMinutes(0, 0, 0);
                    startInput.value = new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                }

                renderCalendarGrid();
            } catch (e) {
                document.getElementById('calendar-events').innerHTML = '<div class="glass-card p-4 rounded-xl text-red-400">Failed to load events.</div>';
            }
        }

        async function createCalendarEvent() {
            const agentId = document.getElementById('calendar-agent').value;
            const title = document.getElementById('calendar-title').value.trim();
            const prompt = document.getElementById('calendar-prompt').value.trim();
            const start = document.getElementById('calendar-start').value;
            const end = document.getElementById('calendar-end').value;
            const color = document.getElementById('calendar-color').value || '#3b82f6';
            const symbol = window.CalendarSymbols ? window.CalendarSymbols.normalizeCalendarSymbol(document.getElementById('calendar-symbol').value) : '•';
            const userId = Number(document.getElementById('calendar-user').value || 0);

            if (!agentId || !title || !prompt || !start || !userId) {
                alert('Please fill agent, user, title, prompt, and start time.');
                return;
            }

            const payload = {
                title,
                prompt,
                start_time: new Date(start).toISOString(),
                end_time: end ? new Date(end).toISOString() : null,
                target_user_id: userId,
                color,
                symbol,
                userId
            };

            const res = await fetch(`/api/agents/${agentId}/calendars?userId=${userId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const err = await res.json();
                alert(err.error || 'Failed to create event');
                return;
            }

            document.getElementById('calendar-title').value = '';
            document.getElementById('calendar-prompt').value = '';
            document.getElementById('calendar-end').value = '';
            initCalendarSymbolPicker('•');
            await loadCalendarEvents();
        }


        async function editCalendarEventPrompt(agentId, eventId) {
            const event = calendarEventsCache.find(ev => ev.id === eventId);
            if (!event) return;
            const userId = document.getElementById('calendar-user')?.value || 0;

            const title = prompt('Edit title', event.title);
            if (title === null) return;
            const promptText = prompt('Edit prompt', event.prompt);
            if (promptText === null) return;
            const color = prompt('Edit color (hex like #3b82f6)', event.color || '#3b82f6');
            if (color === null) return;
            initCalendarSymbolPicker(event.symbol || '•');
            const symbol = document.getElementById('calendar-symbol').value || '•';

            await fetch(`/api/agents/${agentId}/calendars/${eventId}?userId=${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: title.trim(), prompt: promptText.trim(), color: color.trim(), symbol: window.CalendarSymbols ? window.CalendarSymbols.normalizeCalendarSymbol(symbol) : '•', userId })
            });
            await loadCalendarEvents();
        }

        async function deleteCalendarEvent(agentId, eventId) {
            const userId = document.getElementById('calendar-user')?.value || 0;
            await fetch(`/api/agents/${agentId}/calendars/${eventId}?userId=${userId}`, { method: 'DELETE' });
            await loadCalendarEvents();
        }

        async function markCalendarCancelled(agentId, eventId) {
            const userId = document.getElementById('calendar-user')?.value || 0;
            await fetch(`/api/agents/${agentId}/calendars/${eventId}?userId=${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'cancelled', userId })
            });
            await loadCalendarEvents();
        }

        async function loadAuditLogs() {
            try {
                const agentFilter = document.getElementById('audit-agent-filter')?.value || '';
                const statusFilter = document.getElementById('audit-status-filter')?.value || '';
                const searchFilter = document.getElementById('audit-search')?.value || '';
                
                let url = '/api/audit?limit=100';
                if (agentFilter) url += `&agentId=${agentFilter}`;
                if (statusFilter) url += `&status=${statusFilter}`;
                
                const res = await fetch(url);
                if (res.status === 401) return logout();
                let logs = await res.json();
                
                if (searchFilter) {
                    const search = searchFilter.toLowerCase();
                    logs = logs.filter(log => 
                        (log.command || '').toLowerCase().includes(search) ||
                        (log.response_text || '').toLowerCase().includes(search) ||
                        (log.output_snippet || '').toLowerCase().includes(search)
                    );
                }
                
                const agents = await fetch('/api/agents').then(r => r.json());
                const agentMap = {};
                agents.forEach(a => agentMap[a.id] = a.name);

                const tbody = document.getElementById('audit-tbody');
                const emptyEl = document.getElementById('audit-empty');
                
                if (!logs.length) {
                    tbody.innerHTML = '';
                    if (emptyEl) emptyEl.classList.remove('hidden');
                    return;
                }
                
                if (emptyEl) emptyEl.classList.add('hidden');

                logs.forEach(log => {
                    const statusColors = {
                        'approved': 'text-green-400 bg-green-500/10',
                        'denied': 'text-red-400 bg-red-500/10',
                        'pending': 'text-yellow-400 bg-yellow-500/10',
                        'error': 'text-red-400 bg-red-500/10'
                    };
                    const statusColor = statusColors[log.status] || 'text-slate-400 bg-slate-500/10';
                    const actionType = log.action_type || 'command';
                    const responseText = log.response_text || log.output_snippet || '-';
                    
                    const row = `
                        <tr class="hover:bg-white/5">
                            <td class="px-4 py-3 font-mono text-slate-400 text-xs">${new Date(log.created_at).toLocaleString()}</td>
                            <td class="px-4 py-3">${agentMap[log.agent_id] || 'Unknown'}</td>
                            <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs bg-slate-700 text-slate-300">${actionType}</span></td>
                            <td class="px-4 py-3 font-mono text-xs truncate max-w-xs" title="${log.command}">${log.command || '-'}</td>
                            <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs ${statusColor}">${log.status.toUpperCase()}</span></td>
                            <td class="px-4 py-3 text-xs text-slate-400 max-w-xs truncate" title="${responseText}">${responseText}</td>
                            <td class="px-4 py-3">
                                <button onclick="viewContainer('${log.container_id}')" class="text-orange-500 hover:text-white text-xs">View</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                
                const agentSelect = document.getElementById('audit-agent-filter');
                if (agentSelect && agentSelect.children.length <= 1) {
                    agentSelect.innerHTML = '<option value="">All Agents</option>' + 
                        agents.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
                }
            } catch (e) {
                console.error('Failed to load audit logs:', e);
            }
        }

        async function editAgent(id, btn) {
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<svg class="animate-spin w-3 h-3" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Loading...</span>';
            }

            let agent = cachedAgents.find(a => a.id === id);
            if (!agent) {
                const agents = await fetch('/api/agents').then(r => r.json());
                agent = agents.find(a => a.id === id);
            }
            if (!agent) {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="settings" class="w-3 h-3"></i><span>Edit</span>';
                    lucide.createIcons();
                }
                return;
            }

            document.getElementById('new-name').value = agent.name;
            document.getElementById('new-role').value = agent.role;
            document.getElementById('new-personality').value = agent.personality || '';
            document.getElementById('new-token').value = agent.telegram_token;
            document.getElementById('new-image').value = agent.docker_image;
            document.getElementById('new-require-approval').checked = agent.require_approval === 1;
            document.getElementById('new-profile-picture').value = agent.profile_picture_url || '';
            const preview = document.getElementById('new-profile-picture-preview');
            if (agent.profile_picture_url) { preview.src = agent.profile_picture_url; preview.classList.remove('hidden'); } else { preview.classList.add('hidden'); }
            document.getElementById('new-profile-bio').value = agent.profile_bio || '';
            document.getElementById('new-llm-provider').value = agent.llm_provider || 'default';
            updateAgentModelOptions();
            document.getElementById('new-llm-model').value = agent.llm_model || '';
            document.getElementById('new-llm-model-custom').value = agent.llm_model && !PROVIDER_MODELS[agent.llm_provider]?.find(m => m.value === agent.llm_model) ? agent.llm_model : '';
            if (agent.llm_model && !PROVIDER_MODELS[agent.llm_provider]?.find(m => m.value === agent.llm_model)) {
                document.getElementById('new-llm-model').classList.add('hidden');
                document.getElementById('new-llm-model-custom').classList.remove('hidden');
            }

            if (confirm('Edit agent "' + agent.name + '"?')) {
                editingAgentId = id;
                wizardStep = 1;
                updateWizardUI();
                document.getElementById('create-modal').classList.remove('hidden');
                lucide.createIcons();
            }

            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="settings" class="w-3 h-3"></i><span>Edit</span>';
                lucide.createIcons();
            }
        }

        async function deleteAgent(id, name) {
            if (!confirm(`Delete agent "${name}"? This cannot be undone.`)) return;

            try {
                const res = await fetch(`/api/agents/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadAgents();
                    loadStats();
                } else {
                    const data = await res.json();
                    alert('Failed to delete agent: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to delete agent: ' + e.message);
            }
        }

        async function resetBudget(id, name) {
            if (!confirm(`Reset budget for agent "${name}"? This will set current spend to $0.00.`)) return;

            try {
                const res = await fetch(`/api/agents/${id}/reset-budget`, { method: 'POST' });
                if (res.ok) {
                    loadAgents();
                    loadStats();
                } else {
                    const data = await res.json();
                    alert('Failed to reset budget: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to reset budget: ' + e.message);
            }
        }

        async function testAgent(id, name) {
            const message = prompt(`Send a test message to ${name}:`, 'Hello! Tell me about your environment.');
            if (!message) return;

            document.getElementById('test-modal').classList.remove('hidden');
            document.getElementById('test-loading').classList.remove('hidden');
            document.getElementById('test-content').classList.add('hidden');
            lucide.createIcons();

            try {
                const res = await fetch(`/api/test-agent/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await res.json();

                document.getElementById('test-loading').classList.add('hidden');
                document.getElementById('test-content').classList.remove('hidden');

                const outputEl = document.getElementById('test-output');
                if (data.error) {
                    outputEl.innerText = 'ERROR:\n' + data.error;
                    outputEl.classList.add('text-red-400');
                    outputEl.classList.remove('text-green-400');
                } else {
                    outputEl.innerText = data.output;
                    outputEl.classList.add('text-green-400');
                    outputEl.classList.remove('text-red-400');
                }
            } catch (e) {
                document.getElementById('test-loading').classList.add('hidden');
                document.getElementById('test-content').classList.remove('hidden');

                const outputEl = document.getElementById('test-output');
                outputEl.innerText = 'Failed to test agent: ' + e.message;
                outputEl.classList.add('text-red-400');
                outputEl.classList.remove('text-green-400');
            }
        }

        function closeTestModal() {
            document.getElementById('test-modal').classList.add('hidden');
        }

        function copyTestOutput() {
            const output = document.getElementById('test-output').innerText;
            navigator.clipboard.writeText(output).then(() => {
                alert('Copied to clipboard!');
            });
        }

        async function openModal() {
            try {
                const res = await fetch('/api/settings');
                const settings = await res.json();

                if (!settings.operator_telegram_id || !settings.public_url) {
                    alert('⚠️ Action Required\n\nPlease set both your "Operator Telegram ID" and "Public URL" in the Settings tab before spawning an agent. Telegram needs the Public URL to push messages to your bot.');
                    showSection('settings');
                    return;
                }

                const provider = settings.default_provider || 'openrouter';
                const apiKeyField = `${provider}_api_key`;
                if (!settings[apiKeyField]) {
                    alert(`⚠️ Missing API Key\n\nYou are using '${provider}' as your LLM provider, but its API key is missing.\n\nPlease go to Settings -> API Keys, enter your key, and click "Save All Settings".`);
                    showSection('settings');
                    return;
                }

            } catch (e) {
                console.error("Failed to fetch settings", e);
            }

            document.getElementById('new-name').value = '';
            document.getElementById('new-role').value = '';
            document.getElementById('new-personality').value = '';
            document.getElementById('new-token').value = '';
            document.getElementById('new-require-approval').checked = false;
            document.getElementById('new-profile-picture').value = '';
            document.getElementById('new-profile-picture-preview').classList.add('hidden');
            document.getElementById('new-profile-bio').value = '';
            document.getElementById('new-llm-provider').value = 'default';
            updateAgentModelOptions();
            document.getElementById('new-llm-model').value = '';
            document.getElementById('new-llm-model-custom').value = '';
            document.getElementById('new-llm-model-custom').classList.add('hidden');
            document.getElementById('new-llm-model').classList.remove('hidden');
            wizardStep = 1;
            pendingVerificationToken = null;
            editingAgentId = null;
            document.getElementById('new-token').parentElement.classList.remove('hidden');
            document.getElementById('wizard-create-btn').innerHTML = '<i data-lucide="check-circle" class="w-4 h-4"></i> Create Agent';
            updateWizardUI();
            document.getElementById('create-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeModal() {
            document.getElementById('create-modal').classList.add('hidden');
            wizardStep = 1;
            pendingVerificationToken = null;
            editingAgentId = null;
            document.getElementById('new-token').parentElement.classList.remove('hidden');
            document.getElementById('wizard-create-btn').innerHTML = '<i data-lucide="check-circle" class="w-4 h-4"></i> Create Agent';
        }

        function updateWizardUI() {
            document.getElementById('wizard-step1').classList.add('hidden');
            document.getElementById('wizard-step2').classList.add('hidden');
            document.getElementById('wizard-step3').classList.add('hidden');
            document.getElementById('wizard-back-btn').classList.add('hidden');
            document.getElementById('wizard-next-btn').classList.add('hidden');
            document.getElementById('wizard-create-btn').classList.add('hidden');

            document.getElementById('step1-indicator').className = 'w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-slate-400 font-bold text-sm';
            document.getElementById('step2-indicator').className = 'w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-slate-400 font-bold text-sm';
            document.getElementById('step3-indicator').className = 'w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-slate-400 font-bold text-sm';
            document.getElementById('step1-line').className = 'w-16 h-1 bg-slate-700 mx-2';
            document.getElementById('step2-line').className = 'w-16 h-1 bg-slate-700 mx-2';

            if (editingAgentId) {
                document.getElementById('wizard-step1').classList.remove('hidden');
                document.getElementById('wizard-step-label').innerText = 'EDIT AGENT';
                document.getElementById('wizard-back-btn').classList.remove('hidden');
                document.getElementById('wizard-next-btn').classList.add('hidden');
                document.getElementById('wizard-create-btn').classList.remove('hidden');
                document.getElementById('wizard-create-btn').innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Save Changes';
                document.getElementById('step1-indicator').className = 'w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-white font-bold text-sm';
                document.getElementById('new-token').parentElement.classList.add('hidden');
                return;
            }

            if (wizardStep === 1) {
                document.getElementById('wizard-step1').classList.remove('hidden');
                document.getElementById('wizard-step-label').innerText = 'STEP 1 OF 3: CONFIGURATION';
                document.getElementById('wizard-next-btn').classList.remove('hidden');
                document.getElementById('step1-indicator').className = 'w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-white font-bold text-sm';
            } else if (wizardStep === 2) {
                document.getElementById('wizard-step2').classList.remove('hidden');
                document.getElementById('wizard-step-label').innerText = 'STEP 2 OF 3: VERIFICATION HANDSHAKE';
                document.getElementById('wizard-back-btn').classList.remove('hidden');
                document.getElementById('wizard-next-btn').classList.remove('hidden');
                document.getElementById('step1-indicator').className = 'w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white font-bold text-sm';
                document.getElementById('step1-line').className = 'w-16 h-1 bg-green-500 mx-2';
                document.getElementById('step2-indicator').className = 'w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-white font-bold text-sm';
                document.getElementById('send-code-status').classList.add('hidden');
                document.getElementById('send-code-success').classList.add('hidden');
                document.getElementById('send-code-error').classList.add('hidden');
                document.getElementById('send-code-loading').classList.add('hidden');
                document.getElementById('send-code-btn').disabled = false;
                document.getElementById('send-code-btn').classList.remove('opacity-50');
            } else if (wizardStep === 3) {
                document.getElementById('wizard-step3').classList.remove('hidden');
                document.getElementById('wizard-step-label').innerText = 'STEP 3 OF 3: ENTER CODE';
                document.getElementById('wizard-back-btn').classList.remove('hidden');
                document.getElementById('wizard-create-btn').classList.remove('hidden');
                document.getElementById('step1-indicator').className = 'w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white font-bold text-sm';
                document.getElementById('step1-line').className = 'w-16 h-1 bg-green-500 mx-2';
                document.getElementById('step2-indicator').className = 'w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white font-bold text-sm';
                document.getElementById('step2-line').className = 'w-16 h-1 bg-green-500 mx-2';
                document.getElementById('step3-indicator').className = 'w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-white font-bold text-sm';
                document.getElementById('verify-status').classList.add('hidden');
                clearVerificationDigits();
                document.querySelector('.verification-digit').focus();
            }
            lucide.createIcons();
        }

        function goToStep(step) {
            wizardStep = step;
            updateWizardUI();
        }

        function wizardNext() {
            if (wizardStep === 1) {
                const name = document.getElementById('new-name').value.trim();
                const token = document.getElementById('new-token').value.trim();
                if (!name) return alert('Agent name is required');
                if (!token) return alert('Telegram token is required');
                wizardStep = 2;
                updateWizardUI();
            } else if (wizardStep === 2) {
                wizardStep = 3;
                updateWizardUI();
            }
        }

        async function syncWebhooks(event) {
            const btn = event.currentTarget;
            const icon = btn.querySelector('i');
            icon.classList.add('animate-spin');

            try {
                const res = await fetch('/api/webhooks/sync', { method: 'POST' });
                const data = await res.json();

                if (res.ok) {
                    alert(`✅ Successfully synced ${data.count} of ${data.total} active bots with Telegram.`);
                } else {
                    alert('❌ Failed to sync webhooks: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('❌ Network error: ' + e.message);
            } finally {
                icon.classList.remove('animate-spin');
            }
        }

        function wizardBack() {
            if (wizardStep > 1) {
                wizardStep--;
                updateWizardUI();
            }
        }

        function handleDigitInput(input, index) {
            const value = input.value.replace(/[^0-9]/g, '');
            input.value = value;

            if (value && index < 5) {
                const digits = document.querySelectorAll('.verification-digit');
                digits[index + 1].focus();
            }

            const digits = document.querySelectorAll('.verification-digit');
            const code = Array.from(digits).map(d => d.value).join('');
            if (code.length === 6) {
                createAgentWithVerification();
            }
        }

        function clearVerificationDigits() {
            const digits = document.querySelectorAll('.verification-digit');
            digits.forEach(d => d.value = '');
        }

        async function sendVerificationCode() {
            const token = document.getElementById('new-token').value.trim();
            if (!token) return alert('Please enter a Telegram token first');

            document.getElementById('send-code-status').classList.remove('hidden');
            document.getElementById('send-code-loading').classList.remove('hidden');
            document.getElementById('send-code-success').classList.add('hidden');
            document.getElementById('send-code-error').classList.add('hidden');
            document.getElementById('send-code-btn').disabled = true;
            document.getElementById('send-code-btn').classList.add('opacity-50');

            try {
                const res = await fetch('/api/agents/request-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });

                const data = await res.json();

                document.getElementById('send-code-loading').classList.add('hidden');

                if (res.ok && data.success) {
                    pendingVerificationToken = token;
                    document.getElementById('send-code-success').classList.remove('hidden');
                    document.getElementById('send-code-btn').disabled = false;
                    document.getElementById('send-code-btn').classList.remove('opacity-50');
                } else {
                    document.getElementById('send-code-error').classList.remove('hidden');
                    document.getElementById('send-code-error-msg').innerText = data.error || 'Failed to send code';
                    document.getElementById('send-code-btn').disabled = false;
                    document.getElementById('send-code-btn').classList.remove('opacity-50');
                }
            } catch (e) {
                document.getElementById('send-code-loading').classList.add('hidden');
                document.getElementById('send-code-error').classList.remove('hidden');
                document.getElementById('send-code-error-msg').innerText = 'Network error: ' + e.message;
                document.getElementById('send-code-btn').disabled = false;
                document.getElementById('send-code-btn').classList.remove('opacity-50');
            }
        }

        async function createAgentWithVerification() {
            const btn = document.getElementById('wizard-create-btn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            btn.innerHTML = '<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Saving...</span>';

            const name = document.getElementById('new-name').value.trim();
            const role = document.getElementById('new-role').value.trim();
            const personality = document.getElementById('new-personality').value.trim();
            const image = document.getElementById('new-image').value;
            const requireApproval = document.getElementById('new-require-approval').checked ? 1 : 0;
            const profilePicture = document.getElementById('new-profile-picture').value.trim();
            const profileBio = document.getElementById('new-profile-bio').value.trim();
            const llmProvider = document.getElementById('new-llm-provider').value;
            let llmModel = document.getElementById('new-llm-model').value;
            const customModel = document.getElementById('new-llm-model-custom').value.trim();
            if (customModel) llmModel = customModel;
            if (llmProvider === 'default' || !llmModel) llmModel = '';

            if (editingAgentId) {
                document.getElementById('verify-status').classList.remove('hidden');
                document.getElementById('verify-loading').classList.remove('hidden');
                try {
                    const res = await fetch(`/api/agents/${editingAgentId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name,
                            role,
                            docker_image: image,
                            require_approval: requireApproval,
                            profile_picture_url: profilePicture,
                            profile_bio: profileBio,
                            llm_provider: llmProvider,
                            llm_model: llmModel,
                            personality: personality
                        })
                    });
                    const data = await res.json();
                    document.getElementById('verify-loading').classList.add('hidden');
                    if (res.ok) {
                        document.getElementById('verify-success').classList.remove('hidden');
                        setTimeout(() => {
                            closeModal();
                            loadAgents();
                        }, 1000);
                    } else {
                        document.getElementById('verify-error').classList.remove('hidden');
                        document.getElementById('verify-error-msg').innerText = data.error || 'Failed to update agent';
                        btn.disabled = false;
                        btn.classList.remove('opacity-75', 'cursor-not-allowed');
                        btn.innerHTML = originalHTML;
                    }
                } catch (e) {
                    document.getElementById('verify-loading').classList.add('hidden');
                    document.getElementById('verify-error').classList.remove('hidden');
                    document.getElementById('verify-error-msg').innerText = 'Network error: ' + e.message;
                    btn.disabled = false;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                    btn.innerHTML = originalHTML;
                }
                return;
            }

            const digits = document.querySelectorAll('.verification-digit');
            const code = Array.from(digits).map(d => d.value).join('');

            if (code.length !== 6) {
                return alert('Please enter all 6 digits');
            }

            const token = pendingVerificationToken || document.getElementById('new-token').value.trim();

            document.getElementById('verify-status').classList.remove('hidden');
            document.getElementById('verify-loading').classList.remove('hidden');
            document.getElementById('verify-success').classList.add('hidden');
            document.getElementById('verify-error').classList.add('hidden');

            try {
                const res = await fetch('/api/agents/confirm-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token,
                        code,
                        editAgentId: editingAgentId,
                        agentData: {
                            name,
                            role,
                            docker_image: image,
                            require_approval: requireApproval,
                            profile_picture_url: profilePicture,
                            profile_bio: profileBio,
                            llm_provider: llmProvider,
                            llm_model: llmModel,
                            personality: personality
                        }
                    })
                });

                const data = await res.json();

                document.getElementById('verify-loading').classList.add('hidden');

                if (res.ok && data.success) {
                    document.getElementById('verify-success').classList.remove('hidden');
                    setTimeout(() => {
                        closeModal();
                        loadAgents();
                    }, 1000);
                } else {
                    document.getElementById('verify-error').classList.remove('hidden');
                    document.getElementById('verify-error-msg').innerText = data.error || 'Invalid verification code';
                    clearVerificationDigits();
                    document.querySelector('.verification-digit').focus();
                }
            } catch (e) {
                document.getElementById('verify-loading').classList.add('hidden');
                document.getElementById('verify-error').classList.remove('hidden');
                document.getElementById('verify-error-msg').innerText = 'Network error: ' + e.message;
            }
        }

        async function openTerminal(id, name) {
            currentAgentId = id;
            document.getElementById('term-title').innerText = `ssh ${name.toLowerCase()}@hermitshell`;
            document.getElementById('terminal-modal').classList.remove('hidden');

            if (!term) {
                term = new Terminal({
                    cursorBlink: true,
                    fontSize: 14,
                    fontFamily: 'JetBrains Mono, monospace',
                    theme: {
                        background: '#0c0a09',
                        foreground: '#f8fafc',
                        cursor: '#ff6b35'
                    }
                });
                fitAddon = new FitAddon.FitAddon();
                term.loadAddon(fitAddon);
                term.open(document.getElementById('xterm-container'));
                fitAddon.fit();

                term.writeln('\x1b[38;5;208mCRABSHELL v1.0.0 - Secure Shell Connection Established.\x1b[0m');
                term.writeln('\x1b[90mClick "Link" button to attach to a running container\x1b[0m');
            }
        }

        function disconnectTerminalSocket() {
            if (ws) {
                ws.onopen = null;
                ws.onmessage = null;
                ws.onclose = null;
                ws.onerror = null;
                ws.close();
                ws = null;
            }
        }

        function bindTerminalInput() {
            if (!term || termDataDisposable) return;
            termDataDisposable = term.onData((data) => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(btoa(data));
                }
            });
        }

        function connectTerminalSocket(containerId, displayName) {
            disconnectTerminalSocket();
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/api/terminal/${containerId}`);

            ws.onopen = () => {
                reconnectAttempts = 0;
                term.writeln(`\x1b[32mConnected to ${displayName}\x1b[0m`);
            };

            ws.onmessage = (event) => {
                term.write(atob(event.data));
            };

            ws.onclose = () => {
                term.writeln('\x1b[33mDisconnected\x1b[0m');
                if (currentContainerId && reconnectAttempts < MAX_TERMINAL_RECONNECT_ATTEMPTS) {
                    reconnectAttempts += 1;
                    term.writeln(`\x1b[90mReconnecting (${reconnectAttempts}/${MAX_TERMINAL_RECONNECT_ATTEMPTS})...\x1b[0m`);
                    setTimeout(() => connectTerminalSocket(currentContainerId, displayName), 1200);
                }
            };

            ws.onerror = (err) => {
                term.writeln('\x1b[31mConnection error\x1b[0m');
                console.error(err);
            };
        }

        async function attachTerminal() {
            const containers = await fetch('/api/containers').then(r => r.json());
            if (!containers || containers.length === 0) {
                term.writeln('\x1b[31mNo running containers found\x1b[0m');
                return;
            }

            const runningContainer = containers[0];
            currentContainerId = runningContainer.Id;

            term.writeln(`\x1b[32mConnecting to ${runningContainer.Names[0]}...\x1b[0m`);

            bindTerminalInput();
            connectTerminalSocket(currentContainerId, runningContainer.Names[0]);
        }

        async function viewContainer(containerId) {
            if (!term) {
                term = new Terminal({
                    cursorBlink: true,
                    fontSize: 14,
                    fontFamily: 'JetBrains Mono, monospace',
                    theme: {
                        background: '#0c0a09',
                        foreground: '#f8fafc',
                        cursor: '#ff6b35'
                    }
                });
                fitAddon = new FitAddon.FitAddon();
                term.loadAddon(fitAddon);
                term.open(document.getElementById('xterm-container'));
                fitAddon.fit();
            }

            document.getElementById('terminal-modal').classList.remove('hidden');
            term.writeln(`\x1b[32mAttaching to container ${containerId.substring(0, 12)}...\x1b[0m`);

            currentContainerId = containerId;
            bindTerminalInput();
            connectTerminalSocket(containerId, containerId.substring(0, 12));
        }

        function closeTerminal() {
            reconnectAttempts = MAX_TERMINAL_RECONNECT_ATTEMPTS;
            disconnectTerminalSocket();
            document.getElementById('terminal-modal').classList.add('hidden');
        }

        async function viewRuntimeLogs(agentId, agentName) {
            const userId = 123456789;

            document.getElementById('term-title').innerText = `logs: ${agentName.toLowerCase()}.log`;
            document.getElementById('terminal-modal').classList.remove('hidden');

            if (!term) {
                term = new Terminal({
                    cursorBlink: true,
                    fontSize: 14,
                    fontFamily: 'JetBrains Mono, monospace',
                    theme: {
                        background: '#0c0a09',
                        foreground: '#f8fafc',
                        cursor: '#ff6b35'
                    }
                });
                fitAddon = new FitAddon.FitAddon();
                term.loadAddon(fitAddon);
                term.open(document.getElementById('xterm-container'));
                fitAddon.fit();
            }

            term.clear();
            term.writeln(`\x1b[34m-- Fetching runtime logs for ${agentName} --\x1b[0m`);

            try {
                const res = await fetch(`/api/agents/${agentId}/runtime-logs/${userId}`);
                const data = await res.json();
                const cleanLogs = data.logs.replace(/\n/g, '\r\n').replace(/\x1b\[[0-9;]*m/g, '');
                term.write(cleanLogs);
            } catch (e) {
                term.writeln(`\x1b[31mError: ${e.message}\x1b[0m`);
            }
        }

        async function fetchAPI(endpoint, options = {}) {
            try {
                const res = await fetch(endpoint, options);
                if (res.status === 401 || res.status === 403) {
                    showAuthScreen();
                    throw new Error('Unauthorized');
                }
                return await res.json();
            } catch (err) {
                console.error('API Error:', err);
                return { error: err.message };
            }
        }

        async function loadMemoriesSection() {
            try {
                const [agentsRes, usersRes] = await Promise.all([fetch('/api/agents'), fetch('/api/allowlist')]);
                const agents = await agentsRes.json();
                const users = await usersRes.json();
                
                if (agents) {
                    const select = document.getElementById('memory-agent-select');
                    const userSelect = document.getElementById('memory-user-select');
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select an agent...</option>';
                    agents.forEach(a => {
                        select.innerHTML += `<option value="${a.id}">${a.name} (${a.role})</option>`;
                    });
                    if (users) {
                        userSelect.innerHTML = users.map(u => `<option value="${u.user_id}">${u.first_name || u.username || u.user_id} (${u.user_id})</option>`).join('') || '<option value="0">User 0</option>';
                        if (users.length) userSelect.value = String(users[0].user_id);
                    }
                    if (currentValue && agents.find(a => a.id == currentValue)) {
                        select.value = currentValue;
                        loadAgentMemories();
                    } else if (agents.length > 0) {
                        select.value = agents[0].id;
                        loadAgentMemories();
                    }
                }
                lucide.createIcons();
            } catch (e) {
                console.error(e);
            }
        }

        async function loadAgentMemories() {
            const agentId = document.getElementById('memory-agent-select').value;
            const userId = document.getElementById('memory-user-select')?.value || 0;
            if (!agentId) return;

            try {
                const res = await fetchAPI(`/api/agents/${agentId}/memory?userId=${userId}`);
                const tbody = document.getElementById('memories-tbody');
                const empty = document.getElementById('memories-empty');

                if (res.memories && res.memories.length > 0) {
                    tbody.innerHTML = res.memories.map(m => `
                        <tr class="hover:bg-white/5 transition-colors">
                            <td class="px-4 py-4 text-slate-300 align-top">${m.content}</td>
                            <td class="px-4 py-4 text-right align-top">
                                <button onclick="deleteAgentMemory(${m.id})" class="text-red-400 hover:text-red-300 bg-red-400/10 hover:bg-red-400/20 px-3 py-1.5 rounded transition-colors text-xs font-bold">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                    empty.classList.add('hidden');
                } else {
                    tbody.innerHTML = '';
                    empty.classList.remove('hidden');
                }
                lucide.createIcons();
            } catch (e) {
                console.error(e);
            }
        }

        async function addAgentMemory() {
            const agentId = document.getElementById('memory-agent-select').value;
            const userId = document.getElementById('memory-user-select')?.value || 0;
            const input = document.getElementById('new-memory-input');
            const content = input.value.trim();

            if (!agentId) return alert('Please select an agent first.');
            if (!content) return;

            try {
                const res = await fetchAPI(`/api/agents/${agentId}/memory?userId=${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, userId })
                });
                if (res.success) {
                    input.value = '';
                    loadAgentMemories();
                } else {
                    alert('Failed to add memory: ' + (res.error || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function clearAgentMemories() {
            const agentId = document.getElementById('memory-agent-select').value;
            const userId = document.getElementById('memory-user-select')?.value || 0;
            if (!agentId || !confirm('Are you sure you want to clear ALL memories for this agent? This cannot be undone.')) return;

            try {
                const res = await fetchAPI(`/api/agents/${agentId}/memory?userId=${userId}`, {
                    method: 'DELETE'
                });
                if (res.success) {
                    loadAgentMemories();
                } else {
                    alert('Failed to clear memories: ' + (res.error || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function deleteAgentMemory(memoryId) {
            const agentId = document.getElementById('memory-agent-select').value;
            const userId = document.getElementById('memory-user-select')?.value || 0;
            if (!agentId || !confirm('Are you sure you want to delete this memory?')) return;

            try {
                const res = await fetchAPI(`/api/agents/${agentId}/memory/${memoryId}?userId=${userId}`, {
                    method: 'DELETE'
                });
                if (res.success) {
                    loadAgentMemories();
                } else {
                    alert('Failed to delete memory: ' + (res.error || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
            }
        }

        window.addEventListener('resize', () => {
            if (fitAddon) fitAddon.fit();
        });

        // Interactive Mascot
        const authMascot = document.getElementById('auth-mascot');
        const leftClawAuth = document.getElementById('left-claw-auth');
        const rightClawAuth = document.getElementById('right-claw-auth');
        const crabBodyAuth = document.getElementById('crab-body-auth');

        if (authMascot) {
            authMascot.addEventListener('mousedown', () => {
                if (leftClawAuth) leftClawAuth.style.transform = 'rotate(-30deg) scale(1.2)';
                if (rightClawAuth) rightClawAuth.style.transform = 'rotate(30deg) scale(1.2)';
            });

            authMascot.addEventListener('mouseup', () => {
                if (leftClawAuth) leftClawAuth.style.transform = 'rotate(0deg) scale(1)';
                if (rightClawAuth) rightClawAuth.style.transform = 'rotate(0deg) scale(1)';
            });

            authMascot.addEventListener('mouseleave', () => {
                if (leftClawAuth) leftClawAuth.style.transform = 'rotate(0deg) scale(1)';
                if (rightClawAuth) rightClawAuth.style.transform = 'rotate(0deg) scale(1)';
            });
        }

        async function downloadWorkspaceArchive() {
            const agentId = document.getElementById('files-agent').value;
            const userId = document.getElementById('files-user').value;
            if (!agentId || !userId) return;
            window.open(`/api/files/${agentId}/${userId}/download-all?token=${getStoredSessionToken()}`, '_blank');
        }

        async function uploadWorkspaceFile(event) {
            const file = event.target.files?.[0];
            if (!file) return;
            const agentId = document.getElementById('files-agent').value;
            const userId = document.getElementById('files-user').value;
            if (!agentId || !userId) return;
            const arr = await file.arrayBuffer();
            const contentBase64 = btoa(String.fromCharCode(...new Uint8Array(arr)));
            await fetch(`/api/files/${agentId}/${userId}/upload`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fileName: file.name, contentBase64 }) });
            loadWorkspaceFiles();
        }


        document.addEventListener('DOMContentLoaded', () => {
            const modalInput = document.getElementById('agent-chat-input');
            if (modalInput) {
                modalInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') sendAgentChatMessage();
                });
            }
        });

        init();
    </script>
</body>

</html>
