<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HermitClaw Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;500&display=swap');

        :root {
            --crab-orange: #ff6b35;
            --shell-gray: #1e293b;
            --ocean-dark: #0f172a;
            --term-green: #10b981;
        }

        body {
            background-color: var(--ocean-dark);
            color: #f8fafc;
            font-family: 'Outfit', sans-serif;
            overflow-x: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        .crab-float { animation: float 6s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(2deg); }
        }

        .claw-pinch {
            transform-origin: center;
            transition: transform 0.2s ease;
        }

        .gradient-text {
            background: linear-gradient(135deg, #ff6b35 0%, #f97316 50%, #fbbf24 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 107, 53, 0.1);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            border-color: rgba(255, 107, 53, 0.4);
            box-shadow: 0 10px 30px -10px rgba(255, 107, 53, 0.15);
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(16px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .scanline {
            width: 100%;
            height: 100px;
            z-index: 0;
            background: linear-gradient(0deg, rgba(255,107,53,0) 0%, rgba(255,107,53,0.03) 50%, rgba(255,107,53,0) 100%);
            opacity: 0.1;
            position: fixed;
            bottom: 100%;
            pointer-events: none;
            animation: scanline 8s linear infinite;
        }

        @keyframes scanline {
            0% { bottom: 100%; }
            100% { bottom: -100px; }
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--ocean-dark); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--crab-orange); }

        .terminal-output {
            background-color: #0c0a09;
            background-image: radial-gradient(rgba(30, 41, 59, 0.4) 1px, transparent 0);
            background-size: 20px 20px;
        }

        #xterm-container {
            height: 100%;
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }

        .xterm-viewport::-webkit-scrollbar { width: 8px; }
        .xterm-viewport::-webkit-scrollbar-track { background: #0c0a09; }
        .xterm-viewport::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex text-slate-200">

    <div class="scanline"></div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900 p-4 overflow-hidden">
        <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-orange-500/5 rounded-full blur-3xl pointer-events-none"></div>
        
        <div class="glass-card p-8 rounded-2xl w-full max-w-md shadow-2xl relative overflow-hidden">
            <div class="mb-8 text-center">
                <div class="relative w-24 h-24 mx-auto mb-4">
                    <svg id="auth-mascot" viewBox="0 0 200 200" class="w-full h-full crab-float">
                        <path d="M100 40C60 40 30 70 30 110C30 130 45 150 70 155C80 158 120 158 130 155C155 150 170 130 170 110C170 70 140 40 100 40Z" fill="#334155" />
                        <path d="M100 55C80 55 60 65 55 85C50 105 60 125 80 135" stroke="#475569" stroke-width="4" fill="none" stroke-linecap="round"/>
                        <g id="crab-body-auth">
                            <path d="M50 130L30 150" stroke="#ff6b35" stroke-width="8" stroke-linecap="round" />
                            <path d="M150 130L170 150" stroke="#ff6b35" stroke-width="8" stroke-linecap="round" />
                            <path d="M60 145L45 165" stroke="#ff6b35" stroke-width="8" stroke-linecap="round" />
                            <path d="M140 145L155 165" stroke="#ff6b35" stroke-width="8" stroke-linecap="round" />
                            <rect x="70" y="115" width="60" height="40" rx="20" fill="#ff6b35" />
                            <circle cx="85" cy="115" r="12" fill="#ff6b35" />
                            <circle cx="115" cy="115" r="12" fill="#ff6b35" />
                            <circle cx="85" cy="115" r="5" fill="black" />
                            <circle cx="115" cy="115" r="5" fill="black" />
                            <g id="left-claw-auth" class="claw-pinch">
                                <path d="M60 115Q40 115 35 100" stroke="#ff6b35" stroke-width="12" stroke-linecap="round" fill="none"/>
                                <path d="M35 105Q25 90 40 85" stroke="#ff6b35" stroke-width="10" stroke-linecap="round" fill="none"/>
                            </g>
                            <g id="right-claw-auth" class="claw-pinch">
                                <path d="M140 115Q160 115 165 100" stroke="#ff6b35" stroke-width="12" stroke-linecap="round" fill="none"/>
                                <path d="M165 105Q175 90 160 85" stroke="#ff6b35" stroke-width="10" stroke-linecap="round" fill="none"/>
                            </g>
                        </g>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold tracking-tight text-white mb-2">HermitClaw</h1>
                <p id="auth-title" class="text-orange-500 font-mono text-sm">SYSTEM_LOCKED</p>
            </div>

            <form id="auth-form" class="space-y-4" onsubmit="handleAuth(event)">
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">OPERATOR_ID</label>
                    <input type="text" id="username" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 focus:border-orange-500 outline-none transition-colors text-white" required autocomplete="off">
                </div>
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">ACCESS_KEY</label>
                    <input type="password" id="password" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 focus:border-orange-500 outline-none transition-colors text-white" required>
                </div>
                
                <div id="auth-error" class="text-red-400 text-xs font-mono hidden text-center"></div>

                <button type="submit" id="auth-btn" class="w-full bg-orange-600 hover:bg-orange-500 text-white py-3 rounded-lg font-bold transition-all shadow-lg shadow-orange-900/20">
                    Authenticate
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-ui" class="hidden flex w-full h-full">
        <aside class="w-64 glass-panel flex flex-col z-20 h-full fixed md:relative hidden md:flex">
            <div class="p-6 flex items-center space-x-3 border-b border-white/5">
                <svg viewBox="0 0 100 100" class="w-8 h-8 fill-orange-500 shrink-0">
                    <path d="M50 20C30 20 20 35 20 50C20 65 30 80 50 80C70 80 80 65 80 50C80 35 70 20 50 20ZM35 45C37.7 45 40 47.3 40 50C40 52.7 37.7 55 35 55C32.3 55 30 52.7 30 50C30 47.3 32.3 45 35 45ZM65 45C67.7 45 70 47.3 70 50C70 52.7 67.7 55 65 55C62.3 55 60 52.7 60 50C60 47.3 62.3 45 65 45Z"/>
                    <path d="M15 30L25 40M10 50L25 50M15 70L25 60M85 30L75 40M90 50L75 50M85 70L75 60" stroke="#ff6b35" stroke-width="5" stroke-linecap="round"/>
                </svg>
                <h1 class="font-bold tracking-tight text-lg text-white">HermitClaw</h1>
            </div>

            <nav class="flex-1 p-4 space-y-2">
                <a href="#" onclick="showSection('agents')" class="nav-item flex items-center space-x-3 px-4 py-3 bg-orange-500/10 text-orange-400 border border-orange-500/20 rounded-xl">
                    <i data-lucide="grid" class="w-5 h-5"></i>
                    <span class="font-semibold">Agents</span>
                </a>
                <a href="#" onclick="showSection('cubicles')" class="nav-item flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors">
                    <i data-lucide="box" class="w-5 h-5"></i>
                    <span>Cubicles</span>
                </a>
                <a href="#" onclick="showSection('audit')" class="nav-item flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors">
                    <i data-lucide="file-text" class="w-5 h-5"></i>
                    <span>Audit Logs</span>
                </a>
                <a href="#" onclick="showSection('metrics')" class="nav-item flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                    <span>Metrics</span>
                </a>
                <a href="#" onclick="showSection('allowlist')" class="nav-item flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span>Allowlist</span>
                </a>
                <a href="#" onclick="showSection('settings')" class="nav-item flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span>Settings</span>
                </a>
            </nav>

            <div class="p-6">
                <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative z-10 overflow-hidden">
            <header class="h-20 border-b border-white/5 flex items-center justify-between px-8 bg-slate-900/50 backdrop-blur-sm">
                <div>
                    <h2 class="text-2xl font-bold text-white" id="page-title">Mission Control</h2>
                    <p class="text-xs text-slate-400 mono mt-1">SYSTEM_STATUS: <span class="text-green-400">SECURE</span></p>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button onclick="openModal()" class="bg-orange-600 hover:bg-orange-500 text-white px-5 py-2 rounded-lg font-bold transition-all shadow-lg shadow-orange-900/20 flex items-center gap-2">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        <span>Spawn Agent</span>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8">
                <!-- Agents Section -->
                <div id="section-agents">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
                        <div class="glass-card p-5 rounded-2xl">
                            <div class="flex justify-between items-start mb-4">
                                <div class="p-2 bg-orange-500/10 rounded-lg text-orange-500"><i data-lucide="cpu" class="w-5 h-5"></i></div>
                                <span class="text-xs font-mono text-slate-500">DOCKER</span>
                            </div>
                            <div class="text-2xl font-bold text-white" id="stat-containers">0</div>
                            <div class="text-xs text-slate-400 mt-1">Active Cubicles</div>
                        </div>

                        <div class="glass-card p-5 rounded-2xl">
                            <div class="flex justify-between items-start mb-4">
                                <div class="p-2 bg-blue-500/10 rounded-lg text-blue-500"><i data-lucide="bot" class="w-5 h-5"></i></div>
                                <span class="text-xs font-mono text-slate-500">AGENTS</span>
                            </div>
                            <div class="text-2xl font-bold text-white" id="stat-agents">0</div>
                            <div class="text-xs text-slate-400 mt-1">Registered Identities</div>
                        </div>

                        <div class="glass-card p-5 rounded-2xl">
                            <div class="flex justify-between items-start mb-4">
                                <div class="p-2 bg-green-500/10 rounded-lg text-green-500"><i data-lucide="dollar-sign" class="w-5 h-5"></i></div>
                                <span class="text-xs font-mono text-slate-500">SPEND (24H)</span>
                            </div>
                            <div class="text-2xl font-bold text-white" id="stat-spend">$0.00</div>
                            <div class="text-xs text-slate-400 mt-1">Total Compute Cost</div>
                        </div>

                        <div class="glass-card p-5 rounded-2xl">
                            <div class="flex justify-between items-start mb-4">
                                <div class="p-2 bg-purple-500/10 rounded-lg text-purple-500"><i data-lucide="shield" class="w-5 h-5"></i></div>
                                <span class="text-xs font-mono text-slate-500">SECURITY</span>
                            </div>
                            <div class="text-xl font-bold text-white">Secure</div>
                            <div class="text-xs text-slate-400 mt-1">Containers Isolated</div>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                        <i data-lucide="grid" class="w-5 h-5 text-orange-500"></i>
                        Deployed Agents
                    </h3>

                    <div id="agent-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
                </div>

                <!-- Cubicles Section -->
                <div id="section-cubicles" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <i data-lucide="box" class="w-5 h-5 text-orange-500"></i>
                            Running Cubicles
                        </h3>
                        <button onclick="loadCubicles()" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg font-medium transition-all text-sm flex items-center gap-2 border border-slate-700">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            Refresh
                        </button>
                    </div>

                    <div class="glass-card rounded-2xl overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-800/50 text-slate-400">
                                <tr>
                                    <th class="px-4 py-3 text-left font-mono">CONTAINER ID</th>
                                    <th class="px-4 py-3 text-left font-mono">IMAGE</th>
                                    <th class="px-4 py-3 text-left font-mono">STATUS</th>
                                    <th class="px-4 py-3 text-left font-mono">CREATED</th>
                                    <th class="px-4 py-3 text-left font-mono">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="cubicles-tbody" class="divide-y divide-slate-800">
                            </tbody>
                        </table>
                        <div id="cubicles-empty" class="p-8 text-center text-slate-500 hidden">
                            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 text-slate-600"></i>
                            <p>No running cubicles. Spawn an agent to create a cubicle.</p>
                        </div>
                    </div>
                </div>

                <!-- Audit Logs Section -->
                <div id="section-audit" class="hidden">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                        <i data-lucide="file-text" class="w-5 h-5 text-orange-500"></i>
                        Audit Logs
                    </h3>

                    <div class="glass-card rounded-2xl overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-800/50 text-slate-400">
                                <tr>
                                    <th class="px-4 py-3 text-left font-mono">TIMESTAMP</th>
                                    <th class="px-4 py-3 text-left font-mono">AGENT</th>
                                    <th class="px-4 py-3 text-left font-mono">COMMAND</th>
                                    <th class="px-4 py-3 text-left font-mono">STATUS</th>
                                    <th class="px-4 py-3 text-left font-mono">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="audit-tbody" class="divide-y divide-slate-800">
                            </tbody>
                        </table>
                        <div id="audit-empty" class="p-8 text-center text-slate-500 hidden">
                            No audit logs yet. Commands requiring approval will appear here.
                        </div>
                    </div>
                </div>

                <!-- Metrics Section -->
                <div id="section-metrics" class="hidden">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 text-orange-500"></i>
                        System Metrics
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="glass-card p-5 rounded-2xl">
                            <div class="flex justify-between items-start mb-4">
                                <div class="p-2 bg-green-500/10 rounded-lg text-green-500"><i data-lucide="server" class="w-5 h-5"></i></div>
                                <span class="text-xs font-mono text-slate-500">DOCKER</span>
                            </div>
                            <div class="text-2xl font-bold text-white" id="metric-containers">0</div>
                            <div class="text-xs text-slate-400 mt-1">Running Containers</div>
                        </div>

                        <div class="glass-card p-5 rounded-2xl">
                            <div class="flex justify-between items-start mb-4">
                                <div class="p-2 bg-blue-500/10 rounded-lg text-blue-500"><i data-lucide="bot" class="w-5 h-5"></i></div>
                                <span class="text-xs font-mono text-slate-500">AGENTS</span>
                            </div>
                            <div class="text-2xl font-bold text-white" id="metric-agents">0</div>
                            <div class="text-xs text-slate-400 mt-1">Total Agents</div>
                        </div>

                        <div class="glass-card p-5 rounded-2xl">
                            <div class="flex justify-between items-start mb-4">
                                <div class="p-2 bg-orange-500/10 rounded-lg text-orange-500"><i data-lucide="dollar-sign" class="w-5 h-5"></i></div>
                                <span class="text-xs font-mono text-slate-500">SPEND</span>
                            </div>
                            <div class="text-2xl font-bold text-white" id="metric-spend">$0.00</div>
                            <div class="text-xs text-slate-400 mt-1">Today's Spend</div>
                        </div>

                        <div class="glass-card p-5 rounded-2xl">
                            <div class="flex justify-between items-start mb-4">
                                <div class="p-2 bg-purple-500/10 rounded-lg text-purple-500"><i data-lucide="shield" class="w-5 h-5"></i></div>
                                <span class="text-xs font-mono text-slate-500">ALLOWLIST</span>
                            </div>
                            <div class="text-2xl font-bold text-white" id="metric-allowlist">0</div>
                            <div class="text-xs text-slate-400 mt-1">Allowed Users</div>
                        </div>
                    </div>

                    <div class="glass-card p-6 rounded-2xl">
                        <h4 class="text-white font-bold mb-4">API Keys Status</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex items-center justify-between bg-slate-800 p-4 rounded-lg">
                                <span class="text-slate-300">OpenAI API Key</span>
                                <span id="metric-openai" class="text-xs font-mono px-2 py-1 rounded bg-red-500/20 text-red-400">Not Set</span>
                            </div>
                            <div class="flex items-center justify-between bg-slate-800 p-4 rounded-lg">
                                <span class="text-slate-300">OpenRouter API Key</span>
                                <span id="metric-openrouter" class="text-xs font-mono px-2 py-1 rounded bg-red-500/20 text-red-400">Not Set</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Allowlist Section -->
                <div id="section-allowlist" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <i data-lucide="users" class="w-5 h-5 text-orange-500"></i>
                            User Allowlist
                        </h3>
                        <button onclick="openAllowlistModal()" class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-lg font-bold transition-all text-sm flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Add User
                        </button>
                    </div>

                    <div class="glass-card rounded-2xl overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-800/50 text-slate-400">
                                <tr>
                                    <th class="px-4 py-3 text-left font-mono">USER ID</th>
                                    <th class="px-4 py-3 text-left font-mono">USERNAME</th>
                                    <th class="px-4 py-3 text-left font-mono">FIRST NAME</th>
                                    <th class="px-4 py-3 text-left font-mono">ADDED</th>
                                    <th class="px-4 py-3 text-left font-mono">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="allowlist-tbody" class="divide-y divide-slate-800">
                            </tbody>
                        </table>
                        <div id="allowlist-empty" class="p-8 text-center text-slate-500 hidden">
                            No users in allowlist yet. Add users to control who can access your agents.
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="section-settings" class="hidden">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                        <i data-lucide="settings" class="w-5 h-5 text-orange-500"></i>
                        Settings
                    </h3>

                    <!-- General Settings -->
                    <div class="glass-card p-6 rounded-2xl mb-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="p-2 bg-blue-500/10 rounded-lg text-blue-500"><i data-lucide="globe" class="w-5 h-5"></i></div>
                            <h4 class="text-lg font-bold text-white">General</h4>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <label class="text-xs font-mono text-slate-400">PUBLIC_URL</label>
                                    <button onclick="openPublicUrlGuide()" class="text-slate-400 hover:text-orange-500 transition-colors" title="Why do I need this?">
                                        <i data-lucide="help-circle" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <input type="url" id="setting-public_url" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="https://your-domain.com">
                            </div>
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="setting-hitl_enabled" class="w-4 h-4 rounded border-slate-600 bg-slate-800 text-orange-500 focus:ring-orange-500">
                                <label for="setting-hitl_enabled" class="text-sm text-slate-300">Enable Human-in-the-Loop (HITL) by default</label>
                            </div>
                            <div>
                                <label class="block text-xs font-mono text-slate-400 mb-2">DEFAULT_DAILY_LIMIT (USD)</label>
                                <input type="number" step="0.01" id="setting-default_daily_limit" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="1.00">
                            </div>
                        </div>
                    </div>

                    <!-- LLM Provider Settings -->
                    <div class="glass-card p-6 rounded-2xl mb-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="p-2 bg-purple-500/10 rounded-lg text-purple-500"><i data-lucide="cpu" class="w-5 h-5"></i></div>
                            <h4 class="text-lg font-bold text-white">LLM Provider</h4>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-mono text-slate-400 mb-2">PROVIDER</label>
                                <select id="setting-default_provider" onchange="updateModelOptions()" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors">
                                    <option value="openrouter">OpenRouter (Multi-provider)</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="anthropic">Anthropic (Claude)</option>
                                    <option value="google">Google (Gemini)</option>
                                    <option value="groq">Groq (Fast Inference)</option>
                                    <option value="mistral">Mistral AI</option>
                                    <option value="deepseek">DeepSeek</option>
                                    <option value="xai">xAI (Grok)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-mono text-slate-400 mb-2">MODEL</label>
                                <select id="setting-default_model" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors">
                                </select>
                                <input type="text" id="setting-custom_model" class="hidden w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors mt-2" placeholder="Enter custom model name...">
                            </div>
                        </div>
                    </div>

                    <!-- API Keys -->
                    <div class="glass-card p-6 rounded-2xl mb-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="p-2 bg-green-500/10 rounded-lg text-green-500"><i data-lucide="key" class="w-5 h-5"></i></div>
                            <h4 class="text-lg font-bold text-white">API Keys</h4>
                        </div>
                        <p class="text-slate-400 text-sm mb-4">Keys are stored in the database. Environment variables take precedence if set.</p>
                        <div class="space-y-4">
                            <div class="provider-key" data-provider="openrouter">
                                <label class="block text-xs font-mono text-slate-400 mb-2">OPENROUTER_API_KEY</label>
                                <input type="password" id="setting-openrouter_api_key" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="sk-or-...">
                            </div>
                            <div class="provider-key" data-provider="openai">
                                <label class="block text-xs font-mono text-slate-400 mb-2">OPENAI_API_KEY</label>
                                <input type="password" id="setting-openai_api_key" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="sk-...">
                            </div>
                            <div class="provider-key" data-provider="anthropic">
                                <label class="block text-xs font-mono text-slate-400 mb-2">ANTHROPIC_API_KEY</label>
                                <input type="password" id="setting-anthropic_api_key" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="sk-ant-...">
                            </div>
                            <div class="provider-key" data-provider="google">
                                <label class="block text-xs font-mono text-slate-400 mb-2">GOOGLE_API_KEY</label>
                                <input type="password" id="setting-google_api_key" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="AIza...">
                            </div>
                            <div class="provider-key" data-provider="groq">
                                <label class="block text-xs font-mono text-slate-400 mb-2">GROQ_API_KEY</label>
                                <input type="password" id="setting-groq_api_key" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="gsk_...">
                            </div>
                            <div class="provider-key" data-provider="mistral">
                                <label class="block text-xs font-mono text-slate-400 mb-2">MISTRAL_API_KEY</label>
                                <input type="password" id="setting-mistral_api_key" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="...">
                            </div>
                            <div class="provider-key" data-provider="deepseek">
                                <label class="block text-xs font-mono text-slate-400 mb-2">DEEPSEEK_API_KEY</label>
                                <input type="password" id="setting-deepseek_api_key" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="sk-...">
                            </div>
                            <div class="provider-key" data-provider="xai">
                                <label class="block text-xs font-mono text-slate-400 mb-2">XAI_API_KEY</label>
                                <input type="password" id="setting-xai_api_key" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="xai-...">
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="flex justify-end">
                        <button onclick="saveSettings()" class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-3 rounded-lg font-bold transition-all flex items-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            Save All Settings
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Agent Modal -->
    <div id="create-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden relative">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-slate-800/50">
                <h3 class="text-lg font-bold text-white">Initialize New Agent</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">DESIGNATION (NAME)</label>
                    <input type="text" id="new-name" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="e.g., Sherlock">
                </div>
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">ROLE DESCRIPTION</label>
                    <input type="text" id="new-role" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="e.g., Security Researcher">
                </div>
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">TELEGRAM TOKEN</label>
                    <input type="password" id="new-token" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="From @BotFather">
                </div>
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">DOCKER IMAGE</label>
                    <select id="new-image" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors">
                        <option value="hermit/base:latest">hermit/base (General Tools)</option>
                        <option value="hermit/python:latest">hermit/python (Data Analysis)</option>
                        <option value="hermit/netsec:latest">hermit/netsec (Security Tools)</option>
                    </select>
                </div>
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="new-require-approval" class="w-4 h-4 rounded border-slate-600 bg-slate-800 text-orange-500 focus:ring-orange-500">
                    <label for="new-require-approval" class="text-sm text-slate-300">Require approval for dangerous commands (HITL)</label>
                </div>
            </div>
            <div class="p-6 pt-0 flex justify-end">
                <button onclick="createAgent()" class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-2 rounded-lg font-bold transition-all">
                    Deploy to Cubicle
                </button>
            </div>
        </div>
    </div>

    <!-- Terminal Modal with xterm.js -->
    <div id="terminal-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-4">
        <div class="w-full max-w-4xl h-[80vh] bg-[#0c0a09] border border-slate-700 rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div class="bg-slate-800 px-4 py-2 flex justify-between items-center border-b border-slate-700">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                    <span id="term-title" class="ml-2 text-slate-400">root@hermitclaw:~</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="attachTerminal()" class="text-orange-500 hover:text-white text-sm" title="Attach to container">
                        <i data-lucide="link" class="w-4 h-4"></i>
                    </button>
                    <button onclick="closeTerminal()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            </div>
            <div id="xterm-container"></div>
        </div>
    </div>

    <!-- Webhook Guide Modal -->
    <div id="webhook-guide-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden relative max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-slate-800/50 sticky top-0">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i data-lucide="webhook" class="w-5 h-5 text-blue-500"></i>
                    Telegram Webhook Setup Guide
                </h3>
                <button onclick="closeWebhookGuide()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-6 text-slate-300">
                <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-4">
                    <p class="text-sm text-blue-300"><strong>What is a Webhook?</strong> A webhook tells Telegram to send messages to your HermitClaw server instead of your bot polling for updates. It's the standard way to receive messages in production.</p>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-2 flex items-center gap-2"><span class="bg-orange-600 text-xs px-2 py-0.5 rounded">1</span> Get Your Public URL</h4>
                    <p class="text-sm text-slate-400 mb-3">Your server must be accessible from the internet. If running locally, use a tunnel service:</p>
                    <div class="bg-slate-800 p-3 rounded-lg font-mono text-sm text-green-400">
# Using Cloudflare Tunnel (recommended)<br>
curl -sL https://run.cloudflare.com/ | sh<br>
cloudflared tunnel create hermitclaw<br>
cloudflared tunnel url hermitclaw
                    </div>
                    <p class="text-xs text-slate-500 mt-2">Or use <a href="https://ngrok.com" target="_blank" class="text-orange-400 hover:underline">ngrok</a>: <code class="bg-slate-800 px-1 rounded">ngrok http 3000</code></p>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-2 flex items-center gap-2"><span class="bg-orange-600 text-xs px-2 py-0.5 rounded">2</span> Set Your Public URL in Dashboard</h4>
                    <p class="text-sm text-slate-400 mb-3">Go to Settings and update the <code class="bg-slate-800 px-1 rounded">public_url</code> setting with your public URL (e.g., <code class="bg-slate-800 px-1 rounded">https://your-tunnel-url.cloudflare.net</code>)</p>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-2 flex items-center gap-2"><span class="bg-orange-600 text-xs px-2 py-0.5 rounded">3</span> Set the Webhook via API</h4>
                    <p class="text-sm text-slate-400 mb-3">Run this command in your terminal:</p>
                    <div class="bg-slate-800 p-3 rounded-lg font-mono text-sm">
<span class="text-blue-400">curl</span> -X POST \<br>
&nbsp;&nbsp;"https://api.telegram.org/bot<span class="text-orange-400">&lt;YOUR_BOT_TOKEN&gt;</span>/setWebhook" \<br>
&nbsp;&nbsp;-d "url=<span class="text-green-400">&lt;YOUR_PUBLIC_URL&gt;</span>/webhook/<span class="text-orange-400">&lt;YOUR_BOT_TOKEN&gt;</span>"
                    </div>
                    <p class="text-xs text-slate-500 mt-2">Replace <code class="bg-slate-800 px-1 rounded">&lt;YOUR_BOT_TOKEN&gt;</code> with your Telegram bot token and <code class="bg-slate-800 px-1 rounded">&lt;YOUR_PUBLIC_URL&gt;</code> with your public URL.</p>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-2 flex items-center gap-2"><span class="bg-orange-600 text-xs px-2 py-0.5 rounded">4</span> Verify It Works</h4>
                    <p class="text-sm text-slate-400 mb-3">Check your webhook info:</p>
                    <div class="bg-slate-800 p-3 rounded-lg font-mono text-sm">
<span class="text-blue-400">curl</span> "https://api.telegram.org/bot<span class="text-orange-400">&lt;BOT_TOKEN&gt;</span>/getWebhookInfo"
                    </div>
                    <p class="text-xs text-green-400 mt-2">✅ You should see <code class="bg-slate-800 px-1 rounded">"ok":true</code> and your webhook URL listed.</p>
                </div>

                <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-4">
                    <p class="text-sm text-yellow-300"><strong>⚠️ Important:</strong> Your public URL must be HTTPS (Telegram requires it). If using a tunnel service, it provides HTTPS automatically.</p>
                </div>

                <div class="text-center pt-4">
                    <button onclick="closeWebhookGuide()" class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-2 rounded-lg font-bold transition-all">
                        Got It!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Public URL Guide Modal -->
    <div id="public-url-guide-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden relative max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-slate-800/50 sticky top-0">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i data-lucide="globe" class="w-5 h-5 text-blue-500"></i>
                    Why Do I Need a Public URL?
                </h3>
                <button onclick="closePublicUrlGuide()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-6 text-slate-300">
                <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-4">
                    <p class="text-sm text-blue-300"><strong>Short Answer:</strong> Telegram needs to send messages to your HermitClaw server. Without a public URL, Telegram can't reach your server.</p>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-3">What is a Public URL?</h4>
                    <p class="text-sm text-slate-400">A public URL is an internet address (like <code class="bg-slate-800 px-1 rounded">https://your-server.com</code>) that can be accessed from anywhere on the internet. It allows external services like Telegram to send data to your server.</p>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-3">Why Does HermitClaw Need It?</h4>
                    <ul class="text-sm text-slate-400 space-y-2">
                        <li class="flex items-start gap-2">
                            <i data-lucide="check-circle" class="w-4 h-4 text-green-500 mt-0.5 shrink-0"></i>
                            <span><strong>Telegram Webhooks:</strong> When someone messages your bot, Telegram sends the message to your public URL</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i data-lucide="check-circle" class="w-4 h-4 text-green-500 mt-0.5 shrink-0"></i>
                            <span><strong>HITL Approvals:</strong> Approval requests from your agents are delivered via this URL</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i data-lucide="check-circle" class="w-4 h-4 text-green-500 mt-0.5 shrink-0"></i>
                            <span><strong>Remote Access:</strong> Access your dashboard from anywhere</span>
                        </li>
                    </ul>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-3">How to Get a Public URL</h4>
                    
                    <div class="space-y-4">
                        <div class="bg-slate-800/50 p-4 rounded-xl">
                            <h5 class="text-orange-400 font-semibold mb-2 flex items-center gap-2">
                                <span class="bg-orange-600 text-xs px-2 py-0.5 rounded">EASIEST</span>
                                Option 1: Tunnel Service (Free)
                            </h5>
                            <p class="text-sm text-slate-400 mb-3">Best for development and testing. Creates a secure tunnel to your local machine.</p>
                            <div class="bg-slate-900 p-3 rounded-lg font-mono text-xs space-y-2">
                                <p class="text-slate-500"># Using Cloudflare Tunnel (recommended)</p>
                                <p class="text-green-400">cloudflared tunnel --url http://localhost:3000</p>
                                <p class="text-slate-500 mt-2"># Or using ngrok</p>
                                <p class="text-green-400">ngrok http 3000</p>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">Copy the generated URL (e.g., <code class="bg-slate-800 px-1 rounded">https://random-name.trycloudflare.com</code>)</p>
                        </div>

                        <div class="bg-slate-800/50 p-4 rounded-xl">
                            <h5 class="text-blue-400 font-semibold mb-2 flex items-center gap-2">
                                <span class="bg-blue-600 text-xs px-2 py-0.5 rounded">PRODUCTION</span>
                                Option 2: Cloud Server
                            </h5>
                            <p class="text-sm text-slate-400 mb-3">For production deployments on VPS/cloud providers.</p>
                            <ul class="text-sm text-slate-500 space-y-1">
                                <li>• Rent a VPS (DigitalOcean, Linode, AWS, etc.)</li>
                                <li>• Point a domain to your server's IP</li>
                                <li>• Set up SSL with Let's Encrypt/Caddy</li>
                                <li>• Use your domain: <code class="bg-slate-800 px-1 rounded">https://hermitclaw.yourdomain.com</code></li>
                            </ul>
                        </div>

                        <div class="bg-slate-800/50 p-4 rounded-xl">
                            <h5 class="text-purple-400 font-semibold mb-2 flex items-center gap-2">
                                <span class="bg-purple-600 text-xs px-2 py-0.5 rounded">LOCAL</span>
                                Option 3: Local Network Only
                            </h5>
                            <p class="text-sm text-slate-400 mb-3">If you only need local access (no Telegram webhooks).</p>
                            <p class="text-sm text-slate-500">Leave this field empty. You can still use the dashboard at <code class="bg-slate-800 px-1 rounded">http://localhost:3000</code></p>
                            <p class="text-xs text-yellow-400 mt-2">⚠️ Telegram bots will NOT work without a public URL</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-3">What You Need to Do</h4>
                    <ol class="text-sm text-slate-400 space-y-3">
                        <li class="flex gap-3">
                            <span class="bg-orange-600 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center shrink-0">1</span>
                            <span>Run a tunnel service OR deploy to a cloud server with a domain</span>
                        </li>
                        <li class="flex gap-3">
                            <span class="bg-orange-600 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center shrink-0">2</span>
                            <span>Copy your public HTTPS URL</span>
                        </li>
                        <li class="flex gap-3">
                            <span class="bg-orange-600 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center shrink-0">3</span>
                            <span>Paste it in the PUBLIC_URL field and click "Save All Settings"</span>
                        </li>
                        <li class="flex gap-3">
                            <span class="bg-orange-600 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center shrink-0">4</span>
                            <span>Set up your Telegram webhook (see Webhook Guide in Settings)</span>
                        </li>
                    </ol>
                </div>

                <div class="bg-green-500/10 border border-green-500/20 rounded-xl p-4">
                    <p class="text-sm text-green-300"><strong>✅ Requirements:</strong> The URL must be HTTPS (not HTTP). Telegram requires secure connections.</p>
                </div>

                <div class="text-center pt-4">
                    <button onclick="closePublicUrlGuide()" class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-2 rounded-lg font-bold transition-all">
                        Got It!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User to Allowlist Modal -->
    <div id="allowlist-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-slate-800/50">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i data-lucide="user-plus" class="w-5 h-5 text-orange-500"></i>
                    Add User to Allowlist
                </h3>
                <button onclick="closeAllowlistModal()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">TELEGRAM USER ID *</label>
                    <input type="number" id="allowlist-user-id" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="e.g., 123456789">
                    <p class="text-xs text-slate-500 mt-1">Ask the user to send /start to @userinfobot on Telegram to get their ID</p>
                </div>
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">USERNAME (optional)</label>
                    <input type="text" id="allowlist-username" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="@username">
                </div>
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">FIRST NAME (optional)</label>
                    <input type="text" id="allowlist-first-name" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="John">
                </div>
            </div>
            <div class="p-6 pt-0 flex justify-end gap-3">
                <button onclick="closeAllowlistModal()" class="px-4 py-2 text-slate-400 hover:text-white">Cancel</button>
                <button onclick="addAllowlistUser()" class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-2 rounded-lg font-bold transition-all">
                    Add User
                </button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let authState = 'loading';
        let currentAgentId = null;
        let currentContainerId = null;
        let term = null;
        let fitAddon = null;
        let ws = null;

        function openWebhookGuide() {
            document.getElementById('webhook-guide-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeWebhookGuide() {
            document.getElementById('webhook-guide-modal').classList.add('hidden');
        }

        function openPublicUrlGuide() {
            document.getElementById('public-url-guide-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closePublicUrlGuide() {
            document.getElementById('public-url-guide-modal').classList.add('hidden');
        }

        async function init() {
            try {
                const res = await fetch('/api/auth/status');
                const data = await res.json();
                
                if (data.status === 'authenticated') {
                    showDashboard();
                } else if (data.status === 'setup_required') {
                    showAuthScreen('INITIALIZE SYSTEM', 'Create Admin Account');
                    authState = 'setup_required';
                } else {
                    showAuthScreen('SYSTEM LOCKED', 'Authenticate');
                    authState = 'login_required';
                }
            } catch (e) {
                console.error("Auth check failed", e);
                showAuthScreen('SYSTEM ERROR', 'Retry');
            }
        }

        function showAuthScreen(title, btnText) {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('dashboard-ui').classList.add('hidden');
            document.getElementById('auth-title').innerText = title;
            document.getElementById('auth-btn').innerText = btnText;
        }

        function showDashboard() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('dashboard-ui').classList.remove('hidden');
            loadStats();
            loadAgents();
            loadAuditLogs();
            setInterval(() => { 
                loadStats(); 
                loadAgents(); 
            }, 10000);
        }

        function showSection(section) {
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-orange-500/10', 'text-orange-400', 'border-orange-500/20');
                el.classList.add('text-slate-400', 'hover:text-white', 'hover:bg-white/5');
            });
            event.target.closest('.nav-item').classList.add('bg-orange-500/10', 'text-orange-400', 'border-orange-500/20');
            event.target.closest('.nav-item').classList.remove('text-slate-400', 'hover:text-white', 'hover:bg-white/5');

            document.getElementById('section-agents').classList.add('hidden');
            document.getElementById('section-audit').classList.add('hidden');
            document.getElementById('section-settings').classList.add('hidden');
            document.getElementById('section-metrics').classList.add('hidden');
            document.getElementById('section-allowlist').classList.add('hidden');
            document.getElementById('section-cubicles').classList.add('hidden');
            document.getElementById('section-' + section).classList.remove('hidden');

            const titles = {
                'agents': 'Mission Control',
                'cubicles': 'Running Cubicles',
                'audit': 'Audit Logs',
                'settings': 'Settings',
                'metrics': 'System Metrics',
                'allowlist': 'User Allowlist'
            };
            document.getElementById('page-title').innerText = titles[section] || 'Mission Control';

            if (section === 'audit') loadAuditLogs();
            if (section === 'metrics') loadMetrics();
            if (section === 'allowlist') loadAllowlist();
            if (section === 'settings') loadSettings();
            if (section === 'cubicles') loadCubicles();
        }

        const PROVIDER_MODELS = {
            openrouter: [
                { value: 'anthropic/claude-3.5-sonnet', label: 'Claude 3.5 Sonnet (via OpenRouter)' },
                { value: 'anthropic/claude-3-opus', label: 'Claude 3 Opus (via OpenRouter)' },
                { value: 'openai/gpt-4o', label: 'GPT-4o (via OpenRouter)' },
                { value: 'openai/gpt-4-turbo', label: 'GPT-4 Turbo (via OpenRouter)' },
                { value: 'google/gemini-pro-1.5', label: 'Gemini 1.5 Pro (via OpenRouter)' },
                { value: 'meta-llama/llama-3.3-70b-instruct', label: 'Llama 3.3 70B (via OpenRouter)' },
                { value: 'mistralai/mistral-large', label: 'Mistral Large (via OpenRouter)' },
                { value: 'deepseek/deepseek-chat', label: 'DeepSeek Chat (via OpenRouter)' },
                { value: 'auto', label: 'Auto (Best Free)' },
                { value: '__custom__', label: 'Custom Model...' }
            ],
            openai: [
                { value: 'gpt-4o', label: 'GPT-4o' },
                { value: 'gpt-4o-mini', label: 'GPT-4o Mini' },
                { value: 'gpt-4-turbo', label: 'GPT-4 Turbo' },
                { value: 'gpt-4', label: 'GPT-4' },
                { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo' },
                { value: 'o1-preview', label: 'o1 Preview' },
                { value: 'o1-mini', label: 'o1 Mini' },
                { value: '__custom__', label: 'Custom Model...' }
            ],
            anthropic: [
                { value: 'claude-3-5-sonnet-20241022', label: 'Claude 3.5 Sonnet' },
                { value: 'claude-3-opus-20240229', label: 'Claude 3 Opus' },
                { value: 'claude-3-haiku-20240307', label: 'Claude 3 Haiku' },
                { value: '__custom__', label: 'Custom Model...' }
            ],
            google: [
                { value: 'gemini-1.5-pro', label: 'Gemini 1.5 Pro' },
                { value: 'gemini-1.5-flash', label: 'Gemini 1.5 Flash' },
                { value: 'gemini-1.0-pro', label: 'Gemini 1.0 Pro' },
                { value: '__custom__', label: 'Custom Model...' }
            ],
            groq: [
                { value: 'llama-3.3-70b-versatile', label: 'Llama 3.3 70B Versatile' },
                { value: 'llama-3.1-70b-versatile', label: 'Llama 3.1 70B Versatile' },
                { value: 'llama-3.1-8b-instant', label: 'Llama 3.1 8B Instant' },
                { value: 'mixtral-8x7b-32768', label: 'Mixtral 8x7B' },
                { value: 'gemma2-9b-it', label: 'Gemma 2 9B' },
                { value: '__custom__', label: 'Custom Model...' }
            ],
            mistral: [
                { value: 'mistral-large-latest', label: 'Mistral Large' },
                { value: 'mistral-medium-latest', label: 'Mistral Medium' },
                { value: 'mistral-small-latest', label: 'Mistral Small' },
                { value: 'codestral-latest', label: 'Codestral (Code)' },
                { value: '__custom__', label: 'Custom Model...' }
            ],
            deepseek: [
                { value: 'deepseek-chat', label: 'DeepSeek Chat' },
                { value: 'deepseek-coder', label: 'DeepSeek Coder' },
                { value: '__custom__', label: 'Custom Model...' }
            ],
            xai: [
                { value: 'grok-beta', label: 'Grok Beta' },
                { value: '__custom__', label: 'Custom Model...' }
            ]
        };

        function updateModelOptions() {
            const provider = document.getElementById('setting-default_provider').value;
            const modelSelect = document.getElementById('setting-default_model');
            const customInput = document.getElementById('setting-custom_model');
            
            modelSelect.innerHTML = '';
            const models = PROVIDER_MODELS[provider] || [];
            
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.label;
                modelSelect.appendChild(option);
            });

            modelSelect.onchange = () => {
                if (modelSelect.value === '__custom__') {
                    customInput.classList.remove('hidden');
                    customInput.focus();
                } else {
                    customInput.classList.add('hidden');
                }
            };
            
            customInput.classList.add('hidden');
        }

        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                if (res.status === 401) return logout();
                const settings = await res.json();

                // General settings
                document.getElementById('setting-public_url').value = settings.public_url || '';
                document.getElementById('setting-hitl_enabled').checked = settings.hitl_enabled === 'true';
                document.getElementById('setting-default_daily_limit').value = settings.default_daily_limit || '1.00';

                // Provider and model
                document.getElementById('setting-default_provider').value = settings.default_provider || 'openrouter';
                updateModelOptions();
                
                const modelSelect = document.getElementById('setting-default_model');
                const savedModel = settings.default_model || 'auto';
                const models = PROVIDER_MODELS[settings.default_provider] || [];
                const modelExists = models.some(m => m.value === savedModel);
                
                if (modelExists) {
                    modelSelect.value = savedModel;
                } else if (savedModel) {
                    modelSelect.value = '__custom__';
                    document.getElementById('setting-custom_model').classList.remove('hidden');
                    document.getElementById('setting-custom_model').value = savedModel;
                }

                // API Keys
                document.getElementById('setting-openrouter_api_key').value = settings.openrouter_api_key || '';
                document.getElementById('setting-openai_api_key').value = settings.openai_api_key || '';
                document.getElementById('setting-anthropic_api_key').value = settings.anthropic_api_key || '';
                document.getElementById('setting-google_api_key').value = settings.google_api_key || '';
                document.getElementById('setting-groq_api_key').value = settings.groq_api_key || '';
                document.getElementById('setting-mistral_api_key').value = settings.mistral_api_key || '';
                document.getElementById('setting-deepseek_api_key').value = settings.deepseek_api_key || '';
                document.getElementById('setting-xai_api_key').value = settings.xai_api_key || '';
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        async function saveSettings() {
            const settings = {
                public_url: document.getElementById('setting-public_url').value,
                hitl_enabled: document.getElementById('setting-hitl_enabled').checked ? 'true' : 'false',
                default_daily_limit: document.getElementById('setting-default_daily_limit').value,
                default_provider: document.getElementById('setting-default_provider').value,
                default_model: document.getElementById('setting-default_model').value === '__custom__' 
                    ? document.getElementById('setting-custom_model').value 
                    : document.getElementById('setting-default_model').value,
                openrouter_api_key: document.getElementById('setting-openrouter_api_key').value,
                openai_api_key: document.getElementById('setting-openai_api_key').value,
                anthropic_api_key: document.getElementById('setting-anthropic_api_key').value,
                google_api_key: document.getElementById('setting-google_api_key').value,
                groq_api_key: document.getElementById('setting-groq_api_key').value,
                mistral_api_key: document.getElementById('setting-mistral_api_key').value,
                deepseek_api_key: document.getElementById('setting-deepseek_api_key').value,
                xai_api_key: document.getElementById('setting-xai_api_key').value,
            };

            try {
                const res = await fetch('/api/settings/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                if (res.ok) {
                    alert('Settings saved successfully!');
                } else {
                    alert('Failed to save settings');
                }
            } catch (e) {
                alert('Error saving settings: ' + e.message);
            }
        }

        async function handleAuth(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('auth-error');
            errorDiv.classList.add('hidden');

            const endpoint = authState === 'setup_required' ? '/api/auth/setup' : '/api/auth/login';

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await res.json();

                if (!res.ok) throw new Error(data.error || 'Operation failed');

                if (authState === 'setup_required') {
                    alert('System Initialized. Please login.');
                    window.location.reload();
                } else {
                    showDashboard();
                }
            } catch (err) {
                errorDiv.innerText = `ERROR: ${err.message}`;
                errorDiv.classList.remove('hidden');
            }
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.reload();
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                if(res.status === 401) return logout();
                const data = await res.json();
                document.getElementById('stat-containers').innerText = data.activeContainers;
                document.getElementById('stat-agents').innerText = data.totalAgents;
                document.getElementById('stat-spend').innerText = '$' + data.totalSpendToday.toFixed(4);
            } catch (e) {}
        }

        async function loadCubicles() {
            try {
                const res = await fetch('/api/containers');
                if(res.status === 401) return logout();
                const containers = await res.json();
                const tbody = document.getElementById('cubicles-tbody');
                const empty = document.getElementById('cubicles-empty');

                const hermitContainers = containers.filter(c => 
                    c.Image && (c.Image.startsWith('hermit/') || c.Image.startsWith('hermit-crab'))
                );

                if (hermitContainers.length === 0) {
                    tbody.innerHTML = '';
                    empty.classList.remove('hidden');
                    lucide.createIcons();
                    return;
                }

                empty.classList.add('hidden');
                tbody.innerHTML = hermitContainers.map(c => {
                    const statusColor = c.State === 'running' ? 'text-green-400' : c.State === 'exited' ? 'text-red-400' : 'text-yellow-400';
                    const statusIcon = c.State === 'running' ? '●' : '○';
                    return `
                        <tr class="hover:bg-white/5">
                            <td class="px-4 py-3 font-mono text-slate-400">${c.Id.substring(0, 12)}</td>
                            <td class="px-4 py-3">${c.Image}</td>
                            <td class="px-4 py-3 ${statusColor} font-mono">${statusIcon} ${c.State.toUpperCase()}</td>
                            <td class="px-4 py-3 text-slate-400">${c.Status}</td>
                            <td class="px-4 py-3 flex gap-2">
                                <button onclick="viewContainer('${c.Id}')" class="text-orange-500 hover:text-white text-xs">Terminal</button>
                                <button onclick="stopContainer('${c.Id}')" class="text-red-400 hover:text-white text-xs">Stop</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                lucide.createIcons();
            } catch (e) {
                console.error('Failed to load cubicles:', e);
            }
        }

        async function stopContainer(containerId) {
            if (!confirm('Stop this container?')) return;
            try {
                const res = await fetch(`/api/containers/${containerId}/stop`, { method: 'POST' });
                if (res.ok) {
                    loadCubicles();
                } else {
                    alert('Failed to stop container');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function loadMetrics() {
            try {
                const [statsRes, settingsRes] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/settings')
                ]);
                const stats = await statsRes.json();
                const settings = await settingsRes.json();

                document.getElementById('metric-containers').innerText = stats.activeContainers;
                document.getElementById('metric-agents').innerText = stats.agentsCount;
                document.getElementById('metric-spend').innerText = '$' + stats.totalSpendToday.toFixed(4);
                document.getElementById('metric-allowlist').innerText = stats.allowlistCount;

                const openaiStatus = document.getElementById('metric-openai');
                const openrouterStatus = document.getElementById('metric-openrouter');

                if (settings.openai_key_set) {
                    openaiStatus.className = 'text-xs font-mono px-2 py-1 rounded bg-green-500/20 text-green-400';
                    openaiStatus.innerText = 'Set';
                } else {
                    openaiStatus.className = 'text-xs font-mono px-2 py-1 rounded bg-red-500/20 text-red-400';
                    openaiStatus.innerText = 'Not Set';
                }

                if (settings.openrouter_key_set) {
                    openrouterStatus.className = 'text-xs font-mono px-2 py-1 rounded bg-green-500/20 text-green-400';
                    openrouterStatus.innerText = 'Set';
                } else {
                    openrouterStatus.className = 'text-xs font-mono px-2 py-1 rounded bg-red-500/20 text-red-400';
                    openrouterStatus.innerText = 'Not Set';
                }
            } catch (e) {}
        }

        async function loadAllowlist() {
            try {
                const res = await fetch('/api/allowlist');
                if(res.status === 401) return logout();
                const users = await res.json();
                const tbody = document.getElementById('allowlist-tbody');
                const empty = document.getElementById('allowlist-empty');

                if (users.length === 0) {
                    tbody.innerHTML = '';
                    empty.classList.remove('hidden');
                    return;
                }

                empty.classList.add('hidden');
                tbody.innerHTML = users.map(user => `
                    <tr class="hover:bg-white/5">
                        <td class="px-4 py-3 font-mono text-slate-400">${user.user_id}</td>
                        <td class="px-4 py-3">${user.username || '-'}</td>
                        <td class="px-4 py-3">${user.first_name || '-'}</td>
                        <td class="px-4 py-3 text-slate-400">${new Date(user.created_at).toLocaleDateString()}</td>
                        <td class="px-4 py-3">
                            <button onclick="removeFromAllowlist(${user.user_id})" class="text-red-400 hover:text-white text-xs">Remove</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load allowlist:', e);
            }
        }

        async function removeFromAllowlist(userId) {
            if (!confirm('Remove this user from allowlist?')) return;
            try {
                await fetch('/api/allowlist/' + userId, { method: 'DELETE' });
                loadAllowlist();
            } catch (e) {
                alert('Failed to remove user');
            }
        }

        function openAllowlistModal() {
            document.getElementById('allowlist-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeAllowlistModal() {
            document.getElementById('allowlist-modal').classList.add('hidden');
        }

        async function addAllowlistUser() {
            const userId = document.getElementById('allowlist-user-id').value;
            const username = document.getElementById('allowlist-username').value;
            const firstName = document.getElementById('allowlist-first-name').value;

            if (!userId) return alert('User ID is required');

            try {
                await fetch('/api/allowlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: Number(userId), username, first_name: firstName })
                });
                closeAllowlistModal();
                document.getElementById('allowlist-user-id').value = '';
                document.getElementById('allowlist-username').value = '';
                document.getElementById('allowlist-first-name').value = '';
                loadAllowlist();
            } catch (e) {
                alert('Failed to add user');
            }
        }

        async function loadAgents() {
            try {
                const res = await fetch('/api/agents');
                if(res.status === 401) return logout();
                const agents = await res.json();
                const grid = document.getElementById('agent-grid');
                grid.innerHTML = '';

                agents.forEach(agent => {
                    const percent = (agent.budget.current_spend_usd / agent.budget.daily_limit_usd) * 100;
                    const color = percent > 90 ? 'bg-red-500' : 'bg-green-500';
                    const hitlBadge = agent.require_approval ? '<span class="ml-2 text-xs bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded">HITL</span>' : '';

                    const card = `
                        <div class="glass-card rounded-2xl p-6 relative group overflow-hidden">
                            <div class="absolute top-0 right-0 p-6 opacity-50 group-hover:opacity-100 transition-opacity">
                                <div class="w-2 h-2 rounded-full ${agent.is_active ? 'bg-green-400 shadow-[0_0_10px_#4ade80]' : 'bg-red-400'}"></div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="w-12 h-12 rounded-xl bg-slate-800 border border-slate-700 flex items-center justify-center mb-3">
                                    <svg viewBox="0 0 100 100" class="w-7 h-7 fill-orange-500">
                                        <path d="M50 20C30 20 20 35 20 50C20 65 30 80 50 80C70 80 80 65 80 50C80 35 70 20 50 20ZM35 45C37.7 45 40 47.3 40 50C40 52.7 37.7 55 35 55C32.3 55 30 52.7 30 50C30 47.3 32.3 45 35 45ZM65 45C67.7 45 70 47.3 70 50C70 52.7 67.7 55 65 55C62.3 55 60 52.7 60 50C60 47.3 62.3 45 65 45Z"/>
                                        <path d="M15 30L25 40M10 50L25 50M15 70L25 60M85 30L75 40M90 50L75 50M85 70L75 60" stroke="#ff6b35" stroke-width="5" stroke-linecap="round"/>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-white">${agent.name} ${hitlBadge}</h3>
                                <p class="text-xs text-orange-400 font-mono mt-1">${agent.role}</p>
                            </div>

                            <div class="space-y-3 mb-6">
                                <div class="flex justify-between text-xs text-slate-400 font-mono">
                                    <span>IMAGE</span>
                                    <span>${agent.docker_image.split(':')[0]}</span>
                                </div>
                                <div class="flex justify-between text-xs text-slate-400 font-mono">
                                    <span>BUDGET</span>
                                    <span>$${agent.budget.current_spend_usd.toFixed(4)} / $${agent.budget.daily_limit_usd}</span>
                                </div>
                                <div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden">
                                    <div class="${color} h-full" style="width: ${percent}%"></div>
                                </div>
                            </div>

                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="testAgent(${agent.id}, '${agent.name}')" class="flex items-center justify-center gap-1 bg-green-600/20 hover:bg-green-600/30 text-green-400 py-2 rounded-lg text-xs font-medium transition-colors border border-green-600/30">
                                    <i data-lucide="play" class="w-3 h-3"></i> Test
                                </button>
                                <button onclick="openTerminal(${agent.id}, '${agent.name}')" class="flex items-center justify-center gap-1 bg-slate-800 hover:bg-slate-700 text-white py-2 rounded-lg text-xs font-medium transition-colors border border-slate-700">
                                    <i data-lucide="terminal" class="w-3 h-3"></i> Terminal
                                </button>
                                <button onclick="editAgent(${agent.id})" class="flex items-center justify-center gap-1 bg-slate-800 hover:bg-slate-700 text-white py-2 rounded-lg text-xs font-medium transition-colors border border-slate-700">
                                    <i data-lucide="settings" class="w-3 h-3"></i> Config
                                </button>
                            </div>
                        </div>
                    `;
                    grid.innerHTML += card;
                });
                lucide.createIcons();
            } catch(e) {}
        }

        async function loadAuditLogs() {
            try {
                const res = await fetch('/api/audit?limit=50');
                if(res.status === 401) return logout();
                const logs = await res.json();
                const agents = await fetch('/api/agents').then(r => r.json());
                const agentMap = {};
                agents.forEach(a => agentMap[a.id] = a.name);

                const tbody = document.getElementById('audit-tbody');
                tbody.innerHTML = '';

                logs.forEach(log => {
                    const statusColor = log.status === 'approved' ? 'text-green-400' : log.status === 'denied' ? 'text-red-400' : 'text-yellow-400';
                    const row = `
                        <tr class="hover:bg-white/5">
                            <td class="px-4 py-3 font-mono text-slate-400">${new Date(log.created_at).toLocaleString()}</td>
                            <td class="px-4 py-3">${agentMap[log.agent_id] || 'Unknown'}</td>
                            <td class="px-4 py-3 font-mono text-xs truncate max-w-xs" title="${log.command}">${log.command}</td>
                            <td class="px-4 py-3 ${statusColor} font-mono">${log.status.toUpperCase()}</td>
                            <td class="px-4 py-3">
                                <button onclick="viewContainer('${log.container_id}')" class="text-orange-500 hover:text-white text-xs">View Terminal</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch(e) {
                console.error('Failed to load audit logs:', e);
            }
        }

        async function createAgent() {
            const name = document.getElementById('new-name').value;
            const role = document.getElementById('new-role').value;
            const token = document.getElementById('new-token').value;
            const image = document.getElementById('new-image').value;
            const requireApproval = document.getElementById('new-require-approval').checked ? 1 : 0;

            if(!name || !token) return alert('Name and Token required');

            await fetch('/api/agents', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, role, telegram_token: token, docker_image: image, require_approval: requireApproval })
            });

            closeModal();
            loadAgents();
        }

        async function editAgent(id) {
            const agents = await fetch('/api/agents').then(r => r.json());
            const agent = agents.find(a => a.id === id);
            if (!agent) return;

            document.getElementById('new-name').value = agent.name;
            document.getElementById('new-role').value = agent.role;
            document.getElementById('new-token').value = agent.telegram_token;
            document.getElementById('new-image').value = agent.docker_image;
            document.getElementById('new-require-approval').checked = agent.require_approval === 1;

            document.getElementById('create-modal').classList.remove('hidden');
        }

        async function testAgent(id, name) {
            const message = prompt(`Send a test message to ${name}:`, 'Hello! Tell me about your environment.');
            if (!message) return;

            try {
                const res = await fetch(`/api/test-agent/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await res.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Response:\n\n' + data.output);
                }
            } catch (e) {
                alert('Failed to test agent: ' + e.message);
            }
        }

        function openModal() {
            document.getElementById('new-name').value = '';
            document.getElementById('new-role').value = '';
            document.getElementById('new-token').value = '';
            document.getElementById('new-require-approval').checked = false;
            document.getElementById('create-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('create-modal').classList.add('hidden');
        }

        async function openTerminal(id, name) {
            currentAgentId = id;
            document.getElementById('term-title').innerText = `ssh ${name.toLowerCase()}@hermitclaw`;
            document.getElementById('terminal-modal').classList.remove('hidden');

            if (!term) {
                term = new Terminal({
                    cursorBlink: true,
                    fontSize: 14,
                    fontFamily: 'JetBrains Mono, monospace',
                    theme: {
                        background: '#0c0a09',
                        foreground: '#f8fafc',
                        cursor: '#ff6b35'
                    }
                });
                fitAddon = new FitAddon.FitAddon();
                term.loadAddon(fitAddon);
                term.open(document.getElementById('xterm-container'));
                fitAddon.fit();

                term.writeln('\x1b[38;5;208mHERMITCLAW v1.0.0 - Secure Shell Connection Established.\x1b[0m');
                term.writeln('\x1b[90mClick "Link" button to attach to a running container\x1b[0m');
            }
        }

        async function attachTerminal() {
            const containers = await fetch('/api/containers').then(r => r.json());
            if (!containers || containers.length === 0) {
                term.writeln('\x1b[31mNo running containers found\x1b[0m');
                return;
            }

            const runningContainer = containers[0];
            currentContainerId = runningContainer.Id;

            term.writeln(`\x1b[32mConnecting to ${runningContainer.Names[0]}...\x1b[0m`);

            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/api/terminal/${currentContainerId}`);

            ws.onopen = () => {
                term.writeln('\x1b[32mConnected!\x1b[0m');
            };

            ws.onmessage = (event) => {
                const data = atob(event.data);
                term.write(data);
            };

            ws.onclose = () => {
                term.writeln('\x1b[33mDisconnected\x1b[0m');
            };

            ws.onerror = (err) => {
                term.writeln('\x1b[31mConnection error\x1b[0m');
                console.error(err);
            };

            term.onData((data) => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(btoa(data));
                }
            });
        }

        async function viewContainer(containerId) {
            if (!term) {
                term = new Terminal({
                    cursorBlink: true,
                    fontSize: 14,
                    fontFamily: 'JetBrains Mono, monospace',
                    theme: {
                        background: '#0c0a09',
                        foreground: '#f8fafc',
                        cursor: '#ff6b35'
                    }
                });
                fitAddon = new FitAddon.FitAddon();
                term.loadAddon(fitAddon);
                term.open(document.getElementById('xterm-container'));
                fitAddon.fit();
            }

            document.getElementById('terminal-modal').classList.remove('hidden');
            term.writeln(`\x1b[32mAttaching to container ${containerId.substring(0, 12)}...\x1b[0m`);

            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/api/terminal/${containerId}`);

            ws.onopen = () => {
                term.writeln('\x1b[32mConnected!\x1b[0m');
            };

            ws.onmessage = (event) => {
                const data = atob(event.data);
                term.write(data);
            };

            ws.onclose = () => {
                term.writeln('\x1b[33mDisconnected\x1b[0m');
            };

            term.onData((data) => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(btoa(data));
                }
            });
        }

        function closeTerminal() {
            if (ws) {
                ws.close();
                ws = null;
            }
            document.getElementById('terminal-modal').classList.add('hidden');
        }

        window.addEventListener('resize', () => {
            if (fitAddon) fitAddon.fit();
        });

        // Interactive Mascot
        const authMascot = document.getElementById('auth-mascot');
        const leftClawAuth = document.getElementById('left-claw-auth');
        const rightClawAuth = document.getElementById('right-claw-auth');
        const crabBodyAuth = document.getElementById('crab-body-auth');

        if (authMascot) {
            authMascot.addEventListener('mousedown', () => {
                if (leftClawAuth) leftClawAuth.style.transform = 'rotate(-30deg) scale(1.2)';
                if (rightClawAuth) rightClawAuth.style.transform = 'rotate(30deg) scale(1.2)';
            });

            authMascot.addEventListener('mouseup', () => {
                if (leftClawAuth) leftClawAuth.style.transform = 'rotate(0deg) scale(1)';
                if (rightClawAuth) rightClawAuth.style.transform = 'rotate(0deg) scale(1)';
            });

            authMascot.addEventListener('mouseleave', () => {
                if (leftClawAuth) leftClawAuth.style.transform = 'rotate(0deg) scale(1)';
                if (rightClawAuth) rightClawAuth.style.transform = 'rotate(0deg) scale(1)';
            });
        }

        init();
    </script>
</body>
</html>
